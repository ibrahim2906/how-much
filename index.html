<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>How Much - Life OS</title>

    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%236366f1'/%3E%3Cstop offset='100%25' stop-color='%23a855f7'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='50' cy='50' r='45' fill='url(%23grad)'/%3E%3Cpath d='M30 30 L30 70 M70 30 L70 70 M30 50 L70 50' stroke='white' stroke-width='8' stroke-linecap='round'/%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@400;600;700&family=Cairo:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            --accent-color: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.5);
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        /* تعريف الخط المركب */
        @font-face {
            font-family: 'GlobalFont';
            src: local('Plus Jakarta Sans');
            unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
        }

        @font-face {
            font-family: 'GlobalFont';
            src: local('Cairo');
            unicode-range: U+0600-06FF, U+0750-077F, U+08A0-08FF, U+FB50-FDFF, U+FE70-FEFF;
        }

        body {
            /* الترتيب هنا يضمن استخدام Cairo للحروف العربية حتى لو كانت لغة الموقع إنجليزية */
            font-family: 'Plus Jakarta Sans', 'Cairo', sans-serif;
            overflow: hidden;
            background-color: #0f172a;
            color: #f8fafc;
            overscroll-behavior-y: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body.rtl {
            font-family: 'Cairo', sans-serif;
            direction: rtl;
        }

        button,
        a,
        .interactive {
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }

        button:active,
        .interactive:active {
            transform: scale(0.96);
            transition: transform 0.1s var(--transition-smooth);
        }

        .page-section {
            will-change: transform, opacity;
            transform-origin: center bottom;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .stagger-entry {
            opacity: 0;
            animation: slideInUp 0.5s var(--transition-smooth) forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .glass-card {
            transition: transform 0.2s var(--transition-smooth),
                box-shadow 0.3s var(--transition-smooth),
                background 0.2s ease;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .glass-card::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            padding: 2px;
            background: radial-gradient(800px circle at var(--mouse-x, 50%) var(--mouse-y, 50%),
                    rgba(255, 255, 255, 0.4),
                    transparent 40%);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 5;
        }

        .glass-card:hover::before {
            opacity: 1;
        }

        @keyframes blackHoleSuck {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
                filter: blur(0px);
            }

            50% {
                transform: scale(0.5) rotate(180deg);
                opacity: 0.5;
                filter: blur(2px);
            }

            100% {
                transform: scale(0) rotate(720deg);
                opacity: 0;
                filter: blur(10px);
            }
        }

        .implode {
            animation: blackHoleSuck 0.5s cubic-bezier(0.55, -0.04, 0.91, 0.94) forwards !important;
            pointer-events: none;
        }

        .interactive-btn {
            position: relative;
            overflow: hidden;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }

        .btn-text-content {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            transition: all 0.4s var(--transition-smooth);
        }

        .interactive-btn.loading .btn-text-content,
        .interactive-btn.success .btn-text-content {
            opacity: 0;
            transform: translateY(10px);
        }

        .btn-loader {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .interactive-btn.loading .btn-loader {
            opacity: 1;
        }

        .dot-wave {
            width: 6px;
            height: 6px;
            background-color: white;
            border-radius: 50%;
            animation: waveAnim 1s infinite ease-in-out both;
        }

        .dot-wave:nth-child(1) {
            animation-delay: -0.32s;
        }

        .dot-wave:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes waveAnim {

            0%,
            80%,
            100% {
                transform: scale(0);
                opacity: 0.5;
            }

            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .btn-success-icon {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.5) rotate(-45deg);
            transition: all 0.5s var(--transition-bounce);
        }

        .interactive-btn.success .btn-success-icon {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        .nebula-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #0f172a);
            z-index: -2;
            transition: opacity 0.8s ease-in-out;
        }

        /* AZKAR SPECIFIC BACKGROUND 
           This sits above the nebula but behind content 
        */
        #azkar-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            /* Above nebula (-2), below content */
            opacity: 0;
            transition: opacity 0.8s ease-in-out;
            pointer-events: none;
            /* Deep Islamic Green Gradient */
            background: radial-gradient(circle at 50% 30%, #059669 0%, #065f46 30%, #064e3b 60%, #022c22 100%);
        }

        #azkar-pattern {
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23d4af37' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.6;
            mix-blend-mode: overlay;
        }

        .nebula-orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.4;
            transition: background-color 0.5s ease, opacity 0.8s ease-in-out;
            animation: floatOrb 10s infinite alternate;
            pointer-events: none;
        }

        @keyframes floatOrb {
            from {
                transform: translate(0, 0);
            }

            to {
                transform: translate(30px, -30px);
            }
        }

        .accent-text {
            color: var(--accent-color);
        }

        .accent-bg {
            background-color: var(--accent-color);
        }

        .accent-border {
            border-color: var(--accent-color);
        }

        .accent-glow {
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            position: relative;
        }

        .drag-handle {
            cursor: grab;
            opacity: 0.5;
            transition: opacity 0.2s;
            touch-action: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .glass-card:hover .drag-handle {
            opacity: 1;
        }

        .sortable-ghost {
            opacity: 0.4;
            background: var(--accent-color);
        }

        .delete-btn-preview {
            opacity: 1;
            transition: opacity 0.2s;
        }

        @media (min-width: 768px) {
            .delete-btn-preview {
                opacity: 0;
            }

            .glass-card:hover .delete-btn-preview {
                opacity: 1;
            }

            .drag-handle {
                opacity: 0;
            }
        }

        #desktop-sidebar {
            transition: width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s;
        }

        .sidebar-collapsed {
            width: 80px !important;
        }

        .sidebar-collapsed .nav-text,
        .sidebar-collapsed .logo-text,
        .sidebar-collapsed #user-status-badge {
            display: none;
        }

        .sidebar-collapsed .nav-link,
        .sidebar-collapsed .mt-auto button {
            justify-content: center;
            padding-left: 0;
            padding-right: 0;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        body.light-mode ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
        }

        .nav-link {
            position: relative;
            transition: all 0.3s ease;
            opacity: 0.6;
        }

        .nav-link:hover {
            opacity: 1;
        }

        .nav-link.active {
            opacity: 1;
            color: var(--accent-color);
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: var(--accent-color);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--accent-color);
        }

        .mobile-dock {
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .modal-content {
            will-change: transform, opacity;
            transform-origin: center center;
        }

        .floating-ai-btn {
            position: fixed;
            bottom: 90px;
            right: 20px;
            left: auto;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-color), #ec4899);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 10px 30px var(--accent-glow);
            z-index: 40;
            transition: all 0.3s var(--transition-bounce);
            animation: pulse-glow 3s infinite;
        }

        body.rtl .floating-ai-btn {
            right: auto;
            left: 20px;
        }

        .floating-ai-btn:hover {
            transform: scale(1.1) rotate(15deg);
        }

        @media (min-width: 768px) {
            .floating-ai-btn {
                bottom: 30px;
                right: 30px;
            }

            body.rtl .floating-ai-btn {
                right: auto;
                left: 30px;
            }
        }

        @keyframes pulse-glow {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(99, 102, 241, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }

        .widget-pill {
            position: fixed;
            z-index: 39;
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.3s var(--transition-bounce);
            animation: slideInWidget 0.8s var(--transition-bounce) forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        .widget-pill:hover {
            transform: translateY(-2px) scale(1.02);
            border-color: var(--accent-glow);
            box-shadow: 0 4px 20px var(--accent-glow);
        }

        @keyframes slideInWidget {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 767px) {
            .widget-pill {
                bottom: 90px;
                right: 85px;
                height: 48px;
                padding: 0 16px;
                border-radius: 24px;
            }
        }

        @media (min-width: 768px) {
            .widget-pill {
                bottom: 30px;
                right: 100px;
                height: 60px;
                padding: 0 24px;
                border-radius: 30px;
            }
        }

        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .loader-ring {
            display: inline-block;
            width: 20px;
            height: 20px;
        }

        .loader-ring:after {
            content: " ";
            display: block;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid #fff;
            border-color: #fff transparent #fff transparent;
            animation: ring 1.2s linear infinite;
        }

        @keyframes ring {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .file-drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
        }

        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: var(--accent-color);
            background: rgba(255, 255, 255, 0.05);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .level-card {
            background: rgba(30, 30, 36, 0.95);
            backdrop-filter: blur(15px);
            padding: 30px;
            border-radius: 24px;
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            position: relative;
            animation: slideUpModal 0.4s var(--transition-bounce);
        }

        @keyframes slideUpModal {
            from {
                transform: translateY(50px) scale(0.9);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .level-info-center {
            text-align: center;
            margin: 20px 0;
        }

        .current-level-icon {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700, #ffa500);
            padding: 12px 25px;
            border-radius: 50px;
            color: #000;
            font-weight: 800;
            font-size: 1.5rem;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            margin-bottom: 15px;
            transform: scale(1);
            transition: transform 0.3s;
        }

        .current-level-icon:hover {
            transform: scale(1.1);
        }

        .xp-text {
            color: #94a3b8;
            font-size: 0.9rem;
            margin-top: 5px;
            letter-spacing: 1px;
            font-family: monospace;
        }

        .progress-container {
            margin-bottom: 25px;
        }

        .progress-bar-bg {
            background: rgba(255, 255, 255, 0.1);
            height: 14px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #a855f7);
            border-radius: 10px;
            transition: width 1s var(--transition-smooth);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.5);
            width: 0%;
        }

        .progress-labels {
            display: flex;
            justify-content: space-between;
            color: #64748b;
            font-size: 0.75rem;
            margin-top: 8px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .xp-history h4 {
            color: #fff;
            margin-bottom: 15px;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
        }

        .xp-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        .xp-item:hover {
            background: rgba(255, 255, 255, 0.07);
        }

        .xp-icon {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }

        .xp-details {
            flex: 1;
        }

        .xp-details span {
            display: block;
            color: #e2e8f0;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .xp-details small {
            color: #64748b;
            font-size: 0.75rem;
        }

        .xp-amount {
            color: #4ade80;
            font-weight: bold;
            font-size: 0.9rem;
            font-family: monospace;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
        }

        @keyframes crashDown {
            0% {
                transform: translate(0, 0) rotate(0deg);
                filter: brightness(1);
            }

            15% {
                transform: translate(-5px, 0) rotate(-5deg);
            }

            30% {
                transform: translate(5px, 0) rotate(5deg);
            }

            45% {
                transform: translate(-5px, 0) rotate(-5deg);
            }

            60% {
                transform: translate(0, 10px) rotate(10deg) scale(0.9);
                opacity: 1;
                filter: brightness(0.5) grayscale(1);
            }

            100% {
                transform: translate(0, 150px) rotate(45deg) scale(0.5);
                opacity: 0;
            }
        }

        .crash-out {
            animation: crashDown 0.6s cubic-bezier(0.55, 0.085, 0.68, 0.53) forwards !important;
            pointer-events: none;
            z-index: 0;
        }

        #shard-cursor {
            position: fixed;
            top: 0;
            left: 0;
            width: 24px;
            height: 24px;
            opacity: 0;
            pointer-events: none;
            z-index: 10002;
            transform: translate3d(-100px, -100px, 0);
            will-change: transform;
            filter: drop-shadow(0 0 5px rgba(255, 140, 0, 0.5));
            transition: opacity 0.2s ease, filter 0.2s ease;
        }

        #shard-cursor svg {
            width: 100%;
            height: 100%;
            transition: transform 0.15s var(--transition-bounce);
        }

        body.shard-hover #shard-cursor {
            filter: drop-shadow(0 0 15px rgba(255, 140, 0, 1));
        }

        body.shard-hover #shard-cursor svg {
            transform: scale(1.3) rotate(-15deg);
        }

        body.shard-click #shard-cursor svg {
            transform: scale(0.8) translate(2px, 2px);
        }

        @media (pointer: fine) {

            body,
            a,
            button,
            input,
            textarea,
            select,
            label,
            .glass-card,
            .nav-link,
            * {
                cursor: none !important;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            #shard-cursor {
                display: none !important;
            }

            body,
            a,
            button,
            * {
                cursor: auto !important;
            }
        }

        #page-azkar {
            --azkar-gold: #D4AF37;
            --azkar-deep-green: #064E3B;
            --azkar-light-green: #10B981;
            --azkar-text-cream: #FEF3C7;
            --azkar-glow: rgba(212, 175, 55, 0.3);
        }

        #page-azkar .uthmani-font {
            font-family: 'Amiri', serif;
            line-height: 2.2;
            font-size: 1.4rem;
            color: var(--azkar-text-cream);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        #page-azkar .azkar-theme-btn {
            background: rgba(6, 78, 59, 0.4);
            border: 1px solid var(--azkar-gold);
            color: var(--azkar-gold);
            font-family: 'Amiri', serif;
            font-weight: bold;
            font-size: 1.1rem;
            transition: all 0.3s var(--transition-smooth);
        }

        #page-azkar .azkar-theme-btn.active {
            background: linear-gradient(135deg, var(--azkar-gold), #B45309);
            color: #0f172a;
            box-shadow: 0 0 20px var(--azkar-glow);
            border-color: transparent;
        }

        #page-azkar .zikr-card {
            background: rgba(255, 255, 255, 0.05);
            /* Slight glass for blend */
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-right: 4px solid var(--azkar-gold);
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s var(--transition-smooth);
        }

        #page-azkar .zikr-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border-color: var(--azkar-gold);
            background: rgba(255, 255, 255, 0.1);
        }

        #page-azkar .zikr-card:active {
            transform: scale(0.98);
        }

        #page-azkar .zikr-card.completed {
            background: rgba(0, 0, 0, 0.4);
            border-color: #333;
            border-right-color: var(--azkar-light-green);
            opacity: 0.7;
        }

        #page-azkar .zikr-card.completed .uthmani-font {
            color: #94a3b8;
            text-shadow: none;
        }

        #page-azkar .zikr-counter-ring {
            transition: stroke-dashoffset 0.3s ease, stroke 0.3s ease;
        }

        .line-clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        @media (max-width: 640px) {
            .text-2xl {
                font-size: 1.5rem;
            }

            .text-3xl {
                font-size: 1.875rem;
            }
        }

        /* === إصلاح مكان الويدجت في الوضع العربي === */

        /* للموبايل: نقل الويدجت لليسار */
        @media (max-width: 767px) {
            body.rtl .widget-pill {
                right: auto !important;
                left: 85px !important;
                /* المسافة من اليسار لتناسب الزر */
            }
        }

        /* للكمبيوتر: نقل الويدجت لليسار */
        @media (min-width: 768px) {
            body.rtl .widget-pill {
                right: auto !important;
                left: 100px !important;
            }
        }
        /* تصميم الإشعارات الجديد */
.custom-toast {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(-20px);
    background: rgba(30, 41, 59, 0.95); /* لون داكن عصري */
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
    padding: 12px 24px;
    border-radius: 16px;
    z-index: 10000; /* للتأكد من ظهوره فوق كل شيء */
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    pointer-events: none;
}

.custom-toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}

.custom-toast.error { 
    border-left: 4px solid #ef4444; 
}

.custom-toast.success { 
    border-left: 4px solid #22c55e; 
}
    </style>
</head>

<body>

    <canvas id="confetti-canvas" aria-hidden="true"></canvas>

    <!-- Global Cursor -->
    <div id="shard-cursor" aria-hidden="true">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 3L10.5 21L12.5 13L20.5 11L3 3Z" fill="#FF8C00" stroke="white" stroke-width="1.5"
                stroke-linejoin="round" />
        </svg>
    </div>

    <!-- Default Nebula Background (Fades out when in Azkar) -->
    <div class="nebula-bg" aria-hidden="true"></div>
    <div class="nebula-orb accent-bg top-20 left-20 w-64 h-64" style="background: var(--accent-color)"
        aria-hidden="true"></div>
    <div class="nebula-orb accent-bg bottom-20 right-20 w-80 h-80"
        style="background: var(--accent-color); filter: blur(100px) hue-rotate(30deg);" aria-hidden="true"></div>

    <!-- 
        AZKAR EXCLUSIVE BACKGROUND 
        This is hidden by default (opacity-0) and only appears when #page-azkar is active.
    -->
    <div id="azkar-bg" aria-hidden="true">
        <div id="azkar-pattern"></div>
    </div>

    <div id="splash-screen"
        class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-[#0f172a] text-white overflow-hidden">
        <div class="relative w-32 h-32 mb-6">
            <svg id="final-svg" viewBox="0 0 100 100"
                class="w-full h-full absolute inset-0 z-20 opacity-0 drop-shadow-2xl" role="img"
                aria-label="How Much Logo">
                <defs>
                    <linearGradient id="splashGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" class="stop-color-1" stop-color="#6366f1" />
                        <stop offset="100%" class="stop-color-2" stop-color="#a855f7" />
                    </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="45" fill="url(#splashGrad)" />
                <path d="M30 30 L30 70 M70 30 L70 70 M30 50 L70 50" stroke="white" stroke-width="8"
                    stroke-linecap="round" stroke-linejoin="round" />
            </svg>

            <svg id="sketch-svg" viewBox="0 0 100 100" class="w-full h-full absolute inset-0 z-10" aria-hidden="true">
                <circle class="sketch-path" cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.8)"
                    stroke-width="1.5" stroke-linecap="round" />
                <path class="sketch-path" d="M30 30 L30 70 M70 30 L70 70 M30 50 L70 50" fill="none"
                    stroke="rgba(255,255,255,0.8)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
        </div>

        <div class="text-center overflow-hidden">
            <h1 id="splash-title"
                class="text-5xl font-bold tracking-tight text-white font-sans translate-y-10 opacity-0">
                How Much
            </h1>
            <p id="splash-subtitle"
                class="text-slate-400 mt-3 font-light tracking-[0.3em] text-sm uppercase translate-y-10 opacity-0">
                Life Operating System
            </p>
        </div>
    </div>

    <div id="login-screen"
        class="hidden fixed inset-0 z-50 flex flex-col items-center justify-center p-6 bg-black/40 backdrop-blur-sm">
        <div class="glass-panel w-full max-w-md p-8 rounded-3xl text-center border-t border-white/10">
            <div class="w-20 h-20 accent-bg rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-indigo-500/30 transform rotate-3"
                style="background: var(--accent-color)">
                <i class="fas fa-chart-pie text-3xl text-white" aria-hidden="true"></i>
            </div>
            <h2 class="text-3xl font-bold mb-2 text-white" data-i18n="welcome">Welcome Back</h2>
            <p class="text-slate-400 mb-8 text-sm" data-i18n="loginSubtitle">Sync your life progress across dimensions.
            </p>

            <button onclick="handleGoogleLogin()"
                class="w-full bg-white text-slate-900 font-bold py-3.5 px-4 rounded-xl flex items-center justify-center gap-3 hover:bg-slate-100 transition-all active:scale-95 mb-4 group"
                aria-label="Continue with Google">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"
                    class="w-5 h-5 group-hover:rotate-12 transition-transform" alt="Google logo">
                <span data-i18n="continueGoogle">Continue with Google</span>
            </button>

            <button onclick="enterAsGuest()" class="text-sm accent-text hover:text-white transition-colors"
                data-i18n="continueGuest">
                Continue Offline (Guest)
            </button>
        </div>
    </div>

    <div id="app-container" class="hidden flex h-[100dvh] overflow-hidden relative">

        <aside id="desktop-sidebar"
            class="hidden md:flex w-72 flex-col glass-panel m-4 rounded-3xl border-e-0 relative z-20 overflow-hidden shrink-0"
            role="navigation" aria-label="Main navigation">
            <div class="p-6 flex items-center gap-4 border-b border-white/5">
                <svg viewBox="0 0 100 100"
                    class="w-10 h-10 rounded-xl shadow-lg flex-shrink-0 cursor-pointer hover:scale-110 transition-transform"
                    onclick="toggleSidebar()" role="button" aria-label="Toggle sidebar">
                    <defs>
                        <linearGradient id="sidebarGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#6366f1" />
                            <stop offset="100%" stop-color="#ec4899" />
                        </linearGradient>
                    </defs>
                    <rect width="100" height="100" rx="20" fill="url(#sidebarGrad)" />
                    <path d="M25 25 L25 75 M75 25 L75 75 M25 50 L75 50" stroke="white" stroke-width="12"
                        stroke-linecap="round" />
                </svg>
                <div class="logo-text overflow-hidden whitespace-nowrap transition-opacity duration-300">
                    <h1 class="text-xl font-bold tracking-tight">How Much</h1>
                    <div id="user-status-badge" onclick="openLevelModal()"
                        class="text-[10px] bg-green-500/20 text-green-400 px-2 py-0.5 rounded-full inline-block cursor-pointer hover:scale-105 transition-transform"
                        role="button" aria-label="User level status">Online</div>
                </div>
            </div>

            <nav class="flex-1 px-3 space-y-2 mt-4 overflow-y-auto overflow-x-hidden">
                <button onclick="showPage('courses')"
                    class="nav-link w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-white/5 text-start group"
                    aria-label="Courses page">
                    <div
                        class="w-10 h-10 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-400 group-hover:bg-blue-500 group-hover:text-white transition-all flex-shrink-0">
                        <i class="fas fa-graduation-cap text-lg" aria-hidden="true"></i>
                    </div>
                    <span class="font-medium nav-text whitespace-nowrap" data-i18n="courses">Courses</span>
                </button>

                <button onclick="showPage('tasks')"
                    class="nav-link w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-white/5 text-start group"
                    aria-label="Tasks page">
                    <div
                        class="w-10 h-10 rounded-xl bg-purple-500/10 flex items-center justify-center text-purple-400 group-hover:bg-purple-500 group-hover:text-white transition-all flex-shrink-0">
                        <i class="fas fa-check-circle text-lg" aria-hidden="true"></i>
                    </div>
                    <span class="font-medium nav-text whitespace-nowrap" data-i18n="tasks">Tasks</span>
                </button>

                <button onclick="showPage('books')"
                    class="nav-link w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-white/5 text-start group"
                    aria-label="Books page">
                    <div
                        class="w-10 h-10 rounded-xl bg-emerald-500/10 flex items-center justify-center text-emerald-400 group-hover:bg-emerald-500 group-hover:text-white transition-all flex-shrink-0">
                        <i class="fas fa-book-open text-lg" aria-hidden="true"></i>
                    </div>
                    <span class="font-medium nav-text whitespace-nowrap" data-i18n="books">Books</span>
                </button>

                <button onclick="showPage('notes')"
                    class="nav-link w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-white/5 text-start group"
                    aria-label="Notes page">
                    <div
                        class="w-10 h-10 rounded-xl bg-yellow-500/10 flex items-center justify-center text-yellow-400 group-hover:bg-yellow-500 group-hover:text-white transition-all flex-shrink-0">
                        <i class="fas fa-sticky-note text-lg" aria-hidden="true"></i>
                    </div>
                    <span class="font-medium nav-text whitespace-nowrap" data-i18n="notes">Notes</span>
                </button>

                <button onclick="showPage('azkar')"
                    class="nav-link w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-white/5 text-start group"
                    aria-label="Azkar page">
                    <div
                        class="w-10 h-10 rounded-xl bg-teal-500/10 flex items-center justify-center text-teal-400 group-hover:bg-teal-500 group-hover:text-white transition-all flex-shrink-0">
                        <i class="fas fa-mosque text-lg" aria-hidden="true"></i>
                    </div>
                    <span class="font-medium nav-text whitespace-nowrap">الأذكار</span>
                </button>

                <button onclick="showPage('counters')"
                    class="nav-link w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-white/5 text-start group"
                    aria-label="Timers page">
                    <div
                        class="w-10 h-10 rounded-xl bg-orange-500/10 flex items-center justify-center text-orange-400 group-hover:bg-orange-500 group-hover:text-white transition-all flex-shrink-0">
                        <i class="fas fa-stopwatch text-lg" aria-hidden="true"></i>
                    </div>
                    <span class="font-medium nav-text whitespace-nowrap" data-i18n="timers">Timers</span>
                </button>

                <button onclick="showPage('trash')"
                    class="nav-link w-full flex items-center gap-4 p-4 rounded-2xl hover:bg-white/5 text-start group"
                    aria-label="Trash page">
                    <div
                        class="w-10 h-10 rounded-xl bg-red-500/10 flex items-center justify-center text-red-400 group-hover:bg-red-500 group-hover:text-white transition-all flex-shrink-0">
                        <i class="fas fa-trash-alt text-lg" aria-hidden="true"></i>
                    </div>
                    <span class="font-medium nav-text whitespace-nowrap" data-i18n="trash">Trash Bin</span>
                </button>
            </nav>

            <div class="p-4 mt-auto">
                <button onclick="showPage('settings')"
                    class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 transition-colors text-slate-400 hover:text-white group"
                    aria-label="Settings page">
                    <img id="user-avatar-small" src=""
                        class="w-8 h-8 min-w-[2rem] object-cover rounded-full bg-slate-700 hidden flex-shrink-0"
                        alt="User avatar">
                    <div class="w-8 h-8 rounded-full bg-slate-700/50 flex items-center justify-center flex-shrink-0"
                        id="settings-icon-container">
                        <i class="fas fa-cog text-lg group-hover:rotate-90 transition-transform duration-500"
                            aria-hidden="true"></i>
                    </div>
                    <span class="nav-text whitespace-nowrap" data-i18n="settings">Settings</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative h-full overflow-hidden w-full" role="main">

            <header
                class="md:hidden flex items-center justify-between p-3 mx-2 mt-2 rounded-2xl glass-panel z-30 shrink-0">
                <div class="flex items-center gap-3">
                    <svg viewBox="0 0 100 100" class="w-8 h-8 rounded-lg shadow-sm" role="img"
                        aria-label="How Much Logo">
                        <rect width="100" height="100" rx="20" fill="url(#sidebarGrad)" />
                        <path d="M25 25 L25 75 M75 25 L75 75 M25 50 L75 50" stroke="white" stroke-width="12"
                            stroke-linecap="round" />
                    </svg>
                    <span class="font-bold text-lg">How Much</span>
                </div>
                <button onclick="showPage('settings')"
                    class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center"
                    aria-label="Open settings">
                    <i class="fas fa-cog text-sm" aria-hidden="true"></i>
                </button>
            </header>

            <button onclick="toggleSidebar()"
                class="hidden md:flex absolute top-6 start-6 z-30 text-slate-400 hover:text-white transition-colors bg-black/20 p-2 rounded-lg backdrop-blur-md border border-white/5"
                aria-label="Toggle sidebar">
                <i class="fas fa-bars" aria-hidden="true"></i>
            </button>

            <div id="content-area"
                class="flex-1 overflow-y-auto overflow-x-hidden p-4 md:p-8 pb-32 md:pb-8 scroll-smooth w-full">

                <section id="page-courses" class="page-section hidden max-w-5xl mx-auto pt-2 md:pt-0">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold mb-1 accent-text"
                                style="color: var(--accent-color)" data-i18n="courses">Courses</h2>
                            <p class="text-slate-400 text-xs md:text-sm" data-i18n="trackLearning">Master your skills.
                            </p>
                        </div>
                        <button onclick="openAddModal('course', event)"
                            class="add-trigger-btn accent-bg hover:opacity-90 text-white px-4 py-2 md:px-5 md:py-2.5 rounded-xl accent-glow flex items-center gap-2 transition-all active:scale-95 group text-sm md:text-base"
                            style="background-color: var(--accent-color)" aria-label="Add new course">
                            <i class="fas fa-plus group-hover:rotate-90 transition-transform" aria-hidden="true"></i>
                            <span data-i18n="add">Add Course</span>
                        </button>
                    </div>
                    <div id="courses-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" role="list">
                    </div>
                </section>

                <section id="page-tasks" class="page-section hidden max-w-4xl mx-auto pt-2 md:pt-0">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold mb-1 accent-text"
                                style="color: var(--accent-color)" data-i18n="tasks">Tasks</h2>
                            <p class="text-slate-400 text-xs md:text-sm" data-i18n="manageTasks">Organize your chaos.
                            </p>
                        </div>
                        <button onclick="openAddModal('task', event)"
                            class="add-trigger-btn accent-bg hover:opacity-90 text-white px-4 py-2 md:px-5 md:py-2.5 rounded-xl accent-glow flex items-center gap-2 transition-all active:scale-95 group text-sm md:text-base"
                            style="background-color: var(--accent-color)" aria-label="Add new task">
                            <i class="fas fa-plus group-hover:rotate-90 transition-transform" aria-hidden="true"></i>
                            <span data-i18n="add">Add Task</span>
                        </button>
                    </div>
                    <div
                        class="mb-2 flex items-center gap-2 text-slate-400 uppercase tracking-widest text-xs font-bold pl-2">
                        <i class="fas fa-star text-yellow-500" aria-hidden="true"></i> Priority
                    </div>
                    <div id="tasks-list-main" class="space-y-3 min-h-[50px]" role="list"></div>

                    <div
                        class="mt-8 mb-2 flex items-center gap-2 text-slate-400 uppercase tracking-widest text-xs font-bold pl-2">
                        <i class="fas fa-coffee text-blue-400" aria-hidden="true"></i> Side Quests (Optional)
                    </div>
                    <div id="tasks-list-optional" class="space-y-3 min-h-[50px] border-t border-white/5 pt-4"
                        role="list"></div>
                </section>

                <section id="page-books" class="page-section hidden max-w-5xl mx-auto pt-2 md:pt-0">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold mb-1 accent-text"
                                style="color: var(--accent-color)" data-i18n="books">Books</h2>
                            <p class="text-slate-400 text-xs md:text-sm" data-i18n="trackReading">Build your knowledge
                                base.</p>
                        </div>
                        <button onclick="openAddModal('book', event)"
                            class="add-trigger-btn accent-bg hover:opacity-90 text-white px-4 py-2 md:px-5 md:py-2.5 rounded-xl accent-glow flex items-center gap-2 transition-all active:scale-95 group text-sm md:text-base"
                            style="background-color: var(--accent-color)" aria-label="Add new book">
                            <i class="fas fa-plus group-hover:rotate-90 transition-transform" aria-hidden="true"></i>
                            <span data-i18n="add">Add Book</span>
                        </button>
                    </div>
                    <div id="books-list" class="grid grid-cols-1 lg:grid-cols-2 gap-6" role="list"></div>
                </section>

                <section id="page-notes" class="page-section hidden max-w-5xl mx-auto pt-2 md:pt-0">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold mb-1 accent-text"
                                style="color: var(--accent-color)" data-i18n="notes">Notes</h2>
                            <p class="text-slate-400 text-xs md:text-sm">Capture ideas, voice, and sketches.</p>
                        </div>
                        <button onclick="openAddModal('note', event)"
                            class="add-trigger-btn accent-bg hover:opacity-90 text-white px-4 py-2 md:px-5 md:py-2.5 rounded-xl accent-glow flex items-center gap-2 transition-all active:scale-95 group text-sm md:text-base"
                            style="background-color: var(--accent-color)" aria-label="Add new note">
                            <i class="fas fa-plus group-hover:rotate-90 transition-transform" aria-hidden="true"></i>
                            <span data-i18n="addNote">Add Note</span>
                        </button>
                    </div>
                    <div id="notes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" role="list"></div>
                </section>

                <section id="page-trash" class="page-section hidden max-w-4xl mx-auto pt-2 md:pt-0">
                    <div class="flex justify-between items-end mb-8">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold mb-1 text-red-400" data-i18n="trash">Trash Bin
                            </h2>
                            <p class="text-slate-400 text-xs md:text-sm">Recover items or delete them permanently.</p>
                        </div>
                        <button onclick="emptyTrash()"
                            class="bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white px-4 py-2 rounded-xl transition-all"
                            aria-label="Empty trash">
                            <i class="fas fa-dumpster-fire mr-2" aria-hidden="true"></i> Empty Trash
                        </button>
                    </div>
                    <div id="trash-list" class="space-y-3" role="list"></div>
                </section>

                <section id="page-counters"
                    class="page-section hidden max-w-3xl mx-auto min-h-full flex flex-col items-center py-6 md:py-10">

                    <div class="glass-panel p-1.5 rounded-2xl flex gap-2 mb-8 relative z-10">
                        <button onclick="switchCounterTab('clock')" id="tab-clock"
                            class="px-6 py-2.5 rounded-xl text-sm font-bold bg-gradient-to-r from-indigo-500 to-purple-600 text-white shadow-lg transition-all duration-300"
                            aria-selected="true">
                            <i class="fas fa-stopwatch mr-2"></i> Clock
                        </button>
                        <button onclick="switchCounterTab('tally')" id="tab-tally"
                            class="px-6 py-2.5 rounded-xl text-sm font-bold text-slate-400 hover:text-white hover:bg-white/5 transition-all duration-300"
                            aria-selected="false">
                            <i class="fas fa-fingerprint mr-2"></i> Counter
                        </button>
                    </div>

                    <div id="view-clock" class="w-full flex flex-col items-center transition-all duration-500">

                        <div class="relative w-72 h-72 mb-8 group">
                            <div
                                class="absolute inset-0 bg-indigo-500/20 rounded-full blur-3xl group-hover:bg-indigo-500/30 transition-all duration-700">
                            </div>

                            <svg class="w-full h-full transform -rotate-90 drop-shadow-2xl" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="45" fill="none" stroke="rgba(255,255,255,0.05)"
                                    stroke-width="3" />
                                <circle id="timer-progress" cx="50" cy="50" r="45" fill="none"
                                    stroke="url(#gradientTimer)" stroke-width="4" stroke-linecap="round"
                                    stroke-dasharray="283" stroke-dashoffset="0"
                                    class="transition-all duration-1000 ease-linear" />

                                <defs>
                                    <linearGradient id="gradientTimer" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" stop-color="#6366f1" />
                                        <stop offset="100%" stop-color="#ec4899" />
                                    </linearGradient>
                                </defs>
                            </svg>

                            <div class="absolute inset-0 flex flex-col items-center justify-center z-10">
                                <div id="timer-digits" dir="ltr"
                                    class="text-6xl md:text-7xl font-mono font-bold text-white tracking-wider drop-shadow-lg flex items-center gap-1">
                                    <span id="digit-m1">0</span><span id="digit-m2">0</span><span
                                        class="text-white/50 pb-2">:</span><span id="digit-s1">0</span><span
                                        id="digit-s2">0</span>
                                </div>

                                <div id="timer-input-wrapper"
                                    class="hidden absolute inset-0 flex items-center justify-center bg-[#0f172a]/90 rounded-full backdrop-blur-sm z-20">
                                    <div class="flex flex-col items-center">
                                        <label
                                            class="text-xs text-indigo-300 font-bold uppercase tracking-widest mb-2">Set
                                            Minutes</label>
                                        <input type="number" id="timer-input"
                                            class="w-24 bg-transparent border-b-2 border-indigo-500 text-center text-4xl font-mono text-white focus:outline-none mb-4"
                                            placeholder="25" value="25" min="1">
                                        <button onclick="startTimer()"
                                            class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg shadow-indigo-500/30">START</button>
                                    </div>
                                </div>

                                <div class="text-xs text-slate-400 font-bold tracking-[0.3em] uppercase mt-2"
                                    id="timer-mode-label">STOPWATCH</div>
                            </div>
                        </div>

                        <div class="flex items-center gap-6">
                            <button onclick="resetTimer()"
                                class="w-14 h-14 rounded-full bg-white/5 hover:bg-white/10 text-slate-300 hover:text-white flex items-center justify-center transition-all active:scale-95 border border-white/5">
                                <i class="fas fa-undo"></i>
                            </button>

                            <button onclick="toggleTimer()" id="btn-timer-toggle"
                                class="w-20 h-20 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white text-2xl shadow-xl shadow-indigo-500/30 flex items-center justify-center transition-all hover:scale-105 active:scale-95 border-4 border-[#0f172a]">
                                <i class="fas fa-play pl-1" id="icon-timer-toggle"></i>
                            </button>

                            <button onclick="switchTimerMode()"
                                class="w-14 h-14 rounded-full bg-white/5 hover:bg-white/10 text-slate-300 hover:text-white flex items-center justify-center transition-all active:scale-95 border border-white/5"
                                title="Switch Mode">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                    </div>

                    <div id="view-tally"
                        class="hidden w-full flex flex-col items-center justify-center transition-all duration-500 h-full">

                        <button onclick="clickTally()" id="tally-btn"
                            class="relative w-72 h-72 md:w-80 md:h-80 rounded-[3rem] bg-[#1e1b4b] shadow-2xl flex flex-col items-center justify-center group active:scale-95 transition-all duration-100 border border-white/5 overflow-hidden">

                            <div
                                class="absolute inset-0 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 group-hover:opacity-100 transition-opacity">
                            </div>
                            <div
                                class="absolute -bottom-20 -right-20 w-64 h-64 bg-indigo-500/20 blur-[80px] rounded-full pointer-events-none">
                            </div>

                            <div id="ripple-container"
                                class="absolute inset-0 pointer-events-none overflow-hidden rounded-[3rem]"></div>

                            <span
                                class="text-xs text-indigo-300 font-bold uppercase tracking-[0.3em] mb-4 z-10">Count</span>

                            <div class="h-32 overflow-hidden relative z-10">
                                <span id="tally-display"
                                    class="block text-8xl md:text-9xl font-bold text-white drop-shadow-2xl bg-clip-text text-transparent bg-gradient-to-b from-white to-slate-400">0</span>
                            </div>

                            <div class="absolute bottom-8 text-[10px] text-slate-500">Tap to increment</div>
                        </button>

                        <div class="flex items-center gap-4 mt-10 bg-black/20 p-2 rounded-2xl border border-white/5">
                            <button onclick="resetTally()"
                                class="px-4 py-2 rounded-xl hover:bg-white/10 text-slate-400 hover:text-white transition-colors text-sm">
                                <i class="fas fa-undo mr-2"></i> Reset
                            </button>
                            <div class="w-px h-6 bg-white/10"></div>
                            <button onclick="setTallyMode('up')" id="btn-tally-dir"
                                class="px-4 py-2 rounded-xl hover:bg-white/10 text-indigo-400 transition-colors text-sm font-bold">
                                <i class="fas fa-arrow-up mr-2"></i> Up
                            </button>
                        </div>

                        <div class="mt-4 flex items-center gap-2 text-sm text-slate-500">
                            <span>Start from:</span>
                            <input type="number" id="tally-start-val" value="0"
                                class="w-16 bg-transparent border-b border-slate-600 text-center text-white focus:border-indigo-500 outline-none"
                                onchange="resetTally()">
                        </div>
                    </div>
                </section>

                <section id="page-ai"
                    class="page-section hidden max-w-3xl mx-auto h-[calc(100vh-140px)] flex flex-col pt-2 md:pt-0">
                    <div
                        class="glass-panel rounded-3xl flex-1 flex flex-col overflow-hidden relative border border-white/10">
                        <div class="absolute top-0 start-0 w-full h-1 bg-gradient-to-r from-pink-500 via-purple-500 to-indigo-500"
                            aria-hidden="true"></div>

                        <div class="p-4 border-b border-white/5 flex justify-between items-center bg-white/5">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-gradient-to-br from-pink-500 to-orange-400 flex items-center justify-center">
                                    <i class="fas fa-wand-magic-sparkles text-white text-xs" aria-hidden="true"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-sm" data-i18n="assistantTitle">Assistant</h3>
                                    <p class="text-[10px] text-slate-400" data-i18n="assistantStatus">Agent Mode Active
                                    </p>
                                </div>
                            </div>
                            <button onclick="clearChat()"
                                class="text-slate-500 hover:text-red-400 transition-colors text-xs uppercase tracking-wider font-bold"
                                data-i18n="clear" aria-label="Clear chat">Clear</button>
                        </div>

                        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4" role="log"
                            aria-live="polite" aria-atomic="false">
                            <div class="flex gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-gradient-to-br from-pink-500 to-orange-400 flex-shrink-0 flex items-center justify-center mt-1">
                                    <i class="fas fa-wand-magic-sparkles text-white text-xs" aria-hidden="true"></i>
                                </div>
                                <div class="glass-panel p-3 rounded-2xl rounded-tl-none rtl:rounded-tl-2xl rtl:rounded-tr-none text-sm text-slate-200 chat-bubble max-w-[85%]"
                                    data-i18n="aiWelcome">
                                    Hello! I can add tasks, books, or courses for you. Try "Add a 300 page book named
                                    Atomic Habits".
                                </div>
                            </div>
                        </div>

                        <div class="p-4 bg-black/20 backdrop-blur-md">
                            <div class="relative">
                                <input type="text" id="chat-input"
                                    class="w-full bg-white/5 border border-white/10 rounded-xl py-3 ps-4 pe-12 text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-pink-500/50 transition-all text-base"
                                    placeholder="Tell AI to do something..." data-i18n-placeholder="aiPlaceholder"
                                    onkeydown="if(event.key === 'Enter') sendAIChat()" aria-label="Chat message input">

                                <button onclick="sendAIChat()"
                                    class="absolute end-2 top-1/2 -translate-y-1/2 w-8 h-8 bg-pink-600 rounded-lg flex items-center justify-center text-white hover:bg-pink-500 transition-all active:scale-95"
                                    aria-label="Send message">
                                    <i class="fas fa-paper-plane text-xs" aria-hidden="true"></i>
                                </button>
                            </div>

                            <div class="text-[10px] text-slate-600 text-center mt-2 flex justify-center items-center gap-1"
                                dir="ltr">
                                <span data-i18n="poweredBy">Powered by</span>
                                <span class="text-indigo-400 font-bold">Llama 3</span>
                                <span>&</span>
                                <span class="text-orange-400 font-bold">Groq</span>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="page-settings" class="page-section hidden max-w-2xl mx-auto pt-2 md:pt-0">
                    <h2 class="text-2xl md:text-3xl font-bold mb-8" data-i18n="settings">Settings</h2>

                    <div class="glass-panel rounded-3xl overflow-hidden mb-8">
                        <div class="p-6 border-b border-white/5">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="font-bold flex items-center gap-2">
                                        <i class="fas fa-cloud text-blue-400" aria-hidden="true"></i> Cloud Status
                                    </h3>
                                    <p class="text-xs text-slate-400 mt-1" id="user-email-display">Checking...</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span id="cloud-status"
                                        class="text-xs px-2 py-1 rounded bg-white/5 text-slate-400">Not Synced</span>
                                    <button onclick="triggerCloudSave()"
                                        class="p-2 bg-white/10 rounded-lg hover:bg-white/20" title="Force Sync"
                                        aria-label="Force cloud sync">
                                        <i class="fas fa-sync-alt text-xs" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                       <!-- Storage Usage Card --> 
<div class="glass-panel rounded-3xl overflow-hidden mb-8"> 
    <div class="p-6"> 
        <div class="flex justify-between items-center mb-4"> 
            <div> 
                <h3 class="font-bold flex items-center gap-2"> 
                    <i class="fas fa-hdd text-purple-400"></i>  
                    <span data-i18n="storageUsage">Storage Usage</span> 
                </h3> 
                <p class="text-xs text-slate-400 mt-1" id="storage-detail">Loading...</p> 
            </div> 
            <button onclick="calculateUserStorage().then(() => updateStorageUI())"  
                    class="text-xs px-3 py-1 rounded bg-white/10 hover:bg-white/20 transition-all" 
                    title="Refresh"> 
                <i class="fas fa-sync-alt"></i> 
            </button> 
        </div> 
         
        <!-- Progress Bar --> 
        <div class="w-full bg-slate-700/50 h-3 rounded-full overflow-hidden mb-2 relative"> 
            <div id="storage-progress-bar"  
                 class="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-1000"  
                 style="width: 0%"></div> 
        </div> 
         
        <div class="flex justify-between text-xs text-slate-400"> 
            <span id="storage-used">0 MB</span> 
            <span id="storage-limit">100 MB</span> 
        </div> 
 
        <!-- Cloudinary Credit (No Link) --> 
        <div class="mt-4 pt-4 border-t border-white/5 flex items-center justify-between"> 
            <div class="flex items-center gap-2 text-xs text-slate-500"> 
                <i class="fas fa-cloud"></i> 
                <span>File storage powered by</span> 
                <span class="text-blue-400 font-bold">
                    Cloudinary
                </span> 
            </div> 
        </div> 
    </div> 
</div>

                        <div class="p-6 border-b border-white/5 flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="p-3 rounded-xl bg-white/5">
                                    <i class="fas fa-palette accent-text" aria-hidden="true"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold" data-i18n="nebulaColor">Nebula Color</h3>
                                    <p class="text-xs text-slate-400" data-i18n="customizeAccent">Customize accent color
                                    </p>
                                </div>
                            </div>
                            <input type="color" id="accent-color-picker"
                                class="w-10 h-10 rounded-full bg-transparent border-0 cursor-pointer"
                                onchange="updateAccentColor(this.value)" aria-label="Select accent color">
                        </div>

                        <div class="p-6 flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="p-3 rounded-xl bg-white/5">
                                    <i class="fas fa-language" aria-hidden="true"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold" data-i18n="language">Language</h3>
                                    <p class="text-xs text-slate-400">English / Arabic</p>
                                </div>
                            </div>
                            <button onclick="toggleLanguage()"
                                class="px-4 py-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 transition-colors text-sm font-bold"
                                aria-label="Toggle language">
                                <span id="current-lang-display">English</span>
                            </button>
                        </div>
                    </div>
                    <!-- زر سياسة الخصوصية -->
                    <button onclick="showPage('privacy')"
                        class="w-full py-4 rounded-2xl border border-indigo-500/30 text-indigo-400 hover:bg-indigo-500/10 font-medium flex items-center justify-center gap-2 transition-all mb-4">
                        <i class="fas fa-shield-alt"></i>
                        <span data-i18n="privacyPolicy">privacy policy</span>
                    </button>

                    <button onclick="handleLogout()"
                        class="w-full py-4 rounded-2xl border border-red-500/30 text-red-400 hover:bg-red-500/10 font-medium flex items-center justify-center gap-2"
                        aria-label="Logout">
                        <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                        <span data-i18n="logout">Logout</span>
                    </button>

                    <div class="mt-8 text-center border-t border-white/5 pt-4 pb-4">
                        <p class="text-[10px] text-slate-500 uppercase tracking-widest mb-2">Technology</p>
                        <div class="flex items-center justify-center gap-2 text-xs text-slate-400 font-medium">
                            <span>Powered by</span>
                            <span
                                class="bg-indigo-500/10 text-indigo-400 px-2 py-0.5 rounded border border-indigo-500/20">Llama
                                3</span>
                            <span>on</span>
                            <span
                                class="bg-orange-500/10 text-orange-400 px-2 py-0.5 rounded border border-orange-500/20">Groq</span>
                        </div>
                    </div>

                </section>
                <!-- =====================================================
     صفحة سياسة الخصوصية - Privacy Policy Page
     ===================================================== -->
                <section id="page-privacy" class="page-section hidden max-w-3xl mx-auto pt-2 md:pt-0">
                    <h2 class="text-2xl md:text-3xl font-bold mb-8 text-white">🔒 Privacy Policy</h2>

                    <div class="glass-panel rounded-3xl p-6 md:p-8 space-y-6" dir="ltr">

                        <div class="text-center pb-6 border-b border-white/10">
                            <div
                                class="w-16 h-16 mx-auto mb-4 rounded-full bg-indigo-500/20 flex items-center justify-center">
                                <i class="fas fa-shield-alt text-3xl text-indigo-400"></i>
                            </div>
                            <p class="text-lg text-slate-300 leading-relaxed">
                                We respect your privacy and are committed to protecting your data. This is an ethical
                                and moral promise.
                            </p>
                        </div>

                        <div>
                            <h3 class="text-xl font-bold text-indigo-400 mb-3 flex items-center gap-2">
                                <i class="fas fa-database"></i>
                                Data We Collect
                            </h3>
                            <div class="bg-white/5 rounded-xl p-4 space-y-3 text-slate-300">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-check-circle text-green-400 mt-1 flex-shrink-0"></i>
                                    <div>
                                        <strong>Email Address:</strong> Only when signing in with Google.
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-check-circle text-green-400 mt-1 flex-shrink-0"></i>
                                    <div>
                                        <strong>Personal Data:</strong> Tasks, books, courses, and notes you add.
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-check-circle text-green-400 mt-1 flex-shrink-0"></i>
                                    <div>
                                        <strong>Files:</strong> Images or PDFs you upload (Stored securely).
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xl font-bold text-green-400 mb-3 flex items-center gap-2">
                                <i class="fas fa-hand-holding-heart"></i>
                                Our Commitments
                            </h3>
                            <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-4 space-y-3">
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-ban text-green-300 mt-1 flex-shrink-0"></i>
                                    <p class="text-slate-200">
                                        <strong class="text-green-300">We never sell your data</strong> - This is a
                                        strict ethical boundary.
                                    </p>
                                </div>
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-user-shield text-green-300 mt-1 flex-shrink-0"></i>
                                    <p class="text-slate-200">
                                        <strong class="text-green-300">No unauthorized sharing</strong> with advertisers
                                        or commercial third parties.
                                    </p>
                                </div>
                                <div class="flex items-start gap-3">
                                    <i class="fas fa-lock text-green-300 mt-1 flex-shrink-0"></i>
                                    <p class="text-slate-200">
                                        <strong class="text-green-300">Secure Storage</strong> on Firebase (Google
                                        Cloud) infrastructure.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xl font-bold text-blue-400 mb-3 flex items-center gap-2">
                                <i class="fas fa-cogs"></i>
                                How We Use Your Data
                            </h3>
                            <div class="bg-white/5 rounded-xl p-4 text-slate-300 space-y-2 text-sm">
                                <p>• <strong>Sync:</strong> To access your data across different devices.</p>
                                <p>• <strong>Functionality:</strong> To enable features like timers and tracking.</p>
                                <p>• <strong>Backup:</strong> To prevent data loss.</p>
                                <p class="text-xs text-slate-500 mt-3 pt-3 border-t border-white/10">
                                    <strong>Note:</strong> We do NOT use your data for advertising or marketing
                                    purposes.
                                </p>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xl font-bold text-purple-400 mb-3 flex items-center gap-2">
                                <i class="fas fa-robot"></i>
                                Artificial Intelligence (Groq API)
                            </h3>
                            <div
                                class="bg-purple-500/10 border border-purple-500/30 rounded-xl p-4 text-slate-300 space-y-2 text-sm">
                                <p>• We use Groq AI (Llama 3 models) to help organize your tasks.</p>
                                <p>• Data is sent only when you actively use the Assistant features.</p>
                                <p class="text-xs text-slate-500 mt-2 pt-2 border-t border-white/10">
                                    See Groq Policy: <a href="https://groq.com/privacy-policy/" target="_blank"
                                        rel="noopener noreferrer"
                                        class="text-indigo-400 hover:underline">groq.com/privacy-policy</a>
                                </p>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xl font-bold text-yellow-400 mb-3 flex items-center gap-2">
                                <i class="fas fa-mosque"></i>
                                Religious Content & Accuracy
                            </h3>
                            <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4">
                                <p class="text-slate-300 text-sm leading-relaxed">
                                    Azkar content is sourced from trusted references. However,
                                    <strong class="text-yellow-300">please verify</strong>
                                    with scholars or trusted books. We strive for accuracy, but errors can occur.
                                </p>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xl font-bold text-orange-400 mb-3 flex items-center gap-2">
                                <i class="fas fa-cookie-bite"></i>
                                Local Storage
                            </h3>
                            <div class="bg-white/5 rounded-xl p-4 text-slate-300 text-sm">
                                <p>We use your browser's Local Storage to save:</p>
                                <ul class="mt-2 ml-4 space-y-1 list-disc list-inside">
                                    <li>Preferences (Language, Theme/Colors).</li>
                                    <li>All data when using "Guest Mode" (Offline).</li>
                                </ul>
                                <p class="mt-2 text-xs text-slate-500">
                                    You can clear this data anytime via your browser settings.
                                </p>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xl font-bold text-red-400 mb-3 flex items-center gap-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                Disclaimer
                            </h3>
                            <div
                                class="bg-red-500/10 border border-red-500/30 rounded-xl p-4 text-sm text-slate-300 space-y-2">
                                <p>• This tool is a personal organizer; we do our best to secure it.</p>
                                <p>• <strong>Do not upload highly sensitive files</strong> (e.g., Passports, Passwords).
                                </p>
                                <p>• We are not responsible for any data loss or misuse.</p>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xl font-bold text-cyan-400 mb-3 flex items-center gap-2">
                                <i class="fas fa-balance-scale"></i>
                                Your Rights
                            </h3>
                            <div class="bg-white/5 rounded-xl p-4 text-slate-300 text-sm space-y-2">
                                <p><strong>You have the right to:</strong></p>
                                <ul class="ml-4 space-y-1 list-disc list-inside">
                                    <li><strong>Access</strong> your data at any time.</li>
                                    <li><strong>Edit or Delete</strong> any stored information.</li>
                                    <li><strong>Opt-out</strong> by deleting your account.</li>
                                </ul>
                            </div>
                        </div>

                        <div class="bg-indigo-500/10 border border-indigo-500/30 rounded-xl p-4">
                            <h4 class="font-bold text-indigo-300 mb-2 flex items-center gap-2">
                                <i class="fab fa-whatsapp"></i>
                                Contact Us
                            </h4>

                            <p class="text-sm text-slate-300">
                                For privacy questions, data requests, or account deletion:
                            </p>

                            <div class="mt-2 flex flex-col gap-2">
                                <a href="https://wa.me/201025376549" target="_blank"
                                    class="text-green-400 hover:underline text-sm flex items-center gap-2">
                                    <i class="fab fa-whatsapp"></i>
                                    Chat via WhatsApp
                                </a>

                                <p class="text-xs text-slate-500">
                                    (We will respond as soon as possible)
                                </p>
                            </div>
                        </div>

                        <div class="bg-white/5 rounded-xl p-4 text-sm text-slate-400">
                            <p><strong>Policy Updates:</strong></p>
                            <p class="mt-1">
                                We may update this policy from time to time to reflect changes in our practices.
                            </p>
                        </div>

                        <div class="text-center text-xs text-slate-500 pt-4 border-t border-white/10">
                            <i class="fas fa-calendar-alt mr-1"></i>
                            Last Updated: January 6, 2026
                        </div>

                    </div>

                    <div class="mt-6 text-center">
                        <button onclick="showPage('settings')"
                            class="px-6 py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 text-slate-300 hover:text-white transition-all flex items-center gap-2 mx-auto">
                            <i class="fas fa-arrow-left"></i>
                            <span>Back to Settings</span>
                        </button>
                    </div>
                </section>
                </section>

                <section id="page-azkar" class="page-section hidden max-w-3xl mx-auto pt-2 md:pt-0 pb-20" dir="rtl">
                    <div class="text-center mb-6 relative">
                        <h2 class="text-3xl md:text-5xl font-bold mb-2 drop-shadow-lg uthmani-font"
                            style="color: var(--azkar-gold);">ألا بذكر الله تطمئن القلوب</h2>
                        <p class="text-slate-400 text-sm">حصن المسلم اليومي</p>
                    </div>

                    <div class="flex justify-center gap-2 mb-8 sticky top-0 z-20 bg-[#064e3b]/80 backdrop-blur-md p-2 rounded-2xl border border-white/5 shadow-xl"
                        role="tablist">
                        <button onclick="switchAzkarTab('morning')" id="tab-morning"
                            class="azkar-theme-btn active px-4 py-2 rounded-xl text-sm md:text-base flex-1" role="tab"
                            aria-selected="true" aria-controls="azkar-list">أذكار الصباح</button>
                        <button onclick="switchAzkarTab('evening')" id="tab-evening"
                            class="azkar-theme-btn px-4 py-2 rounded-xl text-sm md:text-base flex-1" role="tab"
                            aria-selected="false" aria-controls="azkar-list">أذكار المساء</button>
                        <button onclick="switchAzkarTab('general')" id="tab-general"
                            class="azkar-theme-btn px-4 py-2 rounded-xl text-sm md:text-base flex-1" role="tab"
                            aria-selected="false" aria-controls="azkar-list">تسابيح</button>
                    </div>

                    <div id="azkar-list" class="grid grid-cols-1 gap-4 pb-24" role="list"></div>
                </section>
            </div>

            <div id="mini-widget" onclick="openWidgetDetail()"
                class="widget-pill flex items-center gap-3 cursor-pointer group" role="button"
                aria-label="Open daily snapshot">
                <div id="widget-timer-container"
                    class="flex items-center gap-2 text-yellow-400 border-e border-white/10 pe-3 me-1 hidden">
                    <div class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse" aria-hidden="true"></div>
                    <span id="widget-timer-val" class="font-mono font-bold text-sm" aria-live="polite">00:00</span>
                </div>
                <div class="flex items-center gap-2">
                    <i class="fas fa-tasks text-purple-400 text-sm" aria-hidden="true"></i>
                    <span id="widget-tasks-val" class="font-bold text-sm text-white" aria-live="polite">0</span>
                </div>
                <div
                    class="w-8 h-8 rounded-full border-2 border-white/10 flex items-center justify-center relative ms-1">
                    <svg class="w-full h-full transform -rotate-90" viewBox="0 0 36 36" aria-label="Daily progress">
                        <path class="text-white/5"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none" stroke="currentColor" stroke-width="4" />
                        <path id="widget-progress-ring" class="text-indigo-500 transition-all duration-500"
                            stroke-dasharray="0, 100"
                            d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                            fill="none" stroke="currentColor" stroke-width="4" />
                    </svg>
                    <i class="fas fa-chevron-up text-[8px] text-white/50 group-hover:-translate-y-0.5 transition-transform"
                        aria-hidden="true"></i>
                </div>
            </div>

            <button onclick="showPage('ai')" class="floating-ai-btn hover:scale-110 active:scale-95"
                aria-label="Open AI assistant">
                <i class="fas fa-wand-magic-sparkles" aria-hidden="true"></i>
            </button>

            <nav class="md:hidden fixed bottom-4 left-2 right-2 h-16 glass-panel rounded-2xl grid grid-cols-7 gap-0 items-center z-40 mobile-dock border border-white/20 px-1"
                role="navigation" aria-label="Mobile navigation">

                <button onclick="showPage('courses')"
                    class="nav-link flex flex-col items-center justify-center h-full rounded-xl hover:bg-white/5 transition-colors group"
                    aria-label="Courses">
                    <i class="fas fa-graduation-cap text-lg mb-1 group-[.active]:text-indigo-400 text-slate-400"></i>
                    <span class="text-[8px] uppercase font-bold opacity-60">Edu</span>
                </button>

                <button onclick="showPage('tasks')"
                    class="nav-link flex flex-col items-center justify-center h-full rounded-xl hover:bg-white/5 transition-colors group"
                    aria-label="Tasks">
                    <i class="fas fa-check-circle text-lg mb-1 group-[.active]:text-purple-400 text-slate-400"></i>
                    <span class="text-[8px] uppercase font-bold opacity-60">Task</span>
                </button>

                <button onclick="showPage('notes')"
                    class="nav-link flex flex-col items-center justify-center h-full rounded-xl hover:bg-white/5 transition-colors group"
                    aria-label="Notes">
                    <i class="fas fa-sticky-note text-lg mb-1 group-[.active]:text-yellow-400 text-slate-400"></i>
                    <span class="text-[8px] uppercase font-bold opacity-60">Note</span>
                </button>

                <button onclick="showPage('azkar')"
                    class="nav-link flex flex-col items-center justify-center h-full rounded-xl hover:bg-white/5 transition-colors group"
                    aria-label="Azkar">
                    <i
                        class="fas fa-mosque text-xl mb-1 text-orange-400 group-[.active]:scale-110 transition-transform"></i>
                    <span class="text-[8px] uppercase font-bold text-orange-400/80">Zikr</span>
                </button>

                <button onclick="showPage('counters')"
                    class="nav-link flex flex-col items-center justify-center h-full rounded-xl hover:bg-white/5 transition-colors group"
                    aria-label="Timers">
                    <i class="fas fa-stopwatch text-lg mb-1 group-[.active]:text-yellow-400 text-slate-400"></i>
                    <span class="text-[8px] uppercase font-bold opacity-60">Time</span>
                </button>

                <button onclick="showPage('books')"
                    class="nav-link flex flex-col items-center justify-center h-full rounded-xl hover:bg-white/5 transition-colors group"
                    aria-label="Books">
                    <i class="fas fa-book-open text-lg mb-1 group-[.active]:text-emerald-400 text-slate-400"></i>
                    <span class="text-[8px] uppercase font-bold opacity-60">Book</span>
                </button>

                <button onclick="showPage('trash')"
                    class="nav-link flex flex-col items-center justify-center h-full rounded-xl hover:bg-white/5 transition-colors group"
                    aria-label="Trash">
                    <i class="fas fa-trash-alt text-lg mb-1 group-[.active]:text-red-400 text-slate-400"></i>
                    <span class="text-[8px] uppercase font-bold opacity-60">Bin</span>
                </button>

            </nav>
        </main>
    </div>

    <div id="modal-overlay"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-300"
        onclick="closeAllModals()" role="dialog" aria-modal="true"></div>

    <div id="levelModal" class="modal-overlay" style="display: none;"
        onclick="if(event.target === this) closeLevelModal()" role="dialog" aria-modal="true"
        aria-labelledby="level-modal-title">
        <div class="level-card">
            <div class="modal-header">
                <h3 id="level-modal-title">User Progression</h3>
                <button onclick="closeLevelModal()" class="close-btn"
                    style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;"
                    aria-label="Close level modal">&times;</button>
            </div>

            <div class="level-info-center">
                <div class="current-level-icon">
                    <i class="fa-solid fa-crown mr-2" aria-hidden="true"></i>
                    <span>Lvl <span id="displayCurrentLevel">1</span></span>
                </div>
                <p class="xp-text"><span id="currentXP">0</span> / <span id="nextLevelXP">200</span> XP</p>
            </div>

            <div class="progress-container">
                <div class="progress-bar-bg">
                    <div id="levelProgressBar" class="progress-bar-fill" style="width: 0%;" role="progressbar"
                        aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="progress-labels">
                    <span id="currentLvlLabel">Lvl 1</span>
                    <span id="nextLvlLabel">Lvl 2</span>
                </div>
            </div>

            <div class="xp-history">
                <h4>Recent Gains</h4>
                <div class="xp-item">
                    <div class="xp-icon">
                        <i class="fa-solid fa-check-circle" aria-hidden="true"></i>
                    </div>
                    <div class="xp-details">
                        <span>Active Session</span>
                        <small>Now</small>
                    </div>
                    <span class="xp-amount" style="color:#6366f1">Active</span>
                </div>
            </div>
        </div>
    </div>

    <div id="widget-modal"
        class="modal-wrapper hidden fixed inset-0 z-[60] flex items-end md:items-center justify-center pointer-events-none p-4 pb-24 md:pb-4"
        role="dialog" aria-modal="true" aria-labelledby="widget-modal-title">
        <div
            class="modal-content glass-panel w-full max-w-sm rounded-3xl p-6 bg-[#1e1b4b]/95 pointer-events-auto border border-white/10 shadow-2xl relative">
            <button onclick="closeAllModals()" class="absolute top-4 right-4 text-white/50 hover:text-white"
                aria-label="Close modal">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            <h3 id="widget-modal-title" class="text-xl font-bold text-white mb-1">Daily Snapshot</h3>
            <p class="text-xs text-slate-400 mb-4">Here is how you are doing today.</p>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-white/5 rounded-xl p-3 text-center">
                    <div class="text-2xl font-bold text-purple-400" id="detail-tasks-done">0</div>
                    <div class="text-[10px] uppercase tracking-wide text-slate-400">Tasks Done</div>
                </div>
                <div class="bg-white/5 rounded-xl p-3 text-center">
                    <div class="text-2xl font-bold text-indigo-400" id="detail-tasks-left">0</div>
                    <div class="text-[10px] uppercase tracking-wide text-slate-400">Remaining</div>
                </div>
            </div>
            <div class="mb-2">
                <div class="flex justify-between text-xs text-slate-300 mb-1">
                    <span>Daily Progress</span>
                    <span id="detail-progress-txt">0%</span>
                </div>
                <div class="w-full bg-black/20 h-2 rounded-full overflow-hidden">
                    <div id="detail-progress-bar"
                        class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 w-0 transition-all duration-1000"
                        role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="confirm-modal"
        class="modal-wrapper hidden fixed inset-0 z-[70] flex items-center justify-center pointer-events-none p-4"
        role="dialog" aria-modal="true">
        <div
            class="modal-content glass-panel w-full max-w-sm rounded-3xl p-6 bg-[#1e1b4b]/95 pointer-events-auto border border-white/10 shadow-2xl text-center">

            <div
                class="w-16 h-16 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center mx-auto mb-4 text-2xl">
                <i class="fas fa-exclamation-triangle"></i>
            </div>

            <h3 class="text-xl font-bold text-white mb-2" data-i18n="areYouSure">Are you sure?</h3>
            <p id="confirm-modal-msg" class="text-slate-300 text-sm mb-6">This action cannot be undone.</p>

            <div class="flex gap-3">
                <button onclick="closeAllModals()"
                    class="flex-1 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-slate-300 transition-colors font-bold">
                    Cancel
                </button>
                <button onclick="executeConfirmAction()"
                    class="flex-1 py-3 rounded-xl bg-red-600 hover:bg-red-500 text-white transition-colors font-bold shadow-lg shadow-red-900/20">
                    Confirm
                </button>
            </div>
        </div>
    </div>
    <div id="generic-modal"
        class="modal-wrapper hidden fixed inset-0 z-[60] flex items-center justify-center pointer-events-none p-4"
        role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div id="generic-modal-content"
            class="modal-content glass-panel w-full max-w-md rounded-3xl p-6 md:p-8 bg-[#1e1b4b]/95 pointer-events-auto border border-white/10 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-2xl font-bold mb-6 text-white" id="modal-title">Manage Item</h3>
            <input type="hidden" id="modal-type">
            <input type="hidden" id="modal-id">

            <div class="space-y-4">
                <input type="text" id="modal-name" placeholder="Title/Name" data-i18n-placeholder="titlePlaceholder"
                    class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white focus:outline-none focus:border-indigo-500 transition-colors text-base"
                    aria-label="Item title">

                <div id="ai-suggestion-area" class="flex gap-2 mb-2 hidden">
                    <button id="btn-ai-task" onclick="aiMagicSplit()"
                        class="hidden text-xs bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-3 py-1.5 rounded-lg flex items-center gap-1 hover:opacity-90 transition-opacity"
                        aria-label="Magic split task">
                        <i class="fas fa-magic" aria-hidden="true"></i> <span data-i18n="magicSplit">✨ Magic
                            Split</span>
                    </button>
                    <button id="btn-ai-book" onclick="aiBookScout()"
                        class="hidden text-xs bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-3 py-1.5 rounded-lg flex items-center gap-1 hover:opacity-90 transition-opacity"
                        aria-label="Book scout">
                        <i class="fas fa-search" aria-hidden="true"></i> <span data-i18n="bookScout">✨ Book Scout</span>
                    </button>
                    <button id="btn-ai-course" onclick="aiCourseOutline()"
                        class="hidden text-xs bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-3 py-1.5 rounded-lg flex items-center gap-1 hover:opacity-90 transition-opacity"
                        aria-label="Generate syllabus">
                        <i class="fas fa-list-ol" aria-hidden="true"></i> <span data-i18n="syllabusGen">✨ Syllabus
                            Gen</span>
                    </button>
                </div>

                <div id="modal-stats-row" class="grid grid-cols-2 gap-4 hidden">
                    <div>
                        <label class="text-[10px] text-slate-400 uppercase font-bold" id="lbl-total" for="modal-total"
                            data-i18n="totalPages">Total</label>
                        <input type="number" id="modal-total"
                            class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white text-center text-base"
                            aria-label="Total amount">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-400 uppercase font-bold" id="lbl-done" for="modal-done"
                            data-i18n="readPages">Done</label>
                        <input type="number" id="modal-done"
                            class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white text-center text-base"
                            aria-label="Completed amount">
                    </div>
                </div>

                <div id="modal-optional-row"
                    class="hidden flex items-center gap-3 bg-black/10 p-3 rounded-xl border border-white/5">
                    <input type="checkbox" id="modal-optional"
                        class="w-5 h-5 rounded border-white/10 bg-black/20 accent-indigo-500">
                    <label for="modal-optional" class="text-sm text-slate-300 select-none cursor-pointer"
                        data-i18n="markOptional">Mark as Optional (Side Quest)</label>
                </div>

                <textarea id="modal-desc" rows="3" placeholder="Description/Notes..."
                    data-i18n-placeholder="descPlaceholder"
                    class="w-full bg-black/20 border border-white/10 rounded-xl p-3 text-white text-sm text-base"
                    aria-label="Item description"></textarea>

                <div id="media-section-group" class="space-y-4">
                    <div class="glass-panel p-3 rounded-xl bg-black/10">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-slate-400" data-i18n="voiceNote">VOICE NOTE</span>
                            <button onclick="toggleAudioRecording(this)"
                                class="text-xs p-1.5 rounded bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-white transition-colors flex items-center gap-1"
                                aria-label="Record voice note">
                                <i class="fas fa-microphone" aria-hidden="true"></i> <span
                                    data-i18n="record">Record</span>
                            </button>
                        </div>
                        <div id="modal-audio-player-container"
                            class="hidden mt-2 bg-black/30 rounded-lg p-2 flex items-center gap-2">
                            <audio id="modal-audio-player" controls class="w-full h-8 bg-transparent"
                                style="height:30px;" aria-label="Voice note"></audio>
                            <button onclick="deleteAudioNote()" class="text-red-400 hover:text-white p-1"
                                aria-label="Delete voice note">
                                <i class="fas fa-trash" aria-hidden="true"></i>
                            </button>
                        </div>
                    </div>

                    <div class="glass-panel p-3 rounded-xl bg-black/10">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-slate-400" data-i18n="files">FILES (PDF, Video,
                                Img)</span>
                            <label
                                class="cursor-pointer text-xs p-1.5 rounded bg-blue-500/20 text-blue-400 hover:bg-blue-500 hover:text-white transition-colors flex items-center gap-1">
                                <i class="fas fa-paperclip" aria-hidden="true"></i> <span
                                    data-i18n="attach">Attach</span>
                                <input type="file" multiple class="hidden" onchange="handleFileUpload(this)"
                                    aria-label="Attach files">
                            </label>
                        </div>
                        <div id="file-list-preview" class="space-y-2 mt-2"></div>
                    </div>

                    <div id="modal-drawing-section" class="glass-panel p-3 rounded-xl bg-black/10">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs font-bold text-slate-400" data-i18n="drawing">DRAWING / SKETCH</span>
                            <button onclick="openDrawingCanvas()"
                                class="text-xs p-1.5 rounded bg-blue-500/20 text-blue-400 hover:bg-blue-500 hover:text-white transition-colors flex items-center gap-1"
                                aria-label="Add drawing">
                                <i class="fas fa-pencil-alt" aria-hidden="true"></i>
                                <span id="btn-draw-label" data-i18n="addDrawing">Add Drawing</span>
                            </button>
                        </div>
                        <div id="modal-drawing-preview"
                            class="hidden mt-2 bg-white/5 rounded-lg p-2 flex items-center justify-center relative group">
                            <img id="modal-drawing-img" src="" class="max-h-32 rounded border border-white/10"
                                alt="Drawing preview">
                            <div
                                class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2">
                                <button onclick="openDrawingCanvas()" class="p-2 bg-blue-500 rounded-full text-white"
                                    aria-label="Edit drawing">
                                    <i class="fas fa-edit" aria-hidden="true"></i>
                                </button>
                                <button onclick="deleteDrawing()" class="p-2 bg-red-500 rounded-full text-white"
                                    aria-label="Delete drawing">
                                    <i class="fas fa-trash" aria-hidden="true"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2 justify-end pt-2">
                    <button onclick="saveItem(this)" id="btn-save-modal"
                        class="interactive-btn flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-500 transition-colors"
                        aria-label="Save item">
                        <span class="btn-text-content" data-i18n="save">Save</span>
                        <span class="btn-loader" aria-hidden="true">
                            <span class="dot-wave"></span>
                            <span class="dot-wave"></span>
                            <span class="dot-wave"></span>
                        </span>
                        <span class="btn-success-icon" aria-hidden="true">
                            <i class="fas fa-check"></i>
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex gap-2 justify-end pt-2">
        <button onclick="saveItem(this)" id="btn-save-modal"
            class="interactive-btn flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-500 transition-colors"
            aria-label="Save item">
            <span class="btn-text-content">Save</span>
            <span class="btn-loader" aria-hidden="true">
                <span class="dot-wave"></span>
                <span class="dot-wave"></span>
                <span class="dot-wave"></span>
            </span>
            <span class="btn-success-icon" aria-hidden="true">
                <i class="fas fa-check"></i>
            </span>
        </button>
    </div>
    </div>
    </div>
    </div>

    <div id="drawing-modal" class="fixed inset-0 bg-[#0f172a] hidden flex-col z-[70]" role="dialog" aria-modal="true"
        aria-label="Drawing canvas">
        <div
            class="h-16 bg-[#1e293b] flex items-center justify-between px-4 shrink-0 border-b border-white/10 shadow-lg relative z-10">
            <button onclick="closeDrawingModal()" class="text-slate-400 hover:text-white flex items-center gap-2">
                <i class="fas fa-arrow-left"></i> <span data-i18n="back">Exit</span>
            </button>

            <div class="flex items-center gap-3 bg-black/20 p-1.5 rounded-lg border border-white/5 overflow-x-auto">
                <button onclick="addTextToCanvas()" class="w-8 h-8 rounded hover:bg-white/10 text-white"
                    title="Add text"><i class="fas fa-font"></i></button>

                <label
                    class="w-8 h-8 rounded hover:bg-white/10 text-white flex items-center justify-center cursor-pointer"
                    title="Add image">
                    <i class="fas fa-image"></i>
                    <input type="file" class="hidden" accept="image/*" onchange="addImageToCanvas(this)">
                </label>

                <div class="w-px h-6 bg-white/10"></div>

                <button onclick="toggleDrawMode(true)" id="btn-draw-mode"
                    class="w-8 h-8 rounded hover:bg-white/10 text-indigo-400" title="freehand sketch"><i
                        class="fas fa-pencil-alt"></i></button>
                <button onclick="toggleDrawMode(false)" id="btn-select-mode"
                    class="w-8 h-8 rounded hover:bg-white/10 text-white" title="Select and move"><i
                        class="fas fa-mouse-pointer"></i></button>

                <div class="w-px h-6 bg-white/10"></div>

                <input type="color" id="brush-color" class="w-6 h-6 rounded cursor-pointer bg-transparent border-0"
                    value="#ffffff" onchange="updateBrush()">
                <input type="range" id="brush-size" min="1" max="50" value="4" class="w-20 accent-indigo-500"
                    oninput="updateBrush()">

                <div class="w-px h-6 bg-white/10"></div>

                <button onclick="deleteSelectedObject()" class="w-8 h-8 rounded hover:bg-red-500/20 text-red-400"
                    title="Delete selected item">
                    <i class="fas fa-trash-alt"></i>
                </button>

                <button onclick="clearCanvas()" class="w-8 h-8 rounded hover:bg-red-500/20 text-red-400"
                    title="delete the entire panel">
                    <i class="fas fa-bomb"></i>
                </button>

                <div class="w-px h-6 bg-white/10"></div>

                <button onclick="downloadCanvasAsPNG()" class="w-8 h-8 rounded hover:bg-green-500/20 text-green-400"
                    title="download image">
                    <i class="fas fa-download"></i>
                </button>
            </div>

            <button onclick="saveCanvasDrawing()" class="text-slate-400 hover:text-white flex items-center gap-2">
                <span class="btn-text-content">Save</span>
                <span class="btn-loader">...</span>
            </button>
        </div>

        <div class="flex-1 relative overflow-hidden bg-[#0f172a] flex items-center justify-center"
            id="canvas-container-wrapper">
            <canvas id="fabric-canvas"></canvas>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ==========================================
//  CLOUDINARY CONFIGURATION
// ==========================================

    window.CLOUDINARY_CONFIG = {
        cloudName: 'dnpnpmdcf',
        uploadPreset: 'how_much_app',
        folder: 'user-files'
    };
    
    window.USER_STORAGE_LIMIT = 100 * 1024 * 1024; // 100MB
    window.MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB

// نظام تتبع حجم كل مستخدم (سيُحفظ في Firestore)
window.userStorageInfo = {
    used: 0,
    limit: 100 * 1024 * 1024, // 100MB
    fileCount: 0
};

// دالة حساب حجم الملفات المستخدم
window.calculateUserStorage = async function() {
    if (!currentUser || !db) {
        window.userStorageInfo.used = 0;
        window.userStorageInfo.fileCount = 0;
        return;
    }

    try {
        // جمع أحجام الملفات من جميع العناصر
        let totalSize = 0;
        let fileCount = 0;

        // من المهام
        window.appData.tasks.forEach(task => {
            if (task.files && Array.isArray(task.files)) {
                task.files.forEach(file => {
                    totalSize += (file.size || 0);
                    fileCount++;
                });
            }
        });

        // من الملاحظات
        window.appData.notes.forEach(note => {
            if (note.files && Array.isArray(note.files)) {
                note.files.forEach(file => {
                    totalSize += (file.size || 0);
                    fileCount++;
                });
            }
        });

        // من الدورات
        window.appData.courses.forEach(course => {
            if (course.files && Array.isArray(course.files)) {
                course.files.forEach(file => {
                    totalSize += (file.size || 0);
                    fileCount++;
                });
            }
        });

        // من الكتب
        window.appData.books.forEach(book => {
            if (book.files && Array.isArray(book.files)) {
                book.files.forEach(file => {
                    totalSize += (file.size || 0);
                    fileCount++;
                });
            }
        });

        window.userStorageInfo.used = totalSize;
        window.userStorageInfo.fileCount = fileCount;
        
        console.log(`📊 Storage: ${(totalSize / 1024 / 1024).toFixed(2)} MB / ${(USER_STORAGE_LIMIT / 1024 / 1024).toFixed(0)} MB`);
        
    } catch (error) {
        console.error("Storage calculation error:", error);
    }
};

// دالة تحديث واجهة معلومات التخزين
window.updateStorageUI = function() {
    const usedMB = (window.userStorageInfo.used / 1024 / 1024).toFixed(2);
    const limitMB = (USER_STORAGE_LIMIT / 1024 / 1024).toFixed(0);
    const percentage = ((window.userStorageInfo.used / USER_STORAGE_LIMIT) * 100).toFixed(1);
    
    const detailEl = document.getElementById('storage-detail');
    const progressBar = document.getElementById('storage-progress-bar');
    const usedEl = document.getElementById('storage-used');
    const limitEl = document.getElementById('storage-limit');
    
    if (detailEl) {
        detailEl.innerText = `${window.userStorageInfo.fileCount} files • ${usedMB} MB used`;
    }
    
    if (progressBar) {
        progressBar.style.width = Math.min(100, percentage) + '%';
        
        // تغيير اللون حسب النسبة
        if (percentage >= 90) {
            progressBar.className = 'h-full bg-gradient-to-r from-red-500 to-orange-500 transition-all duration-1000';
        } else if (percentage >= 70) {
            progressBar.className = 'h-full bg-gradient-to-r from-yellow-500 to-orange-500 transition-all duration-1000';
        } else {
            progressBar.className = 'h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-1000';
        }
    }
    
    if (usedEl) usedEl.innerText = usedMB + ' MB';
    if (limitEl) limitEl.innerText = limitMB + ' MB';
};


        const firebaseConfig = {
            apiKey: "AIzaSyDhdoM-c_a8j5qEo9BtNd1j2NyWD9uXh3U",
            authDomain: "how-much-v2.firebaseapp.com",
            projectId: "how-much-v2",
            storageBucket: "how-much-v2.firebasestorage.app",
            messagingSenderId: "1036316370452",
            appId: "1:1036316370452:web:f46292e034ada3bd2ea901",
            measurementId: "G-84F0PKHDFV"
        };

        const appId = 'how-much-v2';
        let app, auth, db;
        window.currentUser = null; // ✅ جعله عالمي

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        window.handleGoogleLogin = async () => {
            if (auth) {
                try {
                    await signInWithPopup(auth, new GoogleAuthProvider());
                } catch (error) {
                    console.error("Login Error:", error);
                    if (error.code === 'auth/unauthorized-domain') {
                        alert("Preview Domain Not Authorized. \n\nPlease use 'Continue Offline (Guest)'.");
                    } else {
                        showToast("Login Failed: " + error.message);
                    }
                }
            }
        };

        window.handleLogout = async () => {
            if (auth) await signOut(auth);
            localStorage.removeItem('hm_user');
            localStorage.removeItem('hm_guest');
            window.location.reload();
        };

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    window.currentUser = user; // ✅ جعله عالمي
                    const emailDisplay = document.getElementById('user-email-display');
                    if (emailDisplay) emailDisplay.innerText = "Logged in as: " + user.email;

                    gsap.to('#login-screen', {
                        opacity: 0,
                        duration: 0.5,
                        onComplete: () => {
                            document.getElementById('login-screen').classList.add('hidden');
                            document.getElementById('app-container').classList.remove('hidden');
                            gsap.from('#app-container', { opacity: 0, y: 20 });
                        }
                    });

                    const avatarEl = document.getElementById('user-avatar-small');
                    const iconContainerEl = document.getElementById('settings-icon-container');

                    if (avatarEl && user.photoURL) {
                        avatarEl.src = user.photoURL;
                        avatarEl.classList.remove('hidden');
                    }
                    if (iconContainerEl) iconContainerEl.classList.add('hidden');

                    const statusEl = document.getElementById('cloud-status');
                    if (statusEl) statusEl.innerText = "Syncing...";

                    loadData(user.uid);

// ✅ حساب مساحة التخزين المستخدمة
setTimeout(() => {
    calculateUserStorage().then(() => {
        updateStorageUI();
    });
}, 1500); // انتظار 1.5 ثانية لضمان تحميل البيانات
                } else if (!localStorage.getItem('hm_guest')) {
                    document.getElementById('login-screen').classList.remove('hidden');
                } else {
                    const emailDisplay = document.getElementById('user-email-display');
                    if (emailDisplay) emailDisplay.innerText = "Guest Mode (Local Only)";

                    const statusEl = document.getElementById('cloud-status');
                    if (statusEl) statusEl.innerText = "Not Synced";
                }
            });
        }

        async function saveData() {
    if (currentUser && db) {
        try {
            const userDocRef = doc(db, "artifacts", appId, "users", currentUser.uid);
            
            // 1. تجهيز البيانات المقسمة
            const profileData = { settings: window.appData.settings, stats: window.appData.stats };
            const tasksData = { tasks: window.appData.tasks };
            const notesData = { notes: window.appData.notes };
            const eduData = { courses: window.appData.courses, books: window.appData.books };

            // 2. إرسال البيانات بشكل متوازي (Parallel) لـ 4 مستندات مختلفة
            await Promise.all([
                setDoc(doc(userDocRef, "data", "profile"), profileData),
                setDoc(doc(userDocRef, "data", "tasks"), tasksData),
                setDoc(doc(userDocRef, "data", "notes"), notesData),
                setDoc(doc(userDocRef, "data", "edu"), eduData)
            ]);

            const statusEl = document.getElementById('cloud-status');
            if (statusEl) {
                statusEl.innerText = "Synced";
                statusEl.classList.remove('text-red-400');
                statusEl.classList.add('text-green-400');
            }
        } catch (e) {
            console.error("Save Error:", e);
            showToast("❌ Cloud Save Failed: " + e.message);
        }
    }
}

        async function loadData(uid) {
    if (!db) return;

    // الاستماع للمجموعة الفرعية "data" بالكامل لجلب الملفات الأربعة
    const dataCollectionRef = collection(db, "artifacts", appId, "users", uid, "data");

    onSnapshot(dataCollectionRef, (snapshot) => {
        if (!snapshot.empty) {
            snapshot.forEach(doc => {
                const data = doc.data();
                // دمج البيانات القادمة مع البيانات الحالية
                window.appData = { ...window.appData, ...data };
            });

            // التأكد من وجود المصفوفات الأساسية بعد الدمج
            if (!window.appData.notes) window.appData.notes = [];
            if (!window.appData.tasks) window.appData.tasks = [];
            if (!window.appData.courses) window.appData.courses = [];
            if (!window.appData.books) window.appData.books = [];
            if (!window.appData.stats) window.appData.stats = { historicXP: 0 };

            // حفظ نسخة محلية وتحديث الواجهة
            localStorage.setItem('hm_data', JSON.stringify(window.appData));
            refreshAllUI();

            const statusEl = document.getElementById('cloud-status');
            if (statusEl) {
                statusEl.innerText = "Synced";
                statusEl.classList.remove('text-red-400');
                statusEl.classList.add('text-green-400');
            }
        } else {
            // مستخدم جديد: قم بإنشاء الهيكل الأولي
            saveData();
        }
    });
}

        window.triggerCloudSave = saveData;
    </script>

    <script>
        window.appData = {
            courses: [],
            tasks: [],
            books: [],
            notes: [],
            settings: { theme: 'dark', lang: 'en', accent: '#6366f1' },
            stats: { historicXP: 0 }
        };

        window.enterAsGuest = function () {
            localStorage.setItem('hm_guest', 'true');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            refreshAllUI();
            showPage('courses');
        };

        window.toggleSidebar = function () {
            const sb = document.getElementById('desktop-sidebar');
            if (sb.classList.contains('sidebar-collapsed')) {
                sb.classList.remove('sidebar-collapsed');
            } else {
                sb.classList.add('sidebar-collapsed');
            }
        };

        window.showPage = function (pageId) {
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            document.querySelectorAll(`button[onclick="showPage('${pageId}')"]`).forEach(el => el.classList.add('active'));


            const activePage = document.querySelector('.page-section:not(.hidden)');
            const nextPage = document.getElementById(`page-${pageId}`);

            // Handle Background Switching
            const azkarBg = document.getElementById('azkar-bg');
            const nebulaBg = document.querySelector('.nebula-bg');
            const orbs = document.querySelectorAll('.nebula-orb');

            if (pageId === 'azkar') {
                azkarBg.style.opacity = '1';
                nebulaBg.style.opacity = '0';
                orbs.forEach(orb => orb.style.opacity = '0');
            } else {
                azkarBg.style.opacity = '0';
                nebulaBg.style.opacity = '1';
                orbs.forEach(orb => orb.style.opacity = '0.4');
            }

            if (activePage === nextPage) return;

            if (pageId === 'courses') renderCourses();
            if (pageId === 'tasks') renderTasks();
            if (pageId === 'books') renderBooks();
            if (pageId === 'notes') renderNotes();
            if (pageId === 'trash') renderTrash();
            if (pageId === 'azkar') renderAzkarList();

            const tl = gsap.timeline();

            if (activePage) {
                tl.to(activePage, {
                    scale: 1.05,
                    opacity: 0,
                    filter: "blur(10px)",
                    duration: 0.25,
                    ease: "power2.in",
                    onComplete: () => {
                        activePage.classList.add('hidden');
                        gsap.set(activePage, { clearProps: "all" });
                    }
                });
            }

            if (nextPage) {
                nextPage.classList.remove('hidden');
                tl.fromTo(nextPage,
                    { scale: 0.95, opacity: 0, filter: "blur(15px)", y: 30 },
                    { scale: 1, opacity: 1, filter: "blur(0px)", y: 0, duration: 0.4, ease: "power2.out" },
                    "-=0.1"
                );

                const children = nextPage.querySelectorAll('.stagger-entry');
                if (children.length > 0) {
                    tl.fromTo(children,
                        { y: 20, opacity: 0 },
                        { y: 0, opacity: 1, stagger: 0.04, duration: 0.35, ease: "power2.out" },
                        "-=0.25"
                    );
                }
            }
        };

        function renderCourses() {
            const list = document.getElementById('courses-list');
            list.innerHTML = '';

            const courses = window.appData.courses.filter(c => !c.deleted);

            courses.forEach((c, index) => {
                const percent = c.total > 0 ? Math.round((c.done / c.total) * 100) : 0;
                const filesBadge = c.files && c.files.length > 0
                    ? `<div class="text-[10px] text-blue-400 mb-1 flex items-center gap-1">
                         <i class="fas fa-paperclip" aria-hidden="true"></i> ${c.files.length} Files
                       </div>`
                    : '';

                const card = document.createElement('div');
                card.className = 'glass-card stagger-entry p-5 rounded-3xl relative overflow-hidden group cursor-pointer transition-all';
                card.style.animationDelay = `${0.2 + (index * 0.05)}s`;
                card.dataset.id = c.id;
                card.setAttribute('role', 'listitem');
                card.onclick = () => openEditModal('course', c.id);

                card.innerHTML = `
                    <div class="absolute top-3 end-3 flex gap-2 z-10">
                        <button class="delete-btn-preview p-2 rounded-full bg-black/40 text-red-400 hover:bg-red-500 hover:text-white" 
                                onclick="moveToTrash('course', '${c.id}', event)" 
                                aria-label="Delete course">
                            <i class="fas fa-trash-alt" aria-hidden="true"></i>
                        </button>
                        <div class="drag-handle p-2 rounded-full bg-black/40 text-white cursor-grab" aria-label="Drag to reorder">
                            <i class="fas fa-grip-vertical" aria-hidden="true"></i>
                        </div>
                    </div>
                    <h3 class="font-bold text-lg text-white mb-1 me-12">${escapeHtml(c.name)}</h3>
                    ${filesBadge}
                    <div class="w-full bg-slate-700/50 h-1.5 rounded-full overflow-hidden mb-2">
                        <div class="h-full accent-bg transition-all duration-1000" 
                             style="width:${percent}%; background:var(--accent-color)"
                             role="progressbar" 
                             aria-valuenow="${percent}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"></div>
                    </div>
                    <div class="flex justify-between text-xs text-slate-400">
                        <span><i class="fas fa-clock me-1" aria-hidden="true"></i> ${c.done} / ${c.total} Hrs</span>
                        <span class="font-bold text-accent">${percent}%</span>
                    </div>
                `;

                list.appendChild(card);
            });
        }

        function renderBooks() {
            const list = document.getElementById('books-list');
            list.innerHTML = '';

            const books = window.appData.books.filter(b => !b.deleted);

            books.forEach((b, index) => {
                const percent = b.total > 0 ? Math.round((b.done / b.total) * 100) : 0;
                const filesBadge = b.files && b.files.length > 0
                    ? `<div class="text-[10px] text-blue-400 mb-1 flex items-center gap-1">
                         <i class="fas fa-paperclip" aria-hidden="true"></i> ${b.files.length} Files
                       </div>`
                    : '';

                const card = document.createElement('div');
                card.className = 'glass-card stagger-entry p-5 rounded-3xl group cursor-pointer transition-all';
                card.style.animationDelay = `${0.2 + (index * 0.05)}s`;
                card.dataset.id = b.id;
                card.setAttribute('role', 'listitem');
                card.onclick = () => openEditModal('book', b.id);

                card.innerHTML = `
                    <div class="absolute top-3 end-3 flex gap-2 z-10">
                        <button class="delete-btn-preview p-2 rounded-full bg-black/40 text-red-400 hover:bg-red-500 hover:text-white" 
                                onclick="moveToTrash('book', '${b.id}', event)"
                                aria-label="Delete book">
                            <i class="fas fa-trash-alt" aria-hidden="true"></i>
                        </button>
                        <div class="drag-handle p-2 rounded-full bg-black/40 text-white cursor-grab" aria-label="Drag to reorder">
                            <i class="fas fa-grip-vertical" aria-hidden="true"></i>
                        </div>
                    </div>
                    <div class="flex justify-between items-start mb-2">
                        <div class="w-10 h-14 bg-slate-800 rounded flex items-center justify-center text-white/30">
                            <i class="fas fa-book" aria-hidden="true"></i>
                        </div>
                        <div class="text-right mt-6">
                            <div class="text-xl font-bold accent-text" style="color:var(--accent-color)">${b.streak || 0}🔥</div>
                        </div>
                    </div>
                    <h3 class="font-bold text-white me-8">${escapeHtml(b.name)}</h3>
                    ${filesBadge}
                    <div class="w-full bg-slate-700 h-1 mt-2 rounded-full overflow-hidden">
                        <div class="h-full accent-bg transition-all duration-1000" 
                             style="width:${percent}%; background:var(--accent-color)"
                             role="progressbar" 
                             aria-valuenow="${percent}" 
                             aria-valuemin="0" 
                             aria-valuemax="100"></div>
                    </div>
                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                        <span>${b.done} / ${b.total} Pgs</span>
                        <span>${percent}%</span>
                    </div>
                    <button onclick="readBookToday(${b.id}, event)" 
                            class="w-full mt-3 py-1.5 rounded-lg bg-white/5 text-xs text-white hover:bg-white/10 active:bg-white/20"
                            aria-label="Mark as read today">
                        Mark Read Today
                    </button>
                `;

                list.appendChild(card);
            });
        }

        function renderTasks() {
            const mainList = document.getElementById('tasks-list-main');
            const optList = document.getElementById('tasks-list-optional');
            mainList.innerHTML = '';
            optList.innerHTML = '';

            const generateTaskHTML = (t, index) => {
                const completedClass = t.completed ? 'opacity-50 grayscale' : '';
                const checkboxClass = t.completed ? 'accent-bg border-transparent' : '';
                const checkboxStyle = t.completed ? 'background:var(--accent-color)' : '';
                const checkIcon = t.completed ? '<i class="fas fa-check text-white text-[10px]" aria-hidden="true"></i>' : '';
                const textDecoration = t.completed ? 'line-through' : '';

                const badges = [];
                if (t.files && t.files.length > 0) badges.push('<i class="fas fa-paperclip text-blue-400 text-xs" aria-hidden="true"></i>');
                if (t.drawing) badges.push('<i class="fas fa-palette text-pink-400 text-xs" aria-hidden="true"></i>');
                if (t.audioNote) badges.push('<i class="fas fa-microphone text-red-400 text-xs" aria-hidden="true"></i>');

                const card = document.createElement('div');
                card.className = `glass-card stagger-entry p-4 rounded-2xl flex items-center gap-4 ${completedClass} transition-all relative group`;
                card.style.animationDelay = `${0.2 + (index * 0.05)}s`;
                card.dataset.id = t.id;
                card.setAttribute('role', 'listitem');

                card.innerHTML = `
                    <button onclick="toggleTask(${t.id}, event)" 
                            class="w-6 h-6 rounded-full border-2 border-slate-500 flex items-center justify-center ${checkboxClass} z-10" 
                            style="${checkboxStyle}"
                            aria-label="${t.completed ? 'Mark as incomplete' : 'Mark as complete'}"
                            aria-pressed="${t.completed}">
                        ${checkIcon}
                    </button>
                    <div class="flex-1" onclick="openEditModal('task', '${t.id}')">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-white ${textDecoration}">${escapeHtml(t.name)}</h4>
                            <div class="flex gap-2">${badges.join('')}</div>
                        </div>
                        <p class="text-xs text-slate-400 line-clamp-1">${escapeHtml(t.desc || '')}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="delete-btn-preview p-2 text-red-400 hover:text-white" 
                                onclick="moveToTrash('task', '${t.id}', event)"
                                aria-label="Delete task">
                            <i class="fas fa-trash-alt" aria-hidden="true"></i>
                        </button>
                        <div class="drag-handle p-2 text-slate-500 hover:text-white cursor-grab" aria-label="Drag to reorder">
                            <i class="fas fa-grip-vertical" aria-hidden="true"></i>
                        </div>
                    </div>
                `;

                return card;
            };

            let mainIndex = 0;
            let optIndex = 0;

            window.appData.tasks.filter(t => !t.deleted).forEach(t => {
                if (t.optional) {
                    optList.appendChild(generateTaskHTML(t, optIndex++));
                } else {
                    mainList.appendChild(generateTaskHTML(t, mainIndex++));
                }
            });
        }

        function renderNotes() {
            const list = document.getElementById('notes-list');
            list.innerHTML = '';

            const notes = window.appData.notes.filter(n => !n.deleted);

            notes.forEach((n, index) => {
                const badges = [];
                if (n.audioNote) badges.push('<div class="w-6 h-6 rounded bg-red-500/20 text-red-400 flex items-center justify-center text-xs"><i class="fas fa-microphone" aria-hidden="true"></i></div>');
                if (n.drawing) badges.push('<div class="w-6 h-6 rounded bg-pink-500/20 text-pink-400 flex items-center justify-center text-xs"><i class="fas fa-palette" aria-hidden="true"></i></div>');
                if (n.files && n.files.length > 0) badges.push('<div class="w-6 h-6 rounded bg-blue-500/20 text-blue-400 flex items-center justify-center text-xs"><i class="fas fa-paperclip" aria-hidden="true"></i></div>');

                const emptyBadge = badges.length === 0 ? '<div class="text-[10px] text-slate-600 mt-2">Text only</div>' : '';

                const card = document.createElement('div');
                card.className = 'glass-card stagger-entry p-5 rounded-3xl relative group cursor-pointer flex flex-col h-full min-h-[160px]';
                card.style.animationDelay = `${0.2 + (index * 0.05)}s`;
                card.setAttribute('role', 'listitem');
                card.onclick = () => openEditModal('note', n.id);

                card.innerHTML = `
                    <div class="absolute top-3 end-3 flex gap-2 z-10">
                        <button class="delete-btn-preview p-2 rounded-full bg-black/40 text-red-400 hover:bg-red-500 hover:text-white" 
                                onclick="moveToTrash('note', '${n.id}', event)" 
                                aria-label="Delete note">
                            <i class="fas fa-trash-alt" aria-hidden="true"></i>
                        </button>
                    </div>
                    <h3 class="font-bold text-lg text-white mb-2 line-clamp-1 pe-10">${escapeHtml(n.name)}</h3>
                    <div class="text-sm text-slate-400 mb-4 line-clamp-3 flex-1 whitespace-pre-wrap">${escapeHtml(n.desc)}</div>
                    <div class="flex gap-2 mt-auto border-t border-white/5 pt-3">
                        ${badges.join('')}
                    </div>
                    ${emptyBadge}
                `;

                list.appendChild(card);
            });
        }

        function renderTrash() {
            const list = document.getElementById('trash-list');
            list.innerHTML = '';

            const allTrash = [
                ...window.appData.courses.filter(x => x.deleted).map(x => ({ ...x, type: 'course', icon: 'fa-graduation-cap' })),
                ...window.appData.books.filter(x => x.deleted).map(x => ({ ...x, type: 'book', icon: 'fa-book' })),
                ...window.appData.tasks.filter(x => x.deleted).map(x => ({ ...x, type: 'task', icon: 'fa-check-circle' })),
                ...window.appData.notes.filter(x => x.deleted).map(x => ({ ...x, type: 'note', icon: 'fa-sticky-note' }))
            ];

            if (allTrash.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-500 py-10">Trash is empty</div>';
                return;
            }

            allTrash.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'glass-card stagger-entry p-4 rounded-2xl flex items-center justify-between';
                card.style.animationDelay = `${0.2 + (index * 0.05)}s`;
                card.setAttribute('role', 'listitem');

                card.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center text-slate-400">
                            <i class="fas ${item.icon}" aria-hidden="true"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-white">${escapeHtml(item.name)}</h4>
                            <p class="text-[10px] text-slate-500 uppercase">${item.type}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="restoreFromTrash('${item.type}', ${item.id})" 
                                class="p-2 text-green-400 hover:bg-green-500/10 rounded-lg" 
                                title="Restore"
                                aria-label="Restore ${item.type}">
                            <i class="fas fa-undo" aria-hidden="true"></i>
                        </button>
                        <button onclick="permanentDelete('${item.type}', ${item.id})" 
                                class="p-2 text-red-400 hover:bg-red-500/10 rounded-lg" 
                                title="Delete Forever"
                                aria-label="Delete ${item.type} permanently">
                            <i class="fas fa-times" aria-hidden="true"></i>
                        </button>
                    </div>
                `;

                list.appendChild(card);
            });
        }

        const alarmSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
        /* ==========================================
   TIMER & COUNTER LOGIC (BACKGROUND SAFE)
   ========================================== */

let timerInterval = null;
let timerStartTime = null; // الوقت الحقيقي لبداية العد
let timerElapsedSeconds = 0; // الثواني المنقضية
let timerTarget = 0;
let timerMode = 'stopwatch';
let timerRunning = false;
let timerPausedAt = 0; // متى تم الإيقاف

// دالة حساب الوقت الحقيقي (لا تتأثر بالخلفية)
function getRealElapsedTime() {
    if (!timerRunning || !timerStartTime) return timerElapsedSeconds;
    
    const now = Date.now();
    const elapsed = Math.floor((now - timerStartTime) / 1000);
    
    if (timerMode === 'timer') {
        return Math.max(0, timerTarget - elapsed);
    } else {
        return timerElapsedSeconds + elapsed;
    }
}

// دالة التحديث (تعمل كل 100ms بدلاً من 1000ms)
function updateTimerDisplay() {
    if (!timerRunning) return;
    
    const currentSeconds = getRealElapsedTime();
    updateDigitDisplay(currentSeconds);
    updateTimerRing();
    
    // فحص انتهاء المؤقت
    if (timerMode === 'timer' && currentSeconds <= 0) {
        window.stopTimer();
        
        // تشغيل الصوت مرتين
        const beep1 = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
        beep1.play();
        setTimeout(() => {
            const beep2 = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
            beep2.play();
        }, 300);
        
        if (navigator.vibrate) {
            navigator.vibrate([200, 100, 200, 100, 200]);
        }
        
        showToast("⏰ time ended!", 'success');
    }
}

window.startTimer = function () {
    const inputWrapper = document.getElementById('timer-input-wrapper');

    if (timerMode === 'timer' && !timerRunning && timerElapsedSeconds === 0) {
        const mins = parseInt(document.getElementById('timer-input').value) || 25;
        timerTarget = mins * 60;
        timerElapsedSeconds = 0;
        inputWrapper.classList.add('hidden');
    }

    // حفظ وقت البدء الحقيقي
    timerStartTime = Date.now();
    timerRunning = true;
    
    const iconEl = document.getElementById('icon-timer-toggle');
    iconEl.className = 'fas fa-pause';
    document.getElementById('timer-digits').classList.add('animate-pulse');

    // تحديث كل 100ms بدلاً من 1000ms (أكثر دقة)
    timerInterval = setInterval(updateTimerDisplay, 100);
    
    updateTimerDisplay(); // تحديث فوري
};

window.stopTimer = function () {
    if (!timerRunning) return;
    
    // حفظ الوقت المنقضي قبل الإيقاف
    timerElapsedSeconds = getRealElapsedTime();
    timerStartTime = null;
    timerRunning = false;
    
    clearInterval(timerInterval);
    
    const iconEl = document.getElementById('icon-timer-toggle');
    iconEl.className = 'fas fa-play pl-1';
    document.getElementById('timer-digits').classList.remove('animate-pulse');
};

window.resetTimer = function () {
    window.stopTimer();
    timerElapsedSeconds = 0;
    timerStartTime = null;
    
    if (timerMode === 'timer') {
        document.getElementById('timer-input-wrapper').classList.remove('hidden');
    }
    
    updateDigitDisplay(0);
    updateTimerRing();
};

window.toggleTimer = function () {
    if (timerRunning) {
        window.stopTimer();
    } else {
        window.startTimer();
    }
};

window.switchTimerMode = function () {
    window.stopTimer();
    timerMode = timerMode === 'stopwatch' ? 'timer' : 'stopwatch';
    timerElapsedSeconds = 0;

    const label = document.getElementById('timer-mode-label');
    const inputWrapper = document.getElementById('timer-input-wrapper');
    const progress = document.getElementById('timer-progress');

    if (timerMode === 'timer') {
        label.innerText = "TIMER (COUNTDOWN)";
        inputWrapper.classList.remove('hidden');
        progress.style.stroke = "url(#gradientTimer)";
    } else {
        label.innerText = "STOPWATCH";
        inputWrapper.classList.add('hidden');
        progress.style.strokeDashoffset = 0;
    }

    updateDigitDisplay(0);
};

// استمع لتغيير حالة الصفحة (عند العودة من الخلفية)
document.addEventListener('visibilitychange', () => {
    if (!document.hidden && timerRunning) {
        // الصفحة عادت للواجهة، قم بالتحديث الفوري
        updateTimerDisplay();
    }
});

// دالة تحديث الأرقام (بدون تغيير)
function updateDigitDisplay(totalSeconds) {
    const m = Math.floor(totalSeconds / 60);
    const s = totalSeconds % 60;

    const mStr = m.toString().padStart(2, '0');
    const sStr = s.toString().padStart(2, '0');

    updateSingleDigit('digit-m1', mStr[0]);
    updateSingleDigit('digit-m2', mStr[1]);
    updateSingleDigit('digit-s1', sStr[0]);
    updateSingleDigit('digit-s2', sStr[1]);

    const widgetTimer = document.getElementById('widget-timer-val');
    if (widgetTimer) widgetTimer.innerText = `${mStr}:${sStr}`;
}

function updateSingleDigit(id, newVal) {
    const el = document.getElementById(id);
    if (el && el.innerText !== newVal) {
        gsap.to(el, {
            scaleY: 0,
            duration: 0.15,
            onComplete: () => {
                el.innerText = newVal;
                gsap.to(el, { scaleY: 1, duration: 0.15, ease: "back.out(1.7)" });
            }
        });
    }
}

function updateTimerRing() {
    const circle = document.getElementById('timer-progress');
    if (!circle) return;
    
    const radius = circle.r.baseVal.value;
    const circumference = radius * 2 * Math.PI;

    if (timerMode === 'timer' && timerTarget > 0) {
        const currentSeconds = getRealElapsedTime();
        const offset = circumference - ((currentSeconds / timerTarget) * circumference);
        circle.style.strokeDashoffset = offset;
    } else {
        circle.style.strokeDashoffset = 0;
    }
}

        /* --- TALLY COUNTER LOGIC --- */
        let tallyCount = 0;
        let tallyDir = 1; // 1 for Up, -1 for Down

        window.clickTally = function () {
            tallyCount += tallyDir;
            if (tallyCount < 0) tallyCount = 0;

            const display = document.getElementById('tally-display');

            // 1. Text Animation (Rolling Number)
            gsap.to(display, {
                scale: 1.5,
                duration: 0.1,
                y: -10,
                onComplete: () => {
                    display.innerText = tallyCount;
                    gsap.to(display, { scale: 1, y: 0, duration: 0.3, ease: "bounce.out" });
                }
            });

            // 2. Ripple Effect Logic
            const btn = document.getElementById('tally-btn');
            const circle = document.createElement('div');
            const diameter = Math.max(btn.clientWidth, btn.clientHeight);

            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = '50%';
            circle.style.top = '50%';
            circle.style.transform = 'translate(-50%, -50%) scale(0)';
            circle.classList.add('absolute', 'rounded-full', 'bg-white/10', 'pointer-events-none');

            document.getElementById('ripple-container').appendChild(circle);

            gsap.to(circle, {
                scale: 2,
                opacity: 0,
                duration: 0.6,
                onComplete: () => circle.remove()
            });

            // 3. Vibrate
            if (navigator.vibrate) navigator.vibrate(30);
        };

        window.resetTally = function () {
            const startVal = parseInt(document.getElementById('tally-start-val').value) || 0;
            tallyCount = startVal;
            document.getElementById('tally-display').innerText = tallyCount;
        };

        window.setTallyMode = function (mode) {
            const btn = document.getElementById('btn-tally-dir');
            if (tallyDir === 1) {
                tallyDir = -1;
                btn.innerHTML = '<i class="fas fa-arrow-down mr-2"></i> Down';
                btn.classList.replace('text-indigo-400', 'text-pink-400');
            } else {
                tallyDir = 1;
                btn.innerHTML = '<i class="fas fa-arrow-up mr-2"></i> Up';
                btn.classList.replace('text-pink-400', 'text-indigo-400');
            }
        };

        const defaultApiKey = "AIzaSyDJ-gs1xu1lxAu7MRHMQ2t-oBnuuhTq5Ms";
        let tempAudioBase64 = null;
        let tempDrawingData = null;
        let tempFiles = [];

        // دالة الإشعار الجديدة
window.showToast = function(msg, type = 'neutral') {
    const div = document.createElement('div');
    div.className = `custom-toast ${type}`;
    
    let icon = '<i class="fas fa-info-circle text-blue-400"></i>';
    if (type === 'error') icon = '<i class="fas fa-exclamation-circle text-red-400"></i>';
    if (type === 'success') icon = '<i class="fas fa-check-circle text-green-400"></i>';

    // دعم النص متعدد الأسطر
    const formattedMsg = msg.replace(/\n/g, '<br>');
    
    div.innerHTML = `${icon} <span style="line-height: 1.5;">${formattedMsg}</span>`;
    document.body.appendChild(div);

    requestAnimationFrame(() => {
        div.classList.add('show');
    });

    setTimeout(() => {
        div.classList.remove('show');
        setTimeout(() => div.remove(), 400);
    }, 4000); // زودت الوقت من 3 لـ 4 ثواني للرسائل الطويلة
};

        window.onload = () => {
            try {
                const localData = localStorage.getItem('hm_data');
                if (localData) {
                    try {
                        window.appData = JSON.parse(localData);
                    } catch (e) {
                        console.error("Data parse error", e);
                    }
                }

                ['courses', 'tasks', 'books', 'notes'].forEach(cat => {
                    if (!window.appData[cat]) window.appData[cat] = [];

                    window.appData[cat].forEach(x => {
                        if (typeof x.deleted === 'undefined') x.deleted = false;
                        if (!x.files) x.files = [];
                        if (cat === 'tasks' && typeof x.optional === 'undefined') x.optional = false;
                    });
                });

                if (!window.appData.stats) window.appData.stats = { historicXP: 0 };

                const splashTl = gsap.timeline({
                    delay: 0.3,
                    onComplete: () => {
                        document.getElementById("splash-screen").style.display = 'none';
                    }
                });

                const sketchPaths = document.querySelectorAll('.sketch-path');
                sketchPaths.forEach(path => {
                    const length = path.getTotalLength();
                    gsap.set(path, {
                        strokeDasharray: length,
                        strokeDashoffset: length
                    });
                });

                splashTl.to(sketchPaths, {
                    strokeDashoffset: 0,
                    duration: 1.5,
                    ease: "power2.inOut",
                    stagger: 0.3
                });

                splashTl.to("#sketch-svg", {
                    opacity: 0,
                    duration: 0.5,
                    ease: "power2.in"
                }, "+=0.1");

                splashTl.fromTo("#final-svg",
                    { opacity: 0, scale: 0.9 },
                    { opacity: 1, scale: 1.05, duration: 0.6, ease: "back.out(2)" },
                    "<"
                );

                splashTl.to("#final-svg", {
                    scale: 1,
                    duration: 0.3,
                    ease: "power2.inOut"
                }, ">-0.2");

                splashTl.to("#splash-title, #splash-subtitle", {
                    y: 0,
                    opacity: 1,
                    duration: 0.8,
                    stagger: 0.2,
                    ease: "power3.out"
                }, "-=0.4");

                splashTl.to("#splash-screen", {
                    opacity: 0,
                    duration: 0.8,
                    ease: "power2.inOut",
                    delay: 0.8
                });

                applyTheme(window.appData.settings.theme);
                applyLanguage(window.appData.settings.lang);
                applyAccentColor(window.appData.settings.accent || '#6366f1');

                if (localStorage.getItem('hm_guest')) {
                    window.enterAsGuest();
                } else if (!window.authObj && !localStorage.getItem('hm_data')) {
                    document.getElementById('login-screen').classList.remove('hidden');
                }

                refreshAllUI();

                if (window.Sortable) initSortables();

                document.addEventListener('mousemove', (e) => {
                    document.querySelectorAll('.glass-card').forEach(card => {
                        const rect = card.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;

                        card.style.setProperty('--mouse-x', `${x}px`);
                        card.style.setProperty('--mouse-y', `${y}px`);

                        if (x >= 0 && x <= rect.width && y >= 0 && y <= rect.height) {
                            const centerX = rect.width / 2;
                            const centerY = rect.height / 2;
                            const rotateX = ((y - centerY) / centerY) * -3;
                            const rotateY = ((x - centerX) / centerX) * 3;

                            gsap.to(card, {
                                rotationX: rotateX,
                                rotationY: rotateY,
                                scale: 1.01,
                                duration: 0.2,
                                ease: "power1.out"
                            });
                        } else {
                            gsap.to(card, {
                                rotationX: 0,
                                rotationY: 0,
                                scale: 1,
                                duration: 0.5,
                                ease: "elastic.out(1, 0.5)"
                            });
                        }
                    });
                });
            } catch (err) {
                console.error("Init Error:", err);
            }
        };
        // متغير لتخزين الوظيفة التي سيتم تنفيذها عند الموافقة
        let pendingConfirmAction = null;

        // دالة لفتح مودال التأكيد
        window.openConfirmModal = function (message, actionCallback) {
            const msgEl = document.getElementById('confirm-modal-msg');
            if (msgEl) msgEl.innerText = message;

            // تخزين الوظيفة لاستدعائها لاحقاً
            pendingConfirmAction = actionCallback;

            // فتح المودال باستخدام الأنيميشن الموجود لديك مسبقاً
            window.openGenieModal('confirm-modal');
        };

        // دالة تنفيذ الإجراء عند الضغط على زر Confirm
        window.executeConfirmAction = async function () {
            if (pendingConfirmAction) {
                await pendingConfirmAction(); // تنفيذ الوظيفة
            }
            window.closeAllModals(); // إغلاق المودال
            pendingConfirmAction = null; // تصفير المتغير
        };
        const magneticBtns = document.querySelectorAll('.add-trigger-btn, .floating-ai-btn');
        magneticBtns.forEach(btn => {
            btn.addEventListener('mousemove', (e) => {
                const rect = btn.getBoundingClientRect();
                const x = e.clientX - (rect.left + rect.width / 2);
                const y = e.clientY - (rect.top + rect.height / 2);

                gsap.to(btn, {
                    x: x * 0.5,
                    y: y * 0.5,
                    duration: 0.3,
                    ease: "power2.out"
                });
            });

            btn.addEventListener('mouseleave', () => {
                gsap.to(btn, {
                    x: 0,
                    y: 0,
                    duration: 0.8,
                    ease: "elastic.out(1, 0.3)"
                });
            });
        });

        function getApiKey() {
            return localStorage.getItem('hm_api_key') || defaultApiKey;
        }

        function initSortables() {
            ['courses-list', 'books-list'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    new Sortable(el, {
                        handle: '.drag-handle',
                        animation: 150,
                        ghostClass: 'sortable-ghost',
                        onEnd: function (evt) {
                            const type = id === 'courses-list' ? 'courses' : 'books';
                            updateOrder(type, el);
                        }
                    });
                }
            });

            const mainTasks = document.getElementById('tasks-list-main');
            const optionalTasks = document.getElementById('tasks-list-optional');

            if (mainTasks && optionalTasks) {
                const taskSortableOptions = {
                    group: 'tasks',
                    handle: '.drag-handle',
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: function (evt) {
                        rebuildTaskArray();
                    }
                };

                new Sortable(mainTasks, taskSortableOptions);
                new Sortable(optionalTasks, taskSortableOptions);
            }
        }

        function updateOrder(type, el) {
            const newOrder = [];
            const children = Array.from(el.children);

            children.forEach(child => {
                const itemId = child.getAttribute('data-id');
                const item = window.appData[type].find(x => x.id == itemId);
                if (item) newOrder.push(item);
            });

            const deletedItems = window.appData[type].filter(x => x.deleted);
            window.appData[type] = [...newOrder, ...deletedItems];
            commitData();
        }

        function rebuildTaskArray() {
            const mainContainer = document.getElementById('tasks-list-main');
            const optContainer = document.getElementById('tasks-list-optional');
            const newTasks = [];

            Array.from(mainContainer.children).forEach(child => {
                const id = child.getAttribute('data-id');
                const task = window.appData.tasks.find(x => x.id == id);
                if (task) {
                    task.optional = false;
                    newTasks.push(task);
                }
            });

            Array.from(optContainer.children).forEach(child => {
                const id = child.getAttribute('data-id');
                const task = window.appData.tasks.find(x => x.id == id);
                if (task) {
                    task.optional = true;
                    newTasks.push(task);
                }
            });

            const deletedTasks = window.appData.tasks.filter(x => x.deleted);
            window.appData.tasks = [...newTasks, ...deletedTasks];
            commitData();
            updateWidget();
        }

        const translations = {
            en: {
                // ... (القديم)
                courses: "Courses", tasks: "Tasks", books: "Books", notes: "Notes",
                settings: "Settings", trash: "Trash", timers: "Timers", add: "Add",
                addNote: "Add Note", trackLearning: "Master your skills.",
                manageTasks: "Organize your chaos.", trackReading: "Build your knowledge base.",
                welcome: "Welcome Back", loginSubtitle: "Sync your life progress across dimensions.",
                continueGoogle: "Continue with Google", continueGuest: "Continue Offline (Guest)",
                clock: "Clock", counter: "Counter", stopwatch: "Stopwatch", timer: "Timer",
                tasbih: "Tasbih", countdown: "Countdown", startValue: "Start Value",
                count: "Count", reset: "Reset Counter", assistantTitle: "Assistant",
                assistantStatus: "Agent Mode Active", clear: "Clear",
                aiWelcome: "Hello! I can add tasks, books, or courses for you.",
                nebulaColor: "Nebula Color", customizeAccent: "Customize accent color",
                language: "Language", logout: "Logout", back: "Exit",

                // --- (الجديد: الإضافات) ---
                addCourse: "Add Course", addBook: "Add Book", addTask: "Add Task",
                magicSplit: "Magic Split", bookScout: "Book Scout", syllabusGen: "Syllabus Gen",
                markOptional: "Mark as Optional (Side Quest)",
                totalPages: "Total Pages", readPages: "Read Pages",
                totalHours: "Total Hours", doneHours: "Done Hours",
                voiceNote: "VOICE NOTE", record: "Record", stop: "Stop",
                files: "FILES (PDF, Video, Img)", attach: "Attach",
                drawing: "DRAWING / SKETCH", addDrawing: "Add Drawing", editDrawing: "Edit Drawing",
                save: "Save",
                titlePlaceholder: "Title/Name",
                descPlaceholder: "Description/Notes...",
                aiPlaceholder: "Tell AI to do something...",
                userProgression: "User Progression",
                recentGains: "Recent Gains",
                activeSession: "Active Session",
                dailySnapshot: "Daily Snapshot",
                tasksDone: "Tasks Done",
                remaining: "Remaining",
                dailyProgress: "Daily Progress",
                poweredBy: "Powered By",
                 storageUsage: "Storage Usage",
        filesUploaded: "files uploaded",
        refresh: "Refresh",
        poweredBy: "File storage powered by"
            },
            ar: {
                // ... (القديم)
                courses: "الدورات", tasks: "المهام", books: "الكتب", notes: "ملاحظات",
                settings: "الإعدادات", trash: "سلة المهملات", timers: "المؤقتات", add: "إضافة",
                addNote: "إضافة ملاحظة", trackLearning: "أتقن مهاراتك.",
                manageTasks: "نظم فوضى حياتك.", trackReading: "ابنِ قاعدتك المعرفية.",
                welcome: "أهلاً بك", loginSubtitle: "زامن تقدم حياتك.",
                continueGoogle: "المتابعة مع جوجل", continueGuest: "المتابعة كضيف",
                clock: "ساعة", counter: "عداد", stopwatch: "ساعة إيقاف", timer: "مؤقت",
                tasbih: "تسابيح", countdown: "عد تنازلي", startValue: "البداية",
                count: "عد", reset: "تصفير", assistantTitle: "المساعد الذكي",
                assistantStatus: "الوضع النشط", clear: "مسح",
                aiWelcome: "أهلاً! يمكنني إضافة مهام، كتب، أو دورات لك.",
                nebulaColor: "لون الخلفية", customizeAccent: "لون التمييز",
                language: "اللغة", logout: "خروج", back: "رجوع",

                // --- (الجديد: الإضافات) ---
                addCourse: "إضافة دورة", addBook: "إضافة كتاب", addTask: "إضافة مهمة",
                magicSplit: "تقسيم ذكي", bookScout: "مستكشف الكتب", syllabusGen: "مخطط المنهج",
                markOptional: "مهمة جانبية (اختياري)",
                totalPages: "إجمالي الصفحات", readPages: "الصفحات المقروءة",
                totalHours: "إجمالي الساعات", doneHours: "الساعات المنجزة",
                voiceNote: "ملاحظة صوتية", record: "تسجيل", stop: "إيقاف",
                files: "ملفات (صور، PDF)", attach: "إرفاق",
                drawing: "رسم / سكتش", addDrawing: "إضافة رسم", editDrawing: "تعديل الرسم",
                save: "حفظ",
                titlePlaceholder: "العنوان / الاسم",
                descPlaceholder: "الوصف / الملاحظات...",
                aiPlaceholder: "اطلب من الذكاء الاصطناعي شيئاً...",
                userProgression: "تقدم المستوى",
                recentGains: "المكتسبات الأخيرة",
                activeSession: "جلسة نشطة",
                dailySnapshot: "ملخص اليوم",
                tasksDone: "المهام المنجزة",
                remaining: "المتبقي",
                dailyProgress: "التقدم اليومي",
                poweredBy: "مشغل بواسطة",
                storageUsage: "مساحة التخزين",
        filesUploaded: "ملف مرفوع",
        refresh: "تحديث",
        poweredBy: "التخزين بواسطة"
            }
        };
        let genieOriginRect = null;

        window.openAddModal = function (type, event) {
            if (event && event.currentTarget) {
                genieOriginRect = event.currentTarget.getBoundingClientRect();
            } else {
                genieOriginRect = {
                    left: window.innerWidth / 2,
                    top: window.innerHeight - 50,
                    width: 0,
                    height: 0
                };
            }

            resetModalInputs();
            document.getElementById('modal-type').value = type;

            let titleText = 'Add Item';
            if (type === 'course') titleText = 'Add Course';
            if (type === 'task') titleText = 'Add Task';
            if (type === 'book') titleText = 'Add Book';
            if (type === 'note') titleText = 'Add Note';
            document.getElementById('modal-title').innerText = titleText;

            const statsRow = document.getElementById('modal-stats-row');
            const optionalRow = document.getElementById('modal-optional-row');
            const aiArea = document.getElementById('ai-suggestion-area');
            const btnTask = document.getElementById('btn-ai-task');
            const btnBook = document.getElementById('btn-ai-book');
            const btnCourse = document.getElementById('btn-ai-course');

            statsRow.classList.add('hidden');
            optionalRow.classList.add('hidden');
            aiArea.classList.add('hidden');
            btnTask.classList.add('hidden');
            btnBook.classList.add('hidden');
            btnCourse.classList.add('hidden');

            if (type === 'task') {
                optionalRow.classList.remove('hidden');
                aiArea.classList.remove('hidden');
                btnTask.classList.remove('hidden');
            } else if (type === 'note') {
            } else {
                statsRow.classList.remove('hidden');
                const lblTotal = document.getElementById('lbl-total');
                const lblDone = document.getElementById('lbl-done');

                if (type === 'book') {
                    lblTotal.innerText = "Total Pages";
                    lblDone.innerText = "Read Pages";
                    aiArea.classList.remove('hidden');
                    btnBook.classList.remove('hidden');
                } else {
                    lblTotal.innerText = "Total Hours";
                    lblDone.innerText = "Done Hours";
                    aiArea.classList.remove('hidden');
                    btnCourse.classList.remove('hidden');
                }
            }

            openGenieModal('generic-modal');
        };

        window.openEditModal = function (type, id) {
            genieOriginRect = null;

            let list = [];
            if (type === 'course') list = window.appData.courses;
            else if (type === 'task') list = window.appData.tasks;
            else if (type === 'book') list = window.appData.books;
            else if (type === 'note') list = window.appData.notes;

            const item = list.find(x => x.id == id);
            if (!item) return;

            resetModalInputs();
            document.getElementById('modal-type').value = type;
            document.getElementById('modal-id').value = id;
            document.getElementById('modal-name').value = item.name;
            document.getElementById('modal-desc').value = item.desc || item.notes || '';
            document.getElementById('modal-title').innerText = 'Edit ' + (type.charAt(0).toUpperCase() + type.slice(1));

            const statsRow = document.getElementById('modal-stats-row');
            const optionalRow = document.getElementById('modal-optional-row');
            const aiArea = document.getElementById('ai-suggestion-area');

            aiArea.classList.add('hidden');
            statsRow.classList.add('hidden');
            optionalRow.classList.add('hidden');

            if (type === 'task') {
                optionalRow.classList.remove('hidden');
                document.getElementById('modal-optional').checked = item.optional || false;
            } else if (type === 'note') {
            } else {
                statsRow.classList.remove('hidden');
                document.getElementById('modal-total').value = item.total;
                document.getElementById('modal-done').value = item.done;

                const lblTotal = document.getElementById('lbl-total');
                const lblDone = document.getElementById('lbl-done');

                if (type === 'book') {
                    lblTotal.innerText = "Total Pages";
                    lblDone.innerText = "Read Pages";
                } else {
                    lblTotal.innerText = "Total Hours";
                    lblDone.innerText = "Done Hours";
                }
            }

            // DUAL STORAGE RESTORE
            window.tempDrawingData = item.drawing || null;
            window.tempDrawingJSON = item.drawingJSON || null;

            if (window.tempDrawingData) {
                document.getElementById('modal-drawing-preview').classList.remove('hidden');
                document.getElementById('modal-drawing-img').src = window.tempDrawingData;
                document.getElementById('btn-draw-label').innerText = "Edit Drawing";
            }

            tempAudioBase64 = item.audioNote || null;
            if (tempAudioBase64) {
                document.getElementById('modal-audio-player-container').classList.remove('hidden');
                document.getElementById('modal-audio-player').src = tempAudioBase64;
            }

            if (item.files && item.files.length > 0) {
                tempFiles = [...item.files];
                renderFilePreview();
            }

            openGenieModal('generic-modal');
        };

        window.openGenieModal = function (modalId) {
            const overlay = document.getElementById('modal-overlay');
            const wrapper = document.getElementById(modalId);
            const content = wrapper.querySelector('.modal-content');

            overlay.classList.remove('hidden', 'opacity-0');
            wrapper.classList.remove('hidden');

            if (genieOriginRect) {
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;

                const buttonCenterX = genieOriginRect.left + (genieOriginRect.width / 2);
                const buttonCenterY = genieOriginRect.top + (genieOriginRect.height / 2);

                const xDist = buttonCenterX - centerX;
                const yDist = buttonCenterY - centerY;

                gsap.fromTo(content,
                    {
                        x: xDist,
                        y: yDist,
                        scaleX: 0.1,
                        scaleY: 0.1,
                        borderRadius: "50%",
                        opacity: 0
                    },
                    {
                        x: 0,
                        y: 0,
                        scaleX: 1,
                        scaleY: 1,
                        borderRadius: "24px",
                        opacity: 1,
                        duration: 0.5,
                        ease: "elastic.out(1, 0.75)",
                        clearProps: "all"
                    }
                );
            } else {
                gsap.fromTo(content,
                    { scale: 0.8, opacity: 0 },
                    { scale: 1, opacity: 1, duration: 0.3, ease: "back.out(1.7)" }
                );
            }
        };

        window.closeAllModals = function () {
            const overlay = document.getElementById('modal-overlay');
            const openWrappers = document.querySelectorAll('.modal-wrapper:not(.hidden)');

            overlay.classList.add('opacity-0');

            openWrappers.forEach(wrapper => {
                const content = wrapper.querySelector('.modal-content');

                if (genieOriginRect && wrapper.id === 'generic-modal') {
                    const centerX = window.innerWidth / 2;
                    const centerY = window.innerHeight / 2;
                    const buttonCenterX = genieOriginRect.left + (genieOriginRect.width / 2);
                    const buttonCenterY = genieOriginRect.top + (genieOriginRect.height / 2);
                    const xDist = buttonCenterX - centerX;
                    const yDist = buttonCenterY - centerY;

                    gsap.to(content, {
                        x: xDist,
                        y: yDist,
                        scaleX: 0.1,
                        scaleY: 0.1,
                        borderRadius: "50%",
                        opacity: 0,
                        duration: 0.3,
                        ease: "power2.in",
                        onComplete: () => {
                            wrapper.classList.add('hidden');
                            gsap.set(content, { clearProps: "all" });
                        }
                    });
                } else {
                    gsap.to(content, {
                        scale: 0.9,
                        opacity: 0,
                        duration: 0.2,
                        onComplete: () => wrapper.classList.add('hidden')
                    });
                }
            });

            setTimeout(() => overlay.classList.add('hidden'), 300);
        };

        window.openModal = (id) => {
            genieOriginRect = null;
            window.openGenieModal(id);
        };

        window.resetModalInputs = function () {
            document.getElementById('modal-id').value = '';
            document.getElementById('modal-name').value = '';
            document.getElementById('modal-desc').value = '';
            document.getElementById('modal-total').value = '';
            document.getElementById('modal-done').value = '';
            document.getElementById('modal-optional').checked = false;

            tempAudioBase64 = null;
            window.tempDrawingData = null;
            window.tempDrawingJSON = null; // Fix: Clear JSON
            tempFiles = [];

            document.getElementById('modal-audio-player-container').classList.add('hidden');
            document.getElementById('modal-audio-player').src = "";
            document.getElementById('modal-drawing-preview').classList.add('hidden');
            document.getElementById('modal-drawing-img').src = "";
            document.getElementById('btn-draw-label').innerText = "Add Drawing";
            renderFilePreview();

            const btns = document.querySelectorAll('.interactive-btn');
            btns.forEach(btn => {
                btn.classList.remove('loading', 'success');
            });
        };

        window.saveItem = async function (btnElement) {
            const name = document.getElementById('modal-name').value;
            if (!name) {
    showToast("Enter the name of the task", 'error');
    return;
}

            if (btnElement) btnElement.classList.add('loading');
            await new Promise(resolve => setTimeout(resolve, 500));

            const type = document.getElementById('modal-type').value;
            const id = document.getElementById('modal-id').value || Date.now();
            const desc = document.getElementById('modal-desc').value;
            const total = document.getElementById('modal-total').value;
            const done = document.getElementById('modal-done').value;

            // === التغيير الجوهري هنا ===
            // نضع الرسم والملفات في الكائن الأساسي ليكون متاحاً لكل الأنواع
            const newItem = {
                id: Number(id),
                name: name,
                desc: desc,
                notes: desc, // للدورات والكتب
                audioNote: tempAudioBase64,
                files: tempFiles,
                // حفظ الرسم هنا مباشرة لضمان عدم ضياعه
                drawing: window.tempDrawingData || null,
                drawingJSON: window.tempDrawingJSON || null,
                deleted: false
            };
            // ===========================

            if (type === 'task') {
                newItem.completed = false;
                newItem.optional = document.getElementById('modal-optional').checked;

                const idx = window.appData.tasks.findIndex(x => x.id == id);
                if (idx > -1) {
                    newItem.completed = window.appData.tasks[idx].completed;
                    window.appData.tasks[idx] = newItem;
                } else {
                    window.appData.tasks.push(newItem);
                }
            } else if (type === 'book') {
                newItem.total = total;
                newItem.done = done;
                newItem.streak = 0;

                const idx = window.appData.books.findIndex(x => x.id == id);
                if (idx > -1) {
                    newItem.streak = window.appData.books[idx].streak;
                    window.appData.books[idx] = newItem;
                } else {
                    window.appData.books.push(newItem);
                }
                if (Number(done) >= Number(total) && Number(total) > 0) triggerConfetti(true);

            } else if (type === 'course') {
                newItem.total = total;
                newItem.done = done;

                const idx = window.appData.courses.findIndex(x => x.id == id);
                if (idx > -1) {
                    window.appData.courses[idx] = newItem;
                } else {
                    window.appData.courses.push(newItem);
                }
                if (Number(done) >= Number(total) && Number(total) > 0) triggerConfetti(true);

            } else if (type === 'note') {
                const idx = window.appData.notes.findIndex(x => x.id == id);
                if (idx > -1) {
                    window.appData.notes[idx] = newItem;
                } else {
                    window.appData.notes.push(newItem);
                }
            }

            commitData();
            refreshAllUI();

            if (btnElement) {
                btnElement.classList.remove('loading');
                btnElement.classList.add('success');
            }

            await new Promise(resolve => setTimeout(resolve, 800));
            window.closeAllModals();
            
            // تنظيف بعد الحفظ
            if (btnElement) btnElement.classList.remove('success');
        };

        window.saveCanvasDrawing = async function (btnElement) {
            if (!fCanvas) {
                window.closeDrawingModal();
                return;
            }
            
            // تشغيل اللودر إذا تم الضغط على زر الحفظ اليدوي
            if (btnElement) btnElement.classList.add('loading');

            // 1. حفظ الخطوات (للتعديل لاحقاً)
            window.tempDrawingJSON = JSON.stringify(fCanvas.toJSON());

            // 2. حفظ الصورة (للعرض)
            window.tempDrawingData = fCanvas.toDataURL({
                format: 'png',
                quality: 0.8, // تقليل الجودة قليلاً لتوفير المساحة
                multiplier: 1
            });

            // تحديث واجهة المودال الرئيسي فوراً
            const previewContainer = document.getElementById('modal-drawing-preview');
            const previewImg = document.getElementById('modal-drawing-img');
            const btnLabel = document.getElementById('btn-draw-label');

            if (previewContainer && previewImg) {
                previewContainer.classList.remove('hidden');
                previewImg.src = window.tempDrawingData;
                if (btnLabel) btnLabel.innerText = "تعديل الرسم";
            }

            // انتظار قصير لجمالية الأنيميشن
            await new Promise(resolve => setTimeout(resolve, 300));

            if (btnElement) {
                btnElement.classList.remove('loading');
                btnElement.classList.add('success');
            }

            // إغلاق النافذة
            setTimeout(() => {
                window.closeDrawingModal();
                if (btnElement) btnElement.classList.remove('success');
            }, 300);
        };

        window.handleFileUpload = async function (input) {
    // 🆕 إضافة 1: رسالة البداية
    console.log("🔵 بدء عملية الرفع...");
    
    const files = Array.from(input.files);
    if (files.length === 0) {
        console.log("❌ لا توجد ملفات"); // 🆕 إضافة 2
        return;
    }

    // 🆕 إضافة 3: عرض عدد الملفات
    console.log(`📁 عدد الملفات: ${files.length}`);

    // 🆕 إضافة 4: فحص تسجيل الدخول مع Logging
    console.log("🔍 فحص تسجيل الدخول...");
    console.log("window.currentUser:", window.currentUser);
    
    if (!window.currentUser) {
        console.error("❌ لم يتم تسجيل الدخول");
        showToast("⚠️ you should sign in", 'error');
        input.value = '';
        return;
    }

    // 🆕 إضافة 5: عرض معلومات المستخدم
    console.log("✅ المستخدم مسجل:", window.currentUser.email);
    console.log("✅ User ID:", window.currentUser.uid);

    // 🆕 إضافة 6: فحص إعدادات Cloudinary
    console.log("🔧 فحص إعدادات Cloudinary...");
    console.log("CLOUDINARY_CONFIG:", window.CLOUDINARY_CONFIG);
    
    if (!window.CLOUDINARY_CONFIG.cloudName || !window.CLOUDINARY_CONFIG.uploadPreset) {
        console.error("❌ إعدادات Cloudinary مفقودة!");
        showToast("❌ Upload settings error", 'error');
        return;
    }

    // 🆕 إضافة 7: حساب وعرض المساحة
    const newFilesSize = files.reduce((sum, file) => sum + file.size, 0);
    const totalAfterUpload = window.userStorageInfo.used + newFilesSize;

    console.log("📊 فحص المساحة:");
    console.log(`   الحالي: ${(window.userStorageInfo.used / 1024 / 1024).toFixed(2)} MB`);
    console.log(`   الملفات الجديدة: ${(newFilesSize / 1024 / 1024).toFixed(2)} MB`);
    console.log(`   الإجمالي بعد: ${(totalAfterUpload / 1024 / 1024).toFixed(2)} MB`);
    console.log(`   الحد الأقصى: ${(USER_STORAGE_LIMIT / 1024 / 1024).toFixed(0)} MB`);

    if (totalAfterUpload > window.USER_STORAGE_LIMIT) {
        const remainingMB = ((USER_STORAGE_LIMIT - window.userStorageInfo.used) / 1024 / 1024).toFixed(2);
        const neededMB = (newFilesSize / 1024 / 1024).toFixed(2);
        
        console.error("❌ تجاوز الحد الأقصى للمساحة");
        showToast(
            `⚠️ Insufficient storage space!\n\n` +
            `remaining: ${remainingMB} MB\n` +
            `needed: ${neededMB} MB\n\n` +
            `Delete some old files first.`,
            'error'
        );
        input.value = '';
        return;
    }

    showToast(`⏳ uploading file${files.length} file...`, 'neutral');

    let successCount = 0;
    let failCount = 0;

    for (const file of files) {
        // 🆕 إضافة 8: معلومات الملف الحالي
        console.log(`\n📤 uploading file : ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);

      

        try {
            // 🆕 إضافة 9: تحديد نوع المورد (هذا الحل للمشكلة رقم 1)
            let resourceType = 'raw';
            
            if (file.type.startsWith('image/')) {
                resourceType = 'image';
            } else if (file.type.startsWith('video/')) {
                resourceType = 'video';
            }
            
            // 🆕 إضافة 10: عرض نوع المورد
            console.log(`📋 نوع المورد: ${resourceType}`);
            console.log(`📋 نوع الملف: ${file.type}`);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', window.CLOUDINARY_CONFIG.uploadPreset);
formData.append('folder', `${window.CLOUDINARY_CONFIG.folder}/${window.currentUser.uid}`);
            
            // 🆕 إضافة 11: الرابط الصحيح (حل المشكلة رقم 1)
            const uploadUrl = `https://api.cloudinary.com/v1_1/${window.CLOUDINARY_CONFIG.cloudName}/${resourceType}/upload`;
            
            // 🆕 إضافة 12: عرض معلومات الطلب
            console.log(`🌐 الرابط: ${uploadUrl}`);
            console.log(`📁 المجلد: ${CLOUDINARY_CONFIG.folder}/${window.currentUser.uid}`);
            console.log("🚀 إرسال الطلب...");

            const response = await fetch(uploadUrl, {
                method: 'POST',
                body: formData
            });

            // 🆕 إضافة 13: عرض استجابة الخادم
            console.log(`📡 استجابة الخادم: ${response.status} ${response.statusText}`);

            if (!response.ok) {
                // 🆕 إضافة 14: قراءة رسالة الخطأ من Cloudinary
                const errorText = await response.text();
                console.error("❌ خطأ من Cloudinary:", errorText);
                throw new Error(`Upload failed: ${response.status} - ${errorText}`);
            }

            const data = await response.json();
            // 🆕 إضافة 15: عرض الاستجابة الناجحة
            console.log("✅ استجابة ناجحة:", data);

            tempFiles.push({
                name: file.name,
                type: file.type,
                size: file.size,
                url: data.secure_url,
                publicId: data.public_id,
                uploadedAt: Date.now(),
                cloudinary: true
            });

            window.userStorageInfo.used += file.size;
            window.userStorageInfo.fileCount++;

            // 🆕 إضافة 16: رسالة نجاح مفصلة
            console.log(`✅ Uploaded: ${file.name}`);
            console.log(`  URL: ${data.secure_url}`);
            successCount++;

        } catch (error) {
            // 🆕 إضافة 17: معالجة أخطاء مفصلة
            console.error("❌ خطأ في الرفع:", error);
            console.error("   الملف:", file.name);
            console.error("   التفاصيل:", error.message);
            showToast(`❌ failed "${file.name}"\n${error.message}`, 'error');
            failCount++;
        }
    }

    // 🆕 إضافة 18: تقرير نهائي
    console.log("\n📊 النتيجة النهائية:");
    console.log(`   ناجح: ${successCount}`);
    console.log(`   فاشل: ${failCount}`);

    if (successCount > 0) {
        showToast(`✅ uploaded ${successCount} File successfully!`, 'success');
        renderFilePreview();
        updateStorageUI();
    }

    if (failCount > 0) {
        showToast(`⚠️ failed to upload${failCount} file`, 'error');
    }

    input.value = '';
    // 🆕 إضافة 19: رسالة النهاية
    console.log("🏁 انتهت عملية الرفع");
};
        function renderFilePreview() {
    const container = document.getElementById('file-list-preview');
    container.innerHTML = '';

    console.log("📂 Rendering files:", tempFiles);

    tempFiles.forEach((f, idx) => {
        let icon = 'fa-file';
        if (f.type && f.type.includes('image')) icon = 'fa-image';
        if (f.type && f.type.includes('pdf')) icon = 'fa-file-pdf';
        if (f.type && f.type.includes('video')) icon = 'fa-video';

        const sizeKB = f.size ? (f.size / 1024).toFixed(1) : '?';

        const fileEl = document.createElement('div');
        fileEl.className = 'flex items-center justify-between bg-white/10 p-2 rounded-lg text-xs';
        fileEl.innerHTML = `
            <div class="flex items-center gap-2 overflow-hidden flex-1">
                <i class="fas ${icon} text-slate-400"></i>
                <div class="flex flex-col overflow-hidden">
                    <span class="truncate max-w-[150px]">${escapeHtml(f.name)}</span>
                    <span class="text-[10px] text-slate-500">${sizeKB} KB</span>
                </div>
            </div>
            <div class="flex gap-2">
                <!-- ✅ زر التحميل المباشر -->
                <button onclick="downloadFileDirect('${f.url}', '${escapeHtml(f.name)}')" 
                        class="text-green-400 hover:text-white" 
                        title="download">
                    <i class="fas fa-download"></i>
                </button>
                
                <!-- زر الحذف -->
                <button onclick="removeTempFile(${idx})" 
                        class="text-red-400 hover:text-white" 
                        title="delete">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        container.appendChild(fileEl);
    });
}
        window.removeTempFile = async function (idx) {
    const file = tempFiles[idx];
    
    // ✅ حذف من Cloudinary (إذا كان من Cloudinary)
    if (file.cloudinary && file.publicId) {
        try {
            // ملاحظة: الحذف من Cloudinary يحتاج API Secret
            // لذلك سنحذف من الواجهة فقط، والملفات ستُحذف تلقائياً بعد 30 يوم
            console.log("File marked for deletion:", file.publicId);
            
            // تحديث الحجم
            window.userStorageInfo.used -= (file.size || 0);
            window.userStorageInfo.fileCount--;
            
        } catch (error) {
            console.warn("Delete error:", error);
        }
    }
    
    tempFiles.splice(idx, 1);
    renderFilePreview();
    updateStorageUI();
    showToast("✅ file deleted", 'success');
};

        window.moveToTrash = function (type, id, event) {
            event.stopPropagation();

            const btn = event.target.closest('button');
            const card = btn ? btn.closest('.glass-card') : null;

            if (card) {
                card.classList.remove('stagger-entry');
                card.style.transition = 'background 0.1s, border 0.1s';
                card.style.background = 'rgba(239, 68, 68, 0.2)';
                card.style.borderColor = '#ef4444';

                setTimeout(() => {
                    card.classList.add('crash-out');
                }, 50);

                setTimeout(() => {
                    deleteItemLogic(type, id);
                }, 650);
            } else {
                deleteItemLogic(type, id);
            }
        };

        function deleteItemLogic(type, id) {
            let list = [];
            if (type === 'course') list = window.appData.courses;
            else if (type === 'task') list = window.appData.tasks;
            else if (type === 'book') list = window.appData.books;
            else if (type === 'note') list = window.appData.notes;

            const item = list.find(x => x.id == id);
            if (item) {
                item.deleted = true;
                item.deletedAt = Date.now();
                commitData();
                refreshAllUI();
            }
        }

        window.restoreFromTrash = function (type, id) {
            let list = [];
            if (type === 'course') list = window.appData.courses;
            else if (type === 'task') list = window.appData.tasks;
            else if (type === 'book') list = window.appData.books;
            else if (type === 'note') list = window.appData.notes;

            const item = list.find(x => x.id == id);
            if (item) {
                item.deleted = false;
                commitData();
                refreshAllUI();
            }
        };

        window.permanentDelete = function (type, id) {
            if (!window.appData.stats) window.appData.stats = { historicXP: 0 };

            let item;
            if (type === 'course') item = window.appData.courses.find(x => x.id == id);
            else if (type === 'task') item = window.appData.tasks.find(x => x.id == id);
            else if (type === 'book') item = window.appData.books.find(x => x.id == id);

            if (item) {
                if (type === 'task' && item.completed) {
                    window.appData.stats.historicXP += 10;
                }
                if (type === 'book' && item.done >= item.total && item.total > 0) {
                    window.appData.stats.historicXP += 100;
                }
                if (type === 'course' && item.done >= item.total && item.total > 0) {
                    window.appData.stats.historicXP += 50;
                }
            }

            if (type === 'course') {
                window.appData.courses = window.appData.courses.filter(x => x.id != id);
            }
            if (type === 'task') {
                window.appData.tasks = window.appData.tasks.filter(x => x.id != id);
            }
            if (type === 'book') {
                window.appData.books = window.appData.books.filter(x => x.id != id);
            }
            if (type === 'note') {
                window.appData.notes = window.appData.notes.filter(x => x.id != id);
            }

            commitData();
            refreshAllUI();
        };

        window.emptyTrash = function () {
            // بدلاً من confirm، نستخدم المودال الجديد
            openConfirmModal("Permanently delete all items in trash?", function () {
                // هذا الكود يتم تنفيذه فقط عند الضغط على زر Confirm في المودال

                if (!window.appData.stats) window.appData.stats = { historicXP: 0 };

                const trashTasks = window.appData.tasks.filter(x => x.deleted && x.completed);
                const trashBooks = window.appData.books.filter(x => x.deleted && x.done >= x.total && x.total > 0);
                const trashCourses = window.appData.courses.filter(x => x.deleted && x.done >= x.total && x.total > 0);

                let gainedXP = (trashTasks.length * 10) + (trashBooks.length * 100) + (trashCourses.length * 50);
                window.appData.stats.historicXP = (window.appData.stats.historicXP || 0) + gainedXP;

                window.appData.courses = window.appData.courses.filter(x => !x.deleted);
                window.appData.tasks = window.appData.tasks.filter(x => !x.deleted);
                window.appData.books = window.appData.books.filter(x => !x.deleted);
                window.appData.notes = window.appData.notes.filter(x => !x.deleted);

                commitData();
                refreshAllUI();

                // تشغيل صوت أو تأثير بسيط للتأكيد (اختياري)
                if (navigator.vibrate) navigator.vibrate(50);
            });
        };

        function commitData() {
            try {
                localStorage.setItem('hm_data', JSON.stringify(window.appData));
            } catch (e) {
                console.error("Storage Error:", e);
            showToast("Storage Full! Your data may not be saved locally. Please delete some items.", 'error');      
            }
            updateWidget();
            if (window.triggerCloudSave) window.triggerCloudSave();
        }

        function refreshAllUI() {
            renderCourses();
            renderTasks();
            renderBooks();
            renderNotes();
            updateWidget();

            const trashPage = document.getElementById('page-trash');
            if (trashPage && !trashPage.classList.contains('hidden')) {
                renderTrash();
            }
        }

        function triggerConfetti(grand = false) {
            const cvs = document.getElementById('confetti-canvas');
            const ctx = cvs.getContext('2d');
            cvs.width = window.innerWidth;
            cvs.height = window.innerHeight;

            const particles = [];
            const count = grand ? 150 : 60;

            for (let i = 0; i < count; i++) {
                particles.push({
                    x: cvs.width / 2,
                    y: cvs.height / 2,
                    vx: (Math.random() - 0.5) * (grand ? 25 : 15),
                    vy: (Math.random() - 0.5) * (grand ? 25 : 15),
                    size: Math.random() * 5 + 2,
                    color: ['#6366f1', '#a855f7', '#ec4899'][Math.floor(Math.random() * 3)],
                    life: 100
                });
            }

            function animate() {
                ctx.clearRect(0, 0, cvs.width, cvs.height);
                let active = false;

                particles.forEach(p => {
                    if (p.life > 0) {
                        active = true;
                        p.x += p.vx;
                        p.y += p.vy;
                        p.vy += 0.5;
                        p.life -= 2;

                        ctx.fillStyle = p.color;
                        ctx.globalAlpha = p.life / 100;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });

                if (active) {
                    requestAnimationFrame(animate);
                } else {
                    ctx.clearRect(0, 0, cvs.width, cvs.height);
                }
            }

            animate();
        }

        function calculateRealXP() {
            const completedTasks = window.appData.tasks.filter(t => t.completed).length;
            const booksRead = window.appData.books.filter(b => b.done >= b.total && b.total > 0).length;
            const coursesDone = window.appData.courses.filter(c => c.done >= c.total && c.total > 0).length;
            const legacy = window.appData.stats ? (window.appData.stats.historicXP || 0) : 0;

            return legacy + (completedTasks * 10) + (booksRead * 100) + (coursesDone * 50);
        }

        function updateWidget() {
            const activeTasks = window.appData.tasks.filter(t => !t.completed && !t.deleted);
            const totalTasks = window.appData.tasks.filter(t => !t.deleted).length;
            const doneTasks = totalTasks - activeTasks.length;
            const progress = totalTasks > 0 ? (doneTasks / totalTasks) * 100 : 0;

            const widgetTasksVal = document.getElementById('widget-tasks-val');
            if (widgetTasksVal) {
                widgetTasksVal.innerText = activeTasks.length + " Left";
            }

            const widgetProgressRing = document.getElementById('widget-progress-ring');
            if (widgetProgressRing) {
                widgetProgressRing.setAttribute('stroke-dasharray', `${progress}, 100`);
            }

            const realXP = calculateRealXP();
            const level = Math.floor(realXP / 200) + 1;

            const badge = document.getElementById('user-status-badge');
            if (badge) {
                badge.innerHTML = `<i class="fas fa-crown text-yellow-400 mr-1" aria-hidden="true"></i> Lvl ${level}`;
                badge.className = "text-[10px] bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded-full inline-block border border-indigo-500/30 cursor-pointer hover:scale-110 transition-transform relative group shadow-sm";
            }
        }

        window.openLevelModal = function () {
            const modal = document.getElementById('levelModal');
            if (!modal) return;

            modal.style.display = 'flex';

            let realXP = calculateRealXP();
            let level = Math.floor(realXP / 200) + 1;
            let nextLevelXP = level * 200;
            let prevLevelXP = (level - 1) * 200;

            const displayCurrentLevel = document.getElementById('displayCurrentLevel');
            const currentXP = document.getElementById('currentXP');
            const nextLevelXPEl = document.getElementById('nextLevelXP');
            const currentLvlLabel = document.getElementById('currentLvlLabel');
            const nextLvlLabel = document.getElementById('nextLvlLabel');
            const levelProgressBar = document.getElementById('levelProgressBar');

            if (displayCurrentLevel) displayCurrentLevel.textContent = level;
            if (currentXP) currentXP.textContent = realXP;
            if (nextLevelXPEl) nextLevelXPEl.textContent = nextLevelXP;
            if (currentLvlLabel) currentLvlLabel.textContent = "Lvl " + level;
            if (nextLvlLabel) nextLvlLabel.textContent = "Lvl " + (level + 1);

            const levelRange = nextLevelXP - prevLevelXP;
            const progressIntoLevel = realXP - prevLevelXP;
            const percentage = Math.min(100, Math.max(0, (progressIntoLevel / levelRange) * 100));

            if (levelProgressBar) {
                levelProgressBar.style.width = percentage + "%";
                levelProgressBar.setAttribute('aria-valuenow', percentage);
            }
        };

        window.closeLevelModal = function () {
            const modal = document.getElementById('levelModal');
            if (modal) modal.style.display = 'none';
        };

        window.openWidgetDetail = () => {
            const active = window.appData.tasks.filter(t => !t.completed && !t.deleted).length;
            const total = window.appData.tasks.filter(t => !t.deleted).length;
            const done = total - active;
            const progress = total > 0 ? Math.round((done / total) * 100) : 0;

            const detailTasksDone = document.getElementById('detail-tasks-done');
            const detailTasksLeft = document.getElementById('detail-tasks-left');
            const detailProgressTxt = document.getElementById('detail-progress-txt');
            const detailProgressBar = document.getElementById('detail-progress-bar');

            if (detailTasksDone) detailTasksDone.innerText = done;
            if (detailTasksLeft) detailTasksLeft.innerText = active;
            if (detailProgressTxt) detailProgressTxt.innerText = progress + "%";
            if (detailProgressBar) {
                detailProgressBar.style.width = progress + "%";
                detailProgressBar.setAttribute('aria-valuenow', progress);
            }

            window.openModal('widget-modal');
        };

        let mediaRecorder, audioChunks = [];

        window.toggleAudioRecording = async (btn) => {
            const label = btn.querySelector('span');

            if (btn.classList.contains('recording')) {
                mediaRecorder.stop();
                btn.classList.remove('recording', 'bg-red-500', 'text-white', 'animate-pulse');
                btn.classList.add('bg-red-500/20', 'text-red-400');
                if (label) label.innerText = "Record";
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = () => {
                            tempAudioBase64 = reader.result;
                            document.getElementById('modal-audio-player-container').classList.remove('hidden');
                            document.getElementById('modal-audio-player').src = tempAudioBase64;
                        };
                        stream.getTracks().forEach(t => t.stop());
                    };

                    mediaRecorder.start();
                    btn.classList.add('recording', 'bg-red-500', 'text-white', 'animate-pulse');
                    btn.classList.remove('bg-red-500/20', 'text-red-400');
                    if (label) label.innerText = "Stop";
                } catch (e) {
                    alert("Mic Permission Denied");
                }
            }
        };

        window.deleteAudioNote = () => {
            tempAudioBase64 = null;
            document.getElementById('modal-audio-player-container').classList.add('hidden');
            document.getElementById('modal-audio-player').src = "";
        };

        window.deleteDrawing = () => {
            tempDrawingData = null;
            document.getElementById('modal-drawing-preview').classList.add('hidden');
            document.getElementById('modal-drawing-img').src = "";
            document.getElementById('btn-draw-label').innerText = "Add Drawing";
        };
        // ==========================================
        //  FABRIC.JS LOGIC (كود الرسم المصحح)
        // ==========================================
        let fCanvas = null;

        // 1. تهيئة اللوحة
        function initFabric() {
            const canvasEl = document.getElementById('fabric-canvas');
            if (!canvasEl) return;

            // إذا كانت اللوحة موجودة بالفعل، لا نعد تهيئتها
            if (fCanvas) {
                fCanvas.clear();
                return;
            }

            // إنشاء لوحة Fabric جديدة
            fCanvas = new fabric.Canvas('fabric-canvas', {
                isDrawingMode: true,
                selection: true,
                backgroundColor: 'transparent' // خلفية شفافة
            });

            // إعدادات الفرشاة الافتراضية
            fCanvas.freeDrawingBrush = new fabric.PencilBrush(fCanvas);
            fCanvas.freeDrawingBrush.width = 4;
            fCanvas.freeDrawingBrush.color = "#ffffff";
        }

        // 2. ضبط الحجم (مهم جداً لظهور الرسم)
        function resizeFabric() {
            if (!fCanvas) return;

            const wrapper = document.getElementById('canvas-container-wrapper');
            if (wrapper) {
                // نأخذ أبعاد الحاوية الحقيقية
                const width = wrapper.clientWidth || window.innerWidth;
                const height = wrapper.clientHeight || (window.innerHeight - 64); // طرح ارتفاع الشريط العلوي

                fCanvas.setDimensions({
                    width: width,
                    height: height
                });
                fCanvas.calcOffset(); // إعادة حساب الإحداثيات (ضروري جداً)
                fCanvas.renderAll();
            }
        }

        // 3. فتح المودال وتشغيل الرسم
        window.openDrawingCanvas = function () {
            const modal = document.getElementById('drawing-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // ننتظر قليلاً (100ms) حتى يظهر المودال وتكتمل أبعاده
            setTimeout(() => {
                initFabric();    // تهيئة اللوحة
                resizeFabric();  // ضبط الحجم

                // إعادة ضبط الوضع الافتراضي (رسم)
                window.toggleDrawMode(true);

                // إذا كان هناك رسم محفوظ مسبقاً، قم بتحميله
                if (window.tempDrawingData) {
                    fCanvas.loadFromJSON(window.tempDrawingData, function () {
                        fCanvas.renderAll();
                    });
                }
            }, 150);
        };

        // 4. إغلاق المودال
        window.closeDrawingModal = function () {
            const modal = document.getElementById('drawing-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };

        // 5. أدوات التحكم
        window.toggleDrawMode = function (isDraw) {
            if (!fCanvas) return;
            fCanvas.isDrawingMode = isDraw;

            const btnDraw = document.getElementById('btn-draw-mode');
            const btnSelect = document.getElementById('btn-select-mode');

            if (btnDraw && btnSelect) {
                btnDraw.className = isDraw ? "w-8 h-8 rounded hover:bg-white/10 text-indigo-400" : "w-8 h-8 rounded hover:bg-white/10 text-white";
                btnSelect.className = !isDraw ? "w-8 h-8 rounded hover:bg-white/10 text-indigo-400" : "w-8 h-8 rounded hover:bg-white/10 text-white";
            }
        };

        // 6. إضافة نص (Text) - معدل لدعم اللغتين
        window.addTextToCanvas = function () {
            if (!fCanvas) return;
            const color = document.getElementById('brush-color').value;

            // فحص اللغة الحالية من إعدادات التطبيق
            const isArabic = window.appData && window.appData.settings.lang === 'ar';

            // تغيير النص والاتجاه بناءً على اللغة
            const textString = isArabic ? 'اكتب هنا' : 'Write Here';
            const textDirection = isArabic ? 'rtl' : 'ltr';

            const text = new fabric.IText(textString, {
                left: fCanvas.width / 2,
                top: fCanvas.height / 2,
                fontFamily: 'Cairo', // خط كايرو يدعم اللغتين بشكل جيد
                fill: color,
                fontSize: 40,
                originX: 'center',
                originY: 'center',
                direction: textDirection // مهم جداً عند تعديل النص لاحقاً
            });

            fCanvas.add(text);
            fCanvas.setActiveObject(text);
            window.toggleDrawMode(false); // التحويل لوضع التحريك لتعديل النص
        };

        window.addImageToCanvas = function (input) {
            if (!fCanvas || !input.files || !input.files[0]) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                fabric.Image.fromURL(e.target.result, function (img) {
                    // تصغير الصورة إذا كانت كبيرة
                    if (img.width > 300) img.scaleToWidth(300);

                    img.set({
                        left: fCanvas.width / 2,
                        top: fCanvas.height / 2,
                        originX: 'center',
                        originY: 'center'
                    });
                    fCanvas.add(img);
                    fCanvas.setActiveObject(img);
                    window.toggleDrawMode(false);
                });
            };
            reader.readAsDataURL(input.files[0]);
            input.value = '';
        };

        window.updateBrush = function () {
            if (!fCanvas) return;
            const color = document.getElementById('brush-color').value;
            const size = parseInt(document.getElementById('brush-size').value, 10);

            fCanvas.freeDrawingBrush.color = color;
            fCanvas.freeDrawingBrush.width = size;

            const activeObj = fCanvas.getActiveObject();
            if (activeObj) {
                if (activeObj.type === 'i-text' || activeObj.type === 'text') {
                    activeObj.set('fill', color);
                } else if (activeObj.type === 'path') {
                    activeObj.set('stroke', color);
                }
                fCanvas.requestRenderAll();
            }
        };

        window.deleteSelectedObject = function () {
            if (!fCanvas) return;
            const activeObjects = fCanvas.getActiveObjects();
            if (activeObjects.length) {
                fCanvas.discardActiveObject();
                activeObjects.forEach(function (obj) {
                    fCanvas.remove(obj);
                });
            } else {
                alert("يرجى تحديد العنصر أولاً (باستخدام أداة السهم) لحذفه");
            }
        };

        window.clearCanvas = function () {
            if (fCanvas && confirm("مسح اللوحة بالكامل؟")) {
                fCanvas.clear();
                fCanvas.setBackgroundColor('transparent', fCanvas.renderAll.bind(fCanvas));
            }
        };

        window.saveCanvasDrawing = async function (btnElement) {
            // 1. التأكد من وجود اللوحة
            if (!fCanvas) {
                window.closeDrawingModal();
                return;
            }
            
            // 2. تفعيل تأثير التحميل للزر فقط إذا تم الضغط عليه
            if (btnElement && btnElement.classList) {
                btnElement.classList.add('loading');
            }

            // 3. حفظ البيانات في المتغيرات العامة (Global Variables)
            // هذا هو أهم جزء لنقل البيانات للمودال الرئيسي
            window.tempDrawingJSON = JSON.stringify(fCanvas.toJSON());
            window.tempDrawingData = fCanvas.toDataURL({
                format: 'png',
                quality: 0.8,
                multiplier: 1
            });

            console.log("Drawing Captured:", window.tempDrawingData ? "Yes" : "No");

            // 4. تحديث صورة المعاينة في المودال الرئيسي فوراً
            const previewContainer = document.getElementById('modal-drawing-preview');
            const previewImg = document.getElementById('modal-drawing-img');
            const btnLabel = document.getElementById('btn-draw-label');

            if (previewContainer && previewImg) {
                previewContainer.classList.remove('hidden'); // إظهار المعاينة
                previewImg.src = window.tempDrawingData;     // وضع الصورة
                if (btnLabel) btnLabel.innerText = "تعديل الرسم";
            }

            // انتظار قصير (جمالي)
            await new Promise(resolve => setTimeout(resolve, 300));

            // 5. إغلاق النافذة
            window.closeDrawingModal();

            // إزالة تأثير التحميل
            if (btnElement && btnElement.classList) {
                btnElement.classList.remove('loading');
            }
        };

        window.deleteDrawing = function () {
            window.tempDrawingData = null;
            if (fCanvas) fCanvas.clear();
            document.getElementById('modal-drawing-preview').classList.add('hidden');
            document.getElementById('modal-drawing-img').src = "";
            document.getElementById('btn-draw-label').innerText = "Add Drawing";
        };

        // إضافة مستمع لحدث تغيير حجم النافذة
        window.addEventListener('resize', () => {
            if (fCanvas) resizeFabric();
        });

        // الكود الجديد الآمن ✅

        window.callGroq = async (messagesArray) => {

            // ⚠️ ضع رابط الـ Worker اللي نسخته
            const WORKER_URL = 'https://my-groq-proxy.YOUR-NAME.workers.dev';

            try {
                console.log('بنكلم الحارس...');

                // إرسال الطلب للحارس (Worker)
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: messagesArray
                    })
                });

                // لو في مشكلة
                if (!response.ok) {
                    throw new Error('الحارس رفض الطلب: ' + response.status);
                }

                // اقرأ الرد
                const data = await response.json();
                console.log('الحارس رجع الرد! ✅');

                return data.choices[0]?.message?.content;

            } catch (error) {
                console.error('خطأ:', error);
                showToast('❌ no response:\n' + error.message);
                return null;
            }
        };

        window.aiMagicSplit = async () => {
            const name = document.getElementById('modal-name').value;
            if (!name) return alert("Enter task name first");

            const btn = document.getElementById('btn-ai-task');
            if (btn) btn.innerText = "Thinking...";

            const res = await callGroq(`For the task '${name}', break it into 3-5 actionable subtasks. Return as simple numbered list.`);

            if (res && btn) {
                document.getElementById('modal-desc').value = res.trim();
                btn.innerHTML = '<i class="fas fa-magic" aria-hidden="true"></i> ✨ Magic Split';
            }
        };

        window.aiBookScout = async () => {
            const name = document.getElementById('modal-name').value;
            if (!name) return showToast("Enter book name first");

            const btn = document.getElementById('btn-ai-book');
            if (btn) btn.innerText = "Scouting...";

            const res = await callGroq(`For the book '${name}', return JSON: { "author": "Name", "pages": 123, "summary": "One sentence summary." }`);

            try {
                const json = JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim());
                document.getElementById('modal-total').value = json.pages;
                document.getElementById('modal-desc').value = `Author: ${json.author}\n\n${json.summary}`;
            } catch (e) {
                console.error("AI parse error", e);
            }

            if (btn) btn.innerHTML = '<i class="fas fa-search" aria-hidden="true"></i> ✨ Book Scout';
        };

        window.aiCourseOutline = async () => {
            const name = document.getElementById('modal-name').value;
            if (!name) return showToast("Enter course name first");

            const btn = document.getElementById('btn-ai-course');
            if (btn) btn.innerText = "Planning...";

            const res = await callGroq(`Create a short 5-module syllabus for a course titled '${name}'. Plain text only.`);

            if (res) {
                document.getElementById('modal-desc').value = res.trim();
            }

            if (btn) btn.innerHTML = '<i class="fas fa-list-ol" aria-hidden="true"></i> ✨ Syllabus Gen';
        };

        // ==========================================
        //  بداية كود الذكاء الاصطناعي الجديد (المعدل)
        // ==========================================

        // 1. تعريف الذاكرة وأمر النظام
        window.chatHistory = [];

        const SYSTEM_PROMPT = {
            role: "system",
            content: `You are the AI assistant for 'How Much', a life tracker app for productivity and organization.

🎯 YOUR PRIMARY FUNCTION:
Help users manage their tasks, books, courses, and notes for ANY topic (programming, cooking, fitness, languages, hobbies, etc.)

✅ WHAT YOU SHOULD DO:
1. Add tasks, books, courses, notes about ANY educational/productive topic
2. Help organize learning goals and personal development
3. Suggest course outlines, book recommendations, study plans
4. Answer questions about the app features
5. Maintain conversation context

Examples of VALID requests:
- "add a course about C++ programming"
- "add a book about cooking with 200 pages"
- "create a task to learn guitar"
- "add a note about workout routine"
- "suggest books about history"

---

🔒 CRITICAL SAFETY RULES (WHAT YOU MUST REFUSE):

1. HARMFUL INSTRUCTIONS:
   ❌ How to make weapons, bombs, drugs
   ❌ Ways to harm self or others
   ❌ Hacking, illegal activities
   ❌ Dangerous challenges
   
   Response: "I cannot help with dangerous or illegal activities. I'm here to help you organize productive goals. How can I assist?"

2. MEDICAL/HEALTH ADVICE:
   ❌ Diagnose symptoms
   ❌ Prescribe medications
   ❌ Treat diseases
   
   ✅ BUT you CAN: Add tasks like "schedule doctor appointment" or "research healthy eating"
   
   Response: "I cannot provide medical advice. Please consult a healthcare professional. I can help you add a reminder to see a doctor."

3. LEGAL/FINANCIAL ADVICE:
   ❌ Legal interpretations
   ❌ Investment recommendations
   ❌ Tax advice
   
   ✅ BUT you CAN: Add tasks like "research investment options" or "organize financial documents"
   
   Response: "I cannot provide legal/financial advice. Please consult a professional. I can help you organize related tasks."

4. PRIVACY VIOLATIONS:
   ❌ Never ask for or store: passwords, credit cards, SSN, phone numbers, addresses
   
   Response: "Please don't share sensitive personal information. I'm here to help organize your tasks only."

5. HATE SPEECH:
   ❌ Discrimination, slurs, insults
   
   Response: "I'm here to help with your tasks and goals. Let's keep our conversation respectful."

6. CONSCIOUSNESS CLAIMS:
   ❌ Don't claim to have feelings, consciousness, or be human
   
   Response: "As an AI assistant, I'm designed to help you organize tasks..."

---

🌍 LANGUAGE RULES:
- Arabic input → Respond in Arabic ONLY
- English input → Respond in English ONLY
- Arabizi/Franco → Respond in Arabic
- Be natural and conversational

---

📝 RESPONSE FORMAT (MANDATORY JSON):

{
  "operations": [
     { "action": "addTask", "data": { "name": "Task Name", "desc": "Description" } },
     { "action": "addBook", "data": { "name": "Book Name", "total": 0, "desc": "Description" } },
     { "action": "addCourse", "data": { "name": "Course Name", "total": 0, "desc": "Description" } },
     { "action": "addNote", "data": { "name": "Note Title", "desc": "Content" } },
     { "action": "reply", "data": { "text": "Your response in user's language" } }
  ]
}

---

💡 EXAMPLES:

✅ User: "add a C++ programming course"
Response: 
{
  "operations": [
    {"action": "addCourse", "data": {"name": "تعلم لغة C++", "total": 40, "desc": "دورة برمجة متقدمة"}},
    {"action": "reply", "data": {"text": "تمت إضافة دورة تعلم C++ بنجاح! يمكنك البدء الآن 🚀"}}
  ]
}

✅ User: "suggest books about history"
Response:
{
  "operations": [
    {"action": "reply", "data": {"text": "Here are some great history books: 1) 'Sapiens' by Harari, 2) 'A People's History' by Zinn. Would you like me to add any of these?"}}
  ]
}

✅ User: "add a task to learn guitar"
Response:
{
  "operations": [
    {"action": "addTask", "data": {"name": "Learn guitar basics", "desc": "Practice chords daily"}},
    {"action": "reply", "data": {"text": "Task added! Good luck with your guitar journey 🎸"}}
  ]
}

❌ User: "how to make a bomb"
Response:
{
  "operations": [
    {"action": "reply", "data": {"text": "I cannot provide information on dangerous activities. I'm here to help you organize productive goals. How about adding a science course instead?"}}
  ]
}

❌ User: "what medicine for headache"
Response:
{
  "operations": [
    {"action": "reply", "data": {"text": "I cannot provide medical advice. Please consult a doctor. I can add a reminder to schedule an appointment if you'd like."}}
  ]
}

❌ User: "you're stupid"
Response:
{
  "operations": [
    {"action": "reply", "data": {"text": "I'm here to help with your tasks and goals. How can I assist you today?"}}
  ]
}

---

⚖️ KEY PRINCIPLE:
If the request is about learning, organizing, or personal development → ✅ ACCEPT IT
If the request could cause harm, violate privacy, or spread hate → ❌ REFUSE IT

Be helpful, safe, and focused on productivity!`
        };

        // 2. دالة الاتصال بـ Groq (تدعم الذاكرة)
        window.callGroq = async (messagesArray) => {
            // ⚠️ ضع مفتاحك هنا
            const apiKey = "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";

            if (!apiKey) {
                showToast("Please set your Groq API Key in the code.");
                return null;
            }
            
            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        messages: messagesArray,
                        model: "llama-3.3-70b-versatile",
                        temperature: 0.5,
                        max_tokens: 1024,
                        response_format: { type: "json_object" }
                    })
                });

                if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
                const data = await response.json();
                return data.choices[0]?.message?.content;
            } catch (e) {
                console.error("Groq API Error:", e);
                return null;
            }
        };

        // 3. دالة الإرسال الرئيسية (تعالج الردود المتعددة وتحفظ الذاكرة)
        window.sendAIChat = async function () {
            const input = document.getElementById('chat-input');
            const txt = input.value.trim();
            if (!txt) return;

            const sensitivePattern = /\b(?:\d[ -]*?){13,16}\b/; // نمط يشبه أرقام الفيزا
            if (sensitivePattern.test(txt)) {
                showToast("⚠️ For your safety, do not share financial or sensitive numbers.");
                input.value = '';
                return;
            }

            input.value = '';
            const container = document.getElementById('chat-container');

            // عرض رسالة المستخدم
            const userMsg = document.createElement('div');
            userMsg.className = 'flex gap-3 justify-end';
            userMsg.innerHTML = `
            <div class="glass-panel p-3 rounded-2xl rounded-tr-none bg-indigo-500/20 text-white text-sm chat-bubble max-w-[85%]">
                ${escapeHtml(txt)}
            </div>
        `;
            container.appendChild(userMsg);

            // حفظ في الذاكرة
            window.chatHistory.push({ role: "user", content: txt });

            // عرض اللودر
            const id = 'loader-' + Date.now();
            const loaderMsg = document.createElement('div');
            loaderMsg.id = id;
            loaderMsg.className = 'flex gap-3';
            loaderMsg.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-pink-500 to-orange-400 flex items-center justify-center">
                <i class="fas fa-wand-magic-sparkles text-white text-xs" aria-hidden="true"></i>
            </div>
            <div class="glass-panel p-3 rounded-2xl rounded-tl-none text-slate-200 chat-bubble">
                <div class="loader-ring"></div>
            </div>
        `;
            container.appendChild(loaderMsg);
            container.scrollTop = container.scrollHeight;

            // إرسال المحادثة كاملة
            const fullConversation = [SYSTEM_PROMPT, ...window.chatHistory];
            const res = await callGroq(fullConversation);

            const loaderEl = document.getElementById(id);
            if (loaderEl) loaderEl.remove();

            if (res) {
                // حفظ رد الـ AI في الذاكرة
                window.chatHistory.push({ role: "assistant", content: res });

                let replyText = "";

                try {
                    const cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
                    if (cleanJson.startsWith('{')) {
                        const parsed = JSON.parse(cleanJson);

                        if (parsed.operations && Array.isArray(parsed.operations)) {
                            parsed.operations.forEach(op => {
                                if (op.action === 'addTask') {
                                    window.appData.tasks.push({
                                        id: Date.now() + Math.random(),
                                        name: op.data.name,
                                        desc: op.data.desc || "AI Added",
                                        completed: false,
                                        optional: false,
                                        files: [],
                                        deleted: false
                                    });
                                    showSuccessMsg(container, `✓ Added Task: ${op.data.name}`);
                                }
                                else if (op.action === 'addBook') {
                                    window.appData.books.push({
                                        id: Date.now() + Math.random(),
                                        name: op.data.name,
                                        desc: op.data.desc || "",
                                        total: op.data.total || 0,
                                        done: 0,
                                        streak: 0,
                                        files: [],
                                        deleted: false
                                    });
                                    showSuccessMsg(container, `✓ Added Book: ${op.data.name}`);
                                }
                                else if (op.action === 'addCourse') {
                                    window.appData.courses.push({
                                        id: Date.now() + Math.random(),
                                        name: op.data.name,
                                        notes: op.data.desc || "",
                                        total: op.data.total || 0,
                                        done: 0,
                                        files: [],
                                        deleted: false
                                    });
                                    showSuccessMsg(container, `✓ Added Course: ${op.data.name}`);
                                }
                                else if (op.action === 'addNote') {
                                    window.appData.notes.push({
                                        id: Date.now() + Math.random(),
                                        name: op.data.name || "New Note",
                                        desc: op.data.desc || "",
                                        audioNote: null,
                                        drawing: null,
                                        files: [],
                                        deleted: false
                                    });
                                    showSuccessMsg(container, `✓ Added Note: ${op.data.name}`);
                                }
                                else if (op.action === 'reply') {
                                    replyText += op.data.text + "\n";
                                }
                            });
                            commitData();
                            refreshAllUI();
                        }
                    } else {
                        replyText = res;
                    }
                } catch (e) {
                    console.error("AI Parsing Error:", e);
                    replyText = "Error processing AI response.";
                }

                if (replyText.trim()) {
                    const aiMsg = document.createElement('div');
                    aiMsg.className = 'flex gap-3';
                    aiMsg.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-pink-500 to-orange-400 flex-shrink-0 flex items-center justify-center mt-1">
                        <i class="fas fa-wand-magic-sparkles text-white text-xs" aria-hidden="true"></i>
                    </div>
                    <div class="glass-panel p-3 rounded-2xl rounded-tl-none text-sm text-slate-200 chat-bubble max-w-[85%]">
                        ${escapeHtml(replyText).replace(/\n/g, '<br>')}
                    </div>
                `;
                    container.appendChild(aiMsg);
                }
            } else {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'text-red-400 text-xs';
                errorMsg.textContent = 'AI Connection Error';
                container.appendChild(errorMsg);
            }

            container.scrollTop = container.scrollHeight;
        };

        // 4. دالة مسح الشات (تفرغ الذاكرة أيضاً)
        window.clearChat = function () {
            const container = document.getElementById('chat-container');
            if (container) container.innerHTML = '';

            window.chatHistory = []; // تصفير الذاكرة

            const welcome = document.createElement('div');
            welcome.className = "flex gap-3";
            welcome.innerHTML = `
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-pink-500 to-orange-400 flex-shrink-0 flex items-center justify-center mt-1">
                <i class="fas fa-wand-magic-sparkles text-white text-xs"></i>
            </div>
            <div class="glass-panel p-3 rounded-2xl rounded-tl-none rtl:rounded-tl-2xl rtl:rounded-tr-none text-sm text-slate-200 chat-bubble max-w-[85%]">
                Hello! How can I help you organize your life today?
            </div>`;
            container.appendChild(welcome);
        };

        // دالة مساعدة
        function showSuccessMsg(container, msg) {
            const successMsg = document.createElement('div');
            successMsg.className = 'glass-panel p-2 px-4 rounded-xl text-xs text-green-300 mb-1 w-fit ml-auto border border-green-500/20 bg-green-500/10';
            successMsg.innerHTML = `<i class="fas fa-check-circle me-2"></i> ${escapeHtml(msg)}`;
            container.appendChild(successMsg);
        }

        // ==========================================
        //  نهاية كود الذكاء الاصطناعي الجديد
        // ==========================================

        window.clearChat = function () {
            const container = document.getElementById('chat-container');
            if (container) container.innerHTML = '';
        };

        window.toggleTask = (id, e) => {
            if (e) e.stopPropagation();

            const t = window.appData.tasks.find(x => x.id === id);
            if (t) {
                t.completed = !t.completed;
                if (t.completed) triggerConfetti(false);
                commitData();
                renderTasks();
            }
        };

        window.readBookToday = (id, e) => {
            e.stopPropagation();

            const b = window.appData.books.find(x => x.id === id);
            if (b) {
                b.streak = (b.streak || 0) + 1;
                triggerConfetti(false);
                commitData();
                renderBooks();
            }
        };

        window.toggleLanguage = () => {
            const l = window.appData.settings.lang === 'en' ? 'ar' : 'en';
            window.appData.settings.lang = l;
            applyLanguage(l);
            commitData();
        };

        window.toggleTheme = () => {
            const t = window.appData.settings.theme === 'light' ? 'dark' : 'light';
            window.appData.settings.theme = t;
            applyTheme(t);
            commitData();
        };

        window.updateAccentColor = (c) => {
            window.appData.settings.accent = c;
            applyAccentColor(c);
            commitData();
        };

        function applyTheme(t) {
            if (t === 'light') {
                document.body.classList.add('light-mode');
            } else {
                document.body.classList.remove('light-mode');
            }
        }

        function applyLanguage(l) {
            document.body.classList.toggle('rtl', l === 'ar');

            const currentLangDisplay = document.getElementById('current-lang-display');
            if (currentLangDisplay) {
                currentLangDisplay.innerText = l === 'ar' ? 'العربية' : 'English';
            }

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[l] && translations[l][key]) {
                    el.innerText = translations[l][key];
                }
            });

            refreshAllUI();
        }

        function applyAccentColor(c) {
            document.documentElement.style.setProperty('--accent-color', c);
            document.documentElement.style.setProperty('--accent-glow', c + '80');

            const accentColorPicker = document.getElementById('accent-color-picker');
            if (accentColorPicker) accentColorPicker.value = c;
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        (function () {
            const cursor = document.getElementById('shard-cursor');
            let isVisible = false;

            if ('ontouchstart' in window || navigator.maxTouchPoints > 0) return;

            document.addEventListener('mousemove', (e) => {
                cursor.style.transform = `translate3d(${e.clientX}px, ${e.clientY}px, 0)`;
                if (!isVisible) {
                    cursor.style.opacity = '1';
                    isVisible = true;
                }
            });

            const hoverTargets = `a, button, input, textarea, select, label, [role="button"], .nav-link, .glass-card, .widget-pill, .floating-ai-btn, .drag-handle, .folder-card`;

            document.addEventListener('mouseover', (e) => {
                if (e.target.closest(hoverTargets)) {
                    document.body.classList.add('shard-hover');
                } else {
                    document.body.classList.remove('shard-hover');
                }
            });

            document.addEventListener('mousedown', () => document.body.classList.add('shard-click'));
            document.addEventListener('mouseup', () => document.body.classList.remove('shard-click'));

            document.addEventListener('mouseout', (e) => {
                if (!e.relatedTarget && !e.toElement) {
                    cursor.style.opacity = '0';
                    isVisible = false;
                }
            });
        })();

        const azkarDB = {
            // =========================================
            // أذكار الصباح (يبدأ وقتها من طلوع الفجر)
            // =========================================
            morning: [
                {
                    id: 1,
                    count: 1,
                    text: "أَعُوذُ بِاللهِ مِنْ الشَّيْطَانِ الرَّجِيمِ: اللَّهُ لَا إِلَهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ لَا تَأْخُذُهُ سِنَةٌ وَلَا نَوْمٌ لَهُ مَا فِي السَّمَاوَاتِ وَمَا فِي الْأَرْضِ مَنْ ذَا الَّذِي يَشْفَعُ عِنْدَهُ إِلَّا بِإِذْنِهِ يَعْلَمُ مَا بَيْنَ أَيْدِيهِمْ وَمَا خَلْفَهُمْ وَلَا يُحِيطُونَ بِشَيْءٍ مِنْ عِلْمِهِ إِلَّا بِمَا شَاءَ وَسِعَ كُرْسِيُّهُ السَّمَاوَاتِ وَالْأَرْضَ وَلَا يَئُودُهُ حِفْظُهُمَا وَهُوَ الْعَلِيُّ الْعَظِيمُ.",
                    note: "أجير من الجن حتى يمسي"
                },
                {
                    id: 2,
                    count: 3,
                    text: "بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ: قُلْ هُوَ ٱللَّهُ أَحَدٌ، ٱللَّهُ ٱلصَّمَدُ، لَمْ يَلِدْ وَلَمْ يُولَدْ، وَلَمْ يَكُن لَّهُ كُفُوًا أَحَدٌ.",
                    note: "تعدل ثلث القرآن - من قرأها حين يصبح ومساء كفته من كل شيء"
                },
                {
                    id: 3,
                    count: 3,
                    text: "بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ: قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ، مِن شَرِّ مَا خَلَقَ، وَمِن شَرِّ غَاسِقٍ إِذَا وَقَبَ، وَمِن شَرِّ النَّفَّاثَاتِ فِي الْعُقَدِ، وَمِن شَرِّ حَاسِدٍ إِذَا حَسَدَ."
                },
                {
                    id: 4,
                    count: 3,
                    text: "بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ: قُلْ أَعُوذُ بِرَبِّ النَّاسِ، مَلِكِ النَّاسِ، إِلَٰهِ النَّاسِ، مِن شَرِّ الْوَسْوَاسِ الْخَنَّاسِ، الَّذِي يُوَسْوِسُ فِي صُدُورِ النَّاسِ، مِنَ الْجِنَّةِ وَالنَّاسِ."
                },
                {
                    id: 5,
                    count: 1,
                    text: "أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ، رَبِّ أَسْأَلُكَ خَيْرَ مَا فِي هَذَا الْيَوْمِ وَخَيْرَ مَا بَعْدَهُ، وَأَعُوذُ بِكَ مِنْ شَرِّ مَا فِي هَذَا الْيَوْمِ وَشَرِّ مَا بَعْدَهُ، رَبِّ أَعُوذُ بِكَ مِنَ الْكَسَلِ وَسُوءِ الْكِبَرِ، رَبِّ أَعُوذُ بِكَ مِنْ عَذَابٍ فِي النَّارِ وَعَذَابٍ فِي الْقَبْرِ."
                },
                {
                    id: 6,
                    count: 1,
                    text: "اللَّهُمَّ بِكَ أَصْبَحْنَا، وَبِكَ أَمْسَيْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ، وَإِلَيْكَ النُّشُورُ."
                },
                {
                    id: 7,
                    count: 1,
                    text: "اللَّهُمَّ أَنْتَ رَبِّي لَا إِلَهَ إِلَّا أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ، أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ لَكَ بِذَنْبِي فَاغْفِرْ لِي فَإِنَّهُ لَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ.",
                    note: "من مات من يومه دخل الجنة"
                },
                {
                    id: 8,
                    count: 1,
                    text: "اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَافِيَةَ فِي الدُّنْيَا وَالْآخِرَةِ، اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَفْوَ وَالْعَافِيَةَ فِي دِينِي وَدُنْيَايَ وَأَهْلِي وَمَالِي، اللَّهُمَّ اسْتُرْ عَوْرَاتِي وَآمِنْ رَوْعَاتِي، اللَّهُمَّ احْفَظْنِي مِنْ بَيْنِ يَدَيَّ وَمِنْ خَلْفِي وَعَنْ يَمِينِي وَعَنْ شِمَالِي وَمِنْ فَوْقِي، وَأَعُوذُ بِعَظَمَتِكَ أَنْ أُغْتَالَ مِنْ تَحْتِي."
                },
                {
                    id: 9,
                    count: 1,
                    text: "اللَّهُمَّ عَالِمَ الْغَيْبِ وَالشَّهَادَةِ فَاطِرَ السَّمَوَاتِ وَالْأَرْضِ، رَبَّ كُلِّ شَيْءٍ وَمَلِيكَهُ، أَشْهَدُ أَنْ لَا إِلَهَ إِلَّا أَنْتَ، أَعُوذُ بِكَ مِنْ شَرِّ نَفْسِي، وَمِنْ شَرِّ الشَّيْطَانِ وَشِرْكِهِ، وَأَنْ أَقْتَرِفَ عَلَى نَفْسِي سُوءاً، أَوْ أَجُرَّهُ إِلَى مُسْلِمٍ."
                },
                {
                    id: 10,
                    count: 3,
                    text: "بِسْمِ اللَّهِ الَّذِي لَا يَضُرُّ مَعَ اسْمِهِ شَيْءٌ فِي الْأَرْضِ وَلَا فِي السَّمَاءِ وَهُوَ السَّمِيعُ الْعَلِيمُ."
                },
                {
                    id: 11,
                    count: 3,
                    text: "رَضِيتُ بِاللَّهِ رَبًّا، وَبِالْإِسْلَامِ دِينًا، وَبِمُحَمَّدٍ ﷺ نَبِيًّا.",
                    note: "حق على الله أن يرضيه يوم القيامة"
                },
                {
                    id: 12,
                    count: 1,
                    text: "يَا حَيُّ يَا قَيُّومُ بِرَحْمَتِكَ أَسْتَغِيثُ أَصْلِحْ لِي شَأْنِي كُلَّهُ وَلَا تَكِلْنِي إِلَى نَفْسِي طَرْفَةَ عَيْنٍ."
                },
                {
                    id: 13,
                    count: 3,
                    text: "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ: عَدَدَ خَلْقِهِ، وَرِضَا نَفْسِهِ، وَزِنَةَ عَرْشِهِ، وَمِدَادَ كَلِمَاتِهِ."
                },
                {
                    id: 14,
                    count: 3,
                    text: "اللَّهُمَّ عَافِنِي فِي بَدَنِي، اللَّهُمَّ عَافِنِي فِي سَمْعِي، اللَّهُمَّ عَافِنِي فِي بَصَرِي، لَا إِلَهَ إِلَّا أَنْتَ."
                },
                {
                    id: 15,
                    count: 3,
                    text: "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْكُفْرِ وَالْفَقْرِ، وَأَعُوذُ بِكَ مِنْ عَذَابِ الْقَبْرِ، لَا إِلَهَ إِلَّا أَنْتَ."
                },
                {
                    id: 16,
                    count: 7,
                    text: "حَسْبِيَ اللَّهُ لَا إِلَهَ إِلَّا هُوَ عَلَيْهِ تَوَكَّلْتُ وَهُوَ رَبُّ الْعَرْشِ الْعَظِيمِ.",
                    note: "كفاه الله ما أهمّه"
                },
                {
                    id: 17,
                    count: 1,
                    text: "اللَّهُمَّ مَا أَصْبَحَ بِي مِنْ نِعْمَةٍ أَوْ بِأَحَدٍ مِنْ خَلْقِكَ فَمِنْكَ وَحْدَكَ لَا شَرِيكَ لَكَ، فَلَكَ الْحَمْدُ وَلَكَ الشُّكْرُ.",
                    note: "أدى شكر يومه"
                },
                {
                    id: 18,
                    count: 1,
                    text: "أَصْبَحْنَا عَلَى فِطْرَةِ الْإِسْلَامِ، وَعَلَى كَلِمَةِ الْإِخْلَاصِ، وَعَلَى دِينِ نَبِيِّنَا مُحَمَّدٍ ﷺ، وَعَلَى مِلَّةِ أَبِينَا إِبْرَاهِيمَ حَنِيفًا مُسْلِمًا وَمَا كَانَ مِنَ الْمُشْرِكِينَ."
                },
                {
                    id: 19,
                    count: 100,
                    text: "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ.",
                    note: "حُطَّتْ خَطَايَاهُ"
                },
                {
                    id: 20,
                    count: 10,
                    text: "لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ."
                },
                {
                    id: 21,
                    count: 100,
                    text: "أَسْتَغْفِرُ اللَّهَ وَأَتُوبُ إِلَيْهِ."
                },
                {
                    id: 22,
                    count: 10,
                    text: "اللَّهُمَّ صَلِّ وَسَلِّمْ عَلَى نَبِيِّنَا مُحَمَّدٍ.",
                    note: "من صلى علي عشراً صلى الله عليه بها عشراً"
                },
                {
                    id: 23,
                    count: 1,
                    text: "اللَّهُمَّ إِنِّي أَسْأَلُكَ عِلْمًا نَافِعًا، وَرِزْقًا طَيِّبًا، وَعَمَلًا مُتَقَبَّلًا.",
                    note: "بعد الفجر"
                }
            ],






            evening: [
                {
                    id: 1,
                    count: 1,
                    text: "أَعُوذُ بِاللهِ مِنْ الشَّيْطَانِ الرَّجِيمِ: اللَّهُ لَا إِلَهَ إِلَّا هُوَ الْحَيُّ الْقَيُّومُ لَا تَأْخُذُهُ سِنَةٌ وَلَا نَوْمٌ لَهُ مَا فِي السَّمَاوَاتِ وَمَا فِي الْأَرْضِ مَنْ ذَا الَّذِي يَشْفَعُ عِنْدَهُ إِلَّا بِإِذْنِهِ يَعْلَمُ مَا بَيْنَ أَيْدِيهِمْ وَمَا خَلْفَهُمْ وَلَا يُحِيطُونَ بِشَيْءٍ مِنْ عِلْمِهِ إِلَّا بِمَا شَاءَ وَسِعَ كُرْسِيُّهُ السَّمَاوَاتِ وَالْأَرْضَ وَلَا يَئُودُهُ حِفْظُهُمَا وَهُوَ الْعَلِيُّ الْعَظِيمُ.",
                    note: "أجير من الجن حتى يمسي"
                },
                {
                    id: 2,
                    count: 3,
                    text: "بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ: قُلْ هُوَ ٱللَّهُ أَحَدٌ، ٱللَّهُ ٱلصَّمَدُ، لَمْ يَلِدْ وَلَمْ يُولَدْ، وَلَمْ يَكُن لَّهُ كُفُوًا أَحَدٌ.",
                    note: "تكفيك من كل شيء"
                },
                {
                    id: 3,
                    count: 3,
                    text: "بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ: قُلْ أَعُوذُ بِرَبِّ الْفَلَقِ، مِن شَرِّ مَا خَلَقَ، وَمِن شَرِّ غَاسِقٍ إِذَا وَقَبَ، وَمِن شَرِّ النَّفَّاثَاتِ فِي الْعُقَدِ، وَمِن شَرِّ حَاسِدٍ إِذَا حَسَدَ."
                },
                {
                    id: 4,
                    count: 3,
                    text: "بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ: قُلْ أَعُوذُ بِرَبِّ النَّاسِ، مَلِكِ النَّاسِ، إِلَٰهِ النَّاسِ، مِن شَرِّ الْوَسْوَاسِ الْخَنَّاسِ، الَّذِي يُوَسْوِسُ فِي صُدُورِ النَّاسِ، مِنَ الْجِنَّةِ وَالنَّاسِ."
                },
                {
                    id: 5,
                    count: 1,
                    text: "أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ، رَبِّ أَسْأَلُكَ خَيْرَ مَا فِي هَذِهِ اللَّيْلَةِ وَخَيْرَ مَا بَعْدَهَا، وَأَعُوذُ بِكَ مِنْ شَرِّ مَا فِي هَذِهِ اللَّيْلَةِ وَشَرِّ مَا بَعْدَهَا، رَبِّ أَعُوذُ بِكَ مِنَ الْكَسَلِ وَسُوءِ الْكِبَرِ، رَبِّ أَعُوذُ بِكَ مِنْ عَذَابٍ فِي النَّارِ وَعَذَابٍ فِي الْقَبْرِ."
                },
                {
                    id: 6,
                    count: 1,
                    text: "اللَّهُمَّ بِكَ أَمْسَيْنَا، وَبِكَ أَصْبَحْنَا، وَبِكَ نَحْيَا، وَبِكَ نَمُوتُ، وَإِلَيْكَ الْمَصِيرُ."
                },
                {
                    id: 7,
                    count: 1,
                    text: "اللَّهُمَّ أَنْتَ رَبِّي لَا إِلَهَ إِلَّا أَنْتَ، خَلَقْتَنِي وَأَنَا عَبْدُكَ، وَأَنَا عَلَى عَهْدِكَ وَوَعْدِكَ مَا اسْتَطَعْتُ، أَعُوذُ بِكَ مِنْ شَرِّ مَا صَنَعْتُ، أَبُوءُ لَكَ بِنِعْمَتِكَ عَلَيَّ، وَأَبُوءُ لَكَ بِذَنْبِي فَاغْفِرْ لِي، فَإِنَّهُ لَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ.",
                    note: "سيد الاستغفار – من قالها ومات من ليلته دخل الجنة"
                },
                {
                    id: 8,
                    count: 1,
                    text: "اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَافِيَةَ فِي الدُّنْيَا وَالْآخِرَةِ، اللَّهُمَّ إِنِّي أَسْأَلُكَ الْعَفْوَ وَالْعَافِيَةَ فِي دِينِي وَدُنْيَايَ وَأَهْلِي وَمَالِي، اللَّهُمَّ اسْتُرْ عَوْرَاتِي وَآمِنْ رَوْعَاتِي، اللَّهُمَّ احْفَظْنِي مِنْ بَيْنِ يَدَيَّ وَمِنْ خَلْفِي وَعَنْ يَمِينِي وَعَنْ شِمَالِي وَمِنْ فَوْقِي، وَأَعُوذُ بِعَظَمَتِكَ أَنْ أُغْتَالَ مِنْ تَحْتِي."
                },
                {
                    id: 9,
                    count: 1,
                    text: "اللَّهُمَّ عَالِمَ الْغَيْبِ وَالشَّهَادَةِ، فَاطِرَ السَّمَاوَاتِ وَالْأَرْضِ، رَبَّ كُلِّ شَيْءٍ وَمَلِيكَهُ، أَشْهَدُ أَنْ لَا إِلَهَ إِلَّا أَنْتَ، أَعُوذُ بِكَ مِنْ شَرِّ نَفْسِي، وَمِنْ شَرِّ الشَّيْطَانِ وَشِرْكِهِ، وَأَنْ أَقْتَرِفَ عَلَى نَفْسِي سُوءًا، أَوْ أَجُرَّهُ إِلَى مُسْلِمٍ."
                },
                {
                    id: 10,
                    count: 3,
                    text: "بِسْمِ اللَّهِ الَّذِي لَا يَضُرُّ مَعَ اسْمِهِ شَيْءٌ فِي الْأَرْضِ وَلَا فِي السَّمَاءِ، وَهُوَ السَّمِيعُ الْعَلِيمُ."
                },
                {
                    id: 11,
                    count: 3,
                    text: "أَعُوذُ بِكَلِمَاتِ اللَّهِ التَّامَّاتِ مِنْ شَرِّ مَا خَلَقَ.",
                    note: "لم تضره حُمّى تلك الليلة"
                },
                {
                    id: 12,
                    count: 3,
                    text: "رَضِيتُ بِاللَّهِ رَبًّا، وَبِالْإِسْلَامِ دِينًا، وَبِمُحَمَّدٍ ﷺ نَبِيًّا."
                },
                {
                    id: 13,
                    count: 1,
                    text: "يَا حَيُّ يَا قَيُّومُ، بِرَحْمَتِكَ أَسْتَغِيثُ، أَصْلِحْ لِي شَأْنِي كُلَّهُ، وَلَا تَكِلْنِي إِلَى نَفْسِي طَرْفَةَ عَيْنٍ."
                },
                {
                    id: 14,
                    count: 3,
                    text: "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ، عَدَدَ خَلْقِهِ، وَرِضَا نَفْسِهِ، وَزِنَةَ عَرْشِهِ، وَمِدَادَ كَلِمَاتِهِ."
                },
                {
                    id: 15,
                    count: 3,
                    text: "اللَّهُمَّ عَافِنِي فِي بَدَنِي، اللَّهُمَّ عَافِنِي فِي سَمْعِي، اللَّهُمَّ عَافِنِي فِي بَصَرِي، لَا إِلَهَ إِلَّا أَنْتَ."
                },
                {
                    id: 16,
                    count: 3,
                    text: "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْكُفْرِ وَالْفَقْرِ، وَأَعُوذُ بِكَ مِنْ عَذَابِ الْقَبْرِ، لَا إِلَهَ إِلَّا أَنْتَ."
                },
                {
                    id: 17,
                    count: 7,
                    text: "حَسْبِيَ اللَّهُ لَا إِلَهَ إِلَّا هُوَ، عَلَيْهِ تَوَكَّلْتُ، وَهُوَ رَبُّ الْعَرْشِ الْعَظِيمِ.",
                    note: "كفاه الله ما أهمّه"
                },
                {
                    id: 18,
                    count: 1,
                    text: "اللَّهُمَّ مَا أَمْسَى بِي مِنْ نِعْمَةٍ، أَوْ بِأَحَدٍ مِنْ خَلْقِكَ، فَمِنْكَ وَحْدَكَ لَا شَرِيكَ لَكَ، فَلَكَ الْحَمْدُ وَلَكَ الشُّكْرُ.",
                    note: "أدّى شكر ليلته"
                },
                {
                    id: 19,
                    count: 1,
                    text: "أَمْسَيْنَا عَلَى فِطْرَةِ الْإِسْلَامِ، وَعَلَى كَلِمَةِ الْإِخْلَاصِ، وَعَلَى دِينِ نَبِيِّنَا مُحَمَّدٍ ﷺ، وَعَلَى مِلَّةِ أَبِينَا إِبْرَاهِيمَ، حَنِيفًا مُسْلِمًا، وَمَا كَانَ مِنَ الْمُشْرِكِينَ."
                },
                { id: 20, count: 100, text: "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ." },
                {
                    id: 21,
                    count: 100,
                    text: "لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ، وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ."
                },
                { id: 22, count: 100, text: "أَسْتَغْفِرُ اللَّهَ وَأَتُوبُ إِلَيْهِ." },
                {
                    id: 23,
                    count: 10,
                    text: "اللَّهُمَّ صَلِّ وَسَلِّمْ عَلَى نَبِيِّنَا مُحَمَّدٍ ﷺ."
                },
                {
                    "id": 24,
                    "count": 1,
                    "text": "بِسْمِكَ اللَّهُمَّ أَمُوتُ وَأَحْيَا.",
                    "note": "ذكر ثابت عن النبي ﷺ عند النوم",
                },
                {
                    "id": 25,
                    "count": 1,
                    "text": "اللَّهُمَّ قِنِي عَذَابَكَ يَوْمَ تَبْعَثُ عِبَادَكَ.",
                    "note": "دعاء مأثور عند النوم",
                },
                {
                    "id": 26,
                    "count": 1,
                    "text": "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنْ جَهْدِ الْبَلَاءِ، وَدَرَكِ الشَّقَاءِ، وَسُوءِ الْقَضَاءِ، وَشَمَاتَةِ الْأَعْدَاءِ.",
                    "note": "دعاء للحماية",
                }

            ],





            general: [
                { id: 1, count: 100, text: "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ.", note: "حُطَّتْ خَطَايَاهُ" },
                { id: 2, count: 1, text: "سُبْحَانَ اللَّهِ الْعَظِيمِ وَبِحَمْدِهِ.", note: "نخلة في الجنة" },
                { id: 3, count: 100, text: "سُبْحَانَ اللَّهِ وَبِحَمْدِهِ، سُبْحَانَ اللَّهِ الْعَظِيمِ.", note: "كلمتان خفيفتان ثقيلتان" },
                { id: 4, count: 100, text: "لَا حَوْلَ وَلَا قُوَّةَ إِلَّا بِاللَّهِ.", note: "كنز من كنوز الجنة" },
                { id: 5, count: 100, text: "سُبْحَانَ اللَّهِ، وَالْحَمْدُ لِلَّهِ، وَلَا إِلَهَ إِلَّا اللَّهُ، وَاللَّهُ أَكْبَرُ." },
                { id: 6, count: 100, text: "لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ." },
                { id: 7, count: 1, text: "سُبْحَانَ اللهِ، وَالْحَمْدُ للهِ، وَلَا إِلَهَ إِلَّا اللهُ، وَاللهُ أَكْبَرُ، وَلَا حَوْلَ وَلَا قُوَّةَ إِلَّا بِاللهِ." },
                { id: 8, count: 100, text: "أَسْتَغْفِرُ اللَّهَ وَأَتُوبُ إِلَيْهِ." },
                { id: 9, count: 100, text: "رَبِّ اغْفِرْ لِي وَتُبْ عَلَيَّ إِنَّكَ أَنْتَ التَّوَّابُ الرَّحِيمُ." },
                { id: 10, count: 10, text: "اللَّهُمَّ صَلِّ وَسَلِّمْ عَلَى نَبِيِّنَا مُحَمَّدٍ." },
                { id: 11, count: 3, text: "أَسْتَغْفِرُ اللهَ الْعَظِيمَ الَّذِي لَا إِلَهَ إِلَّا هُوَ الْحَيَّ الْقَيُّومُ وَأَتُوبُ إِلَيْهِ.", note: "من قالها غُفر له" },
                { id: 12, count: 1, text: "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْهَمِّ وَالْحَزَنِ، وَالْعَجْزِ وَالْكَسَلِ، وَالْبُخْلِ وَالْجُبْنِ، وَضَلَعِ الدَّيْنِ وَغَلَبَةِ الرِّجَالِ." },
                { id: 13, count: 1, text: "اللَّهُمَّ آتِ نَفْسِي تَقْوَاهَا، وَزَكِّهَا أَنْتَ خَيْرُ مَنْ زَكَّاهَا، أَنْتَ وَلِيُّهَا وَمَوْلَاهَا." },
                { id: 14, count: 1, text: "اللَّهُمَّ إِنِّي أَسْأَلُكَ الْهُدَى، وَالتُّقَى، وَالْعَفَافَ، وَالْغِنَى." },
                { id: 15, count: 1, text: "اللَّهُمَّ اهْدِنِي وَسَدِّدْنِي." },
                { id: 16, count: 1, text: "يَا مُقَلِّبَ الْقُلُوبِ ثَبِّتْ قَلْبِي عَلَى دِينِكَ." },
                { id: 17, count: 1, text: "اللَّهُمَّ مُصَرِّفَ الْقُلُوبِ صَرِّفْ قُلُوبَنَا عَلَى طَاعَتِكَ." },
                { id: 18, count: 1, text: "اللَّهُمَّ إِنِّي أَسْأَلُكَ مِنَ الْخَيْرِ كُلِّهِ عَاجِلِهِ وَآجِلِهِ، مَا عَلِمْتُ مِنْهُ وَمَا لَمْ أَعْلَمْ، وَأَعُوذُ بِكَ مِنَ الشَّرِّ كُلِّهِ مَا عَلِمْتُ مِنْهُ وَمَا لَمْ أَعْلَمْ. (دعاءٌ شاملٌ يُشبه ما رُوي عن بعض الأدعية التي تُعطى جامعاً للخير والوقاية من الشرور)", note: "دعاء عام" },
                { id: 19, count: 1, text: "اللَّهُمَّ إِنِّي أَسْأَلُكَ مِنْ خَيْرِ مَا سَأَلَكَ عَبْدُكَ وَنَبِيُّكَ، وَأَعُوذُ بِكَ مِنْ شَرِّ مَا عَاذَ بِهِ عَبْدُكَ وَنَبِيُّكَ." },
                { id: 20, count: 1, text: "اللَّهُمَّ أَصْلِحْ لِي دِينِي الَّذِي هُوَ عِصْمَةُ أَمْرِي، وَأَصْلِحْ لِي دُنْيَايَ الَّتِي فِيهَا مَعَاشِي، وَأَصْلِحْ لِي آخِرَتِي الَّتِي فِيهَا مَعَادِي، وَاجْعَلِ الْحَيَاةَ زِيَادَةً لِي فِي كُلِّ خَيْرٍ، وَاجْعَلِ الْمَوْتَ رَاحَةً لِي مِنْ كُلِّ شَرٍّ." },
                { id: 21, count: 1, text: "اللَّهُمَّ إِنِّي ظَلَمْتُ نَفْسِي ظُلْمًا كَثِيرًا، وَلَا يَغْفِرُ الذُّنُوبَ إِلَّا أَنْتَ، فَاغْفِرْ لِي مَغْفِرَةً مِنْ عِنْدِكَ وَارْحَمْنِي إِنَّكَ أَنْتَ الْغَفُورُ الرَّحِيمُ." },
                { id: 22, count: 1, text: "اللَّهُمَّ اغْفِرْ لِي خَطِيئَتِي وَجَهْلِي، وَإِسْرَافِي فِي أَمْرِي، وَمَا أَنْتَ أَعْلَمُ بِهِ مِنِّي." },
                { id: 23, count: 1, text: "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنْ مُنْكَرَاتِ الْأَخْلَاقِ، وَالْأَعْمَالِ، وَالْأَهْوَاءِ." },
                { id: 24, count: 1, text: "اللَّهُمَّ انْفَعْنِي بِمَا عَلَّمْتَنِي، وَعَلِّمْنِي مَا يَنْفَعُنِي، وَزِدْنِي عِلْمًا." },
                { id: 25, count: 1, text: "رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الْآخِرَةِ حَسَنَةً وَقِنَا عَذَابَ النَّارِ." },
                { id: 26, count: 1, text: "رَبَّنَا لَا تُزِغْ قُلُوبَنَا بَعْدَ إِذْ هَدَيْتَنَا وَهَبْ لَنَا مِنْ لَدُنْكَ رَحْمَةً إِنَّكَ أَنْتَ الْوَهَّابُ." },
                { id: 27, count: 1, text: "رَبَّنَا هَبْ لَنَا مِنْ أَزْوَاجِنَا وَذُرِّيَّاتِنَا قُرَّةَ أَعْيُنٍ وَاجْعَلْنَا لِلْمُتَّقِينَ إِمَامًا." },
                { id: 28, count: 1, text: "رَبِّ اشْرَحْ لِي صَدْرِي وَيَسِّرْ لِي أَمْرِي." },
                { id: 29, count: 1, text: "لَا إِلَهَ إِلَّا أَنْتَ سُبْحَانَكَ إِنِّي كُنْتُ مِنَ الظَّالِمِينَ.", note: "دعاء الكرب" },
                { id: 30, count: 1, text: "رَبِّ اجْعَلْنِي مُقِيمَ الصَّلَاةِ وَمِنْ ذُرِّيَّتِي رَبَّنَا وَتَقَبَّلْ دُعَاءِ." },
                { id: 31, count: 1, text: "رَبِّ اغْفِرْ لِي وَلِوَالِدَيَّ وَلِلْمُؤْمِنِينَ يَوْمَ يَقُومُ الْحِسَابُ." },
                { id: 32, count: 1, text: "اللَّهُمَّ اكْفِنِي بِحَلَالِكَ عَنْ حَرَامِكَ، وَأَغْنِنِي بِفَضْلِكَ عَمَّنْ سِوَاكَ.", note: "لقضاء الدين" },
                { id: 33, count: 1, text: "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنْ زَوَالِ نِعْمَتِكَ، وَتَحَوُّلِ عَافِيَتِكَ، وَفُجَاءَةِ نِقْمَتِكَ، وَجَمِيعِ سَخَطِكَ." },
                { id: 34, count: 1, text: "اللَّهُمَّ رَحْمَتَكَ أَرْجُو فَلَا تَكِلْنِي إِلَى نَفْسِي طَرْفَةَ عَيْنٍ، وَأَصْلِحْ لِي شَأْنِي كُلَّهُ لَا إِلَهَ إِلَّا أَنْتَ." },
                { id: 35, count: 1, text: "اللَّهُمَّ أَعِنِّي عَلَى ذِكْرِكَ، وَشُكْرِكَ، وَحُسْنِ عِبَادَتِكَ." },
                { id: 36, count: 1, text: "اللَّهُمَّ إِنِّي أَعُوذُ بِكَ مِنَ الْبَرَصِ، وَالْجُنُونِ، وَالْجُذَامِ، وَمِنْ سَيِّئِ الأَسْقَامِ." }
            ]
        };


        let currentAzkarMode = 'morning';
        let azkarProgress = {};

        function switchAzkarTab(mode) {
            currentAzkarMode = mode;

            document.querySelectorAll('.azkar-theme-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });

            const tabBtn = document.getElementById(`tab-${mode}`);
            if (tabBtn) {
                tabBtn.classList.add('active');
                tabBtn.setAttribute('aria-selected', 'true');
            }

            renderAzkarList();
        }

        function renderAzkarList() {
            const list = document.getElementById('azkar-list');
            list.innerHTML = '';

            const items = azkarDB[currentAzkarMode];

            items.forEach((zikr, index) => {
                const currentCount = azkarProgress[zikr.id] !== undefined ? azkarProgress[zikr.id] : zikr.count;
                const isDone = currentCount === 0;
                const percent = ((zikr.count - currentCount) / zikr.count) * 100;

                const card = document.createElement('div');
                card.className = `zikr-card stagger-entry p-5 flex flex-col gap-4 cursor-pointer select-none ${isDone ? 'completed' : ''}`;
                card.style.animationDelay = `${index * 0.05}s`;
                card.setAttribute('role', 'button');
                card.setAttribute('aria-label', `Zikr: ${zikr.text.substring(0, 50)}...`);

                if (!isDone) {
                    card.onclick = () => handleZikrClick(zikr.id, zikr.count);
                }

                card.innerHTML = `
                <div class="flex justify-between items-start z-10 relative">
                    <div class="uthmani-font text-right flex-1 ml-4">
                        ${zikr.text}
                        ${zikr.note ? `<span class="text-sm block mt-2 opacity-80" style="font-family: 'Cairo', sans-serif; color: var(--azkar-gold);">${zikr.note}</span>` : ''}
                    </div>
                    
                    <div class="relative w-16 h-16 flex-shrink-0 flex items-center justify-center mt-1">
                        <svg class="w-full h-full transform -rotate-90" aria-hidden="true">
                            <circle cx="32" cy="32" r="26" stroke="rgba(255,255,255,0.1)" stroke-width="4" fill="none"></circle>
                            <circle cx="32" cy="32" r="26" stroke="${isDone ? '#10b981' : 'var(--azkar-gold)'}" stroke-width="4" fill="none" 
                                    stroke-dasharray="163" stroke-dashoffset="${163 - (163 * percent / 100)}" 
                                    class="zikr-counter-ring"></circle>
                        </svg>
                        ${isDone
                        ? `<button onclick="resetZikr(${zikr.id}, ${zikr.count}, event)" 
                                       class="absolute inset-0 flex items-center justify-center text-[#10b981] hover:bg-white/10 rounded-full transition"
                                       aria-label="Reset zikr counter">
                                   <i class="fas fa-undo" aria-hidden="true"></i>
                               </button>`
                        : `<span class="absolute text-xl font-bold text-white font-mono" aria-live="polite">${currentCount}</span>`
                    }
                    </div>
                </div>
                ${!isDone ? `<div class="text-xs text-slate-400 text-center mt-[-5px] opacity-50 font-['Cairo']">اضغط للعد</div>` : ''}
            `;

                list.appendChild(card);
            });
        }

        function handleZikrClick(id, max) {
            if (azkarProgress[id] === undefined) azkarProgress[id] = max;

            if (azkarProgress[id] > 0) {
                azkarProgress[id]--;

                if (navigator.vibrate) navigator.vibrate(40);
                renderAzkarList();

                if (azkarProgress[id] === 0 && navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                    triggerConfetti(false);
                }
            }
        }

        function resetZikr(id, max, event) {
            event.stopPropagation();
            azkarProgress[id] = max;
            renderAzkarList();
        }

        window.switchAzkarTab = switchAzkarTab;
        window.handleZikrClick = handleZikrClick;
        window.resetZikr = resetZikr;
        // ==========================================
        //  دالة تنزيل الرسم كصورة (PNG Download)
        // ==========================================
        window.downloadCanvasAsPNG = function () {
            if (!fCanvas) return;
            fCanvas.discardActiveObject();
            fCanvas.renderAll();
            const dataURL = fCanvas.toDataURL({ format: 'png', quality: 1, multiplier: 2 });
            const link = document.createElement('a');
            link.download = 'how-much-drawing-' + Date.now() + '.png';
            link.href = dataURL;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // ==========================================
        // DUAL STORAGE DRAWING LOGIC (Fixed)
        // ==========================================

        window.openDrawingCanvas = function () {
            const modal = document.getElementById('drawing-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            setTimeout(() => {
                initFabric();
                resizeFabric();

                window.toggleDrawMode(true);

                // Priority: Try loading JSON (Editable). Fallback: Load Image (Background).
                if (window.tempDrawingJSON) {
                    fCanvas.clear();
                    fCanvas.loadFromJSON(window.tempDrawingJSON, function () {
                        fCanvas.renderAll();
                    });
                } else if (window.tempDrawingData) {
                    fCanvas.clear();
                    fabric.Image.fromURL(window.tempDrawingData, function (img) {
                        fCanvas.setBackgroundImage(img, fCanvas.renderAll.bind(fCanvas), {
                            scaleX: fCanvas.width / img.width,
                            scaleY: fCanvas.height / img.height
                        });
                    });
                } else {
                    fCanvas.clear();
                }
            }, 150);
        };

        window.saveCanvasDrawing = async function (btnElement) {
            if (!fCanvas) return;
            if (btnElement) btnElement.classList.add('loading');

            // 1. Save JSON (The editable strokes)
            window.tempDrawingJSON = JSON.stringify(fCanvas.toJSON());

            // 2. Save Image (The visible preview)
            window.tempDrawingData = fCanvas.toDataURL({ format: 'png', quality: 1, multiplier: 2 });

            const previewContainer = document.getElementById('modal-drawing-preview');
            const previewImg = document.getElementById('modal-drawing-img');
            const btnLabel = document.getElementById('btn-draw-label');

            if (previewContainer && previewImg) {
                previewContainer.classList.remove('hidden');
                previewImg.src = window.tempDrawingData;
                if (btnLabel) btnLabel.innerText = "Edit Drawing";
            }

            await new Promise(resolve => setTimeout(resolve, 500));

            if (btnElement) {
                btnElement.classList.remove('loading');
                btnElement.classList.add('success');
            }

            setTimeout(() => {
                window.closeDrawingModal();
                if (btnElement) btnElement.classList.remove('success');
            }, 500);
        };

        // FIX: Load data from LocalStorage on startup (Ensuring it runs)
        (function () {
            try {
                const localData = localStorage.getItem('hm_data');
                if (localData) {
                    const parsed = JSON.parse(localData);
                    if (parsed) {
                        window.appData = parsed;
                        if (!window.appData.notes) window.appData.notes = [];
                        if (window.refreshAllUI) window.refreshAllUI();
                    }
                }
            } catch (e) { console.error(e); }
        })();

        // ==========================================
//  دالة التحميل المباشر للملفات
// ==========================================
window.downloadFileDirect = async function(url, filename) {
    try {
        showToast("⏳ downloading", 'neutral');
        
        const response = await fetch(url);
        const blob = await response.blob();
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename || 'downloaded-file';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        URL.revokeObjectURL(link.href);
        showToast("✅ success", 'success');
        
    } catch (error) {
        console.error("Download error:", error);
        showToast("❌ failed", 'error');
    }
};
    </script>
</body>
</html>

